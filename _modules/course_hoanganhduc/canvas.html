<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>course_hoanganhduc.canvas &#8212; Course Management Toolkit 0.1.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=a58bc63e"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for course_hoanganhduc.canvas</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Canvas API: https://canvas.instructure.com/doc/api/</span>
<span class="c1"># Course Management Script</span>

<span class="sd">&quot;&quot;&quot;Canvas LMS helpers.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">readline</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c1"># Windows without pyreadline installed</span>
    <span class="n">readline</span> <span class="o">=</span> <span class="kc">None</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">openpyxl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytesseract</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pdf2image</span><span class="w"> </span><span class="kn">import</span> <span class="n">convert_from_path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">PyPDF2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">difflib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openpyxl.styles</span><span class="w"> </span><span class="kn">import</span> <span class="n">Alignment</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">unicodedata</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">paddleocr</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaddleOCR</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">canvasapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Canvas</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">date</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_extraction.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">TfidfVectorizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics.pairwise</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_similarity</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statistics</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">googleapiclient.discovery</span><span class="w"> </span><span class="kn">import</span> <span class="n">build</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.oauth2.credentials</span><span class="w"> </span><span class="kn">import</span> <span class="n">Credentials</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google_auth_oauthlib.flow</span><span class="w"> </span><span class="kn">import</span> <span class="n">InstalledAppFlow</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.auth.transport.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleNamespace</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>  <span class="c1"># &lt;-- Add tqdm for progress bars</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.settings</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.data</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_unfold_ics_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="n">unfolded</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">raw</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">unfolded</span><span class="p">:</span>
            <span class="n">unfolded</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">raw</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unfolded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unfolded</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_parse_ics_datetime</span><span class="p">(</span><span class="n">raw_value</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">raw_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot;T&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%SZ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dt</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dt</span><span class="p">,</span> <span class="kc">False</span>
    <span class="n">date_val</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">date_val</span><span class="p">,</span> <span class="kc">True</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_parse_ics_events</span><span class="p">(</span><span class="n">ics_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ics_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">_unfold_ics_lines</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read iCal file: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>

    <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;BEGIN:VEVENT&quot;</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;END:VEVENT&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current</span><span class="p">:</span>
                <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">current</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasCalendar] Parsed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="si">}</span><span class="s2"> event(s) from </span><span class="si">{</span><span class="n">ics_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">events</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_canvas_datetime_key</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;+00:00&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_calendar_event_key</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">start_at</span><span class="p">,</span> <span class="n">end_at</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">all_day</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">title</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
        <span class="n">_canvas_datetime_key</span><span class="p">(</span><span class="n">start_at</span><span class="p">),</span>
        <span class="n">_canvas_datetime_key</span><span class="p">(</span><span class="n">end_at</span><span class="p">),</span>
        <span class="p">(</span><span class="n">location</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
        <span class="nb">bool</span><span class="p">(</span><span class="n">all_day</span><span class="p">),</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_fetch_canvas_calendar_events</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">course_id</span><span class="p">,</span> <span class="n">start_at</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_at</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/calendar_events&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;context_codes[]&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;course_</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;per_page&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">start_at</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_at</span>
    <span class="k">if</span> <span class="n">end_at</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_at</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calendar_events&quot;</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;calendar_events&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">events</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Link&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;rel=&quot;next&quot;&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="n">next_url</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&lt;&gt;&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">next_url</span>
        <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasCalendar] Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="si">}</span><span class="s2"> existing event(s) from Canvas.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">events</span>


<div class="viewcode-block" id="import_canvas_calendar_from_ics">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.import_canvas_calendar_from_ics">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">import_canvas_calendar_from_ics</span><span class="p">(</span>
    <span class="n">ics_path</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">skip_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Import an iCal (.ics) file and create Canvas course calendar events.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_url</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">course_id</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Canvas API URL, API key, and course ID are required.&quot;</span><span class="p">)</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">_parse_ics_events</span><span class="p">(</span><span class="n">ics_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasCalendar] No events found in iCal file.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="n">created</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/calendar_events&quot;</span>
    <span class="n">context_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;course_</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">existing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">skip_duplicates</span><span class="p">:</span>
        <span class="n">starts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ends</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">start_raw</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DTSTART&quot;</span><span class="p">)</span>
            <span class="n">end_raw</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DTEND&quot;</span><span class="p">)</span>
            <span class="n">start_value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_parse_ics_datetime</span><span class="p">(</span><span class="n">start_raw</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">end_value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_parse_ics_datetime</span><span class="p">(</span><span class="n">end_raw</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_value</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
                <span class="n">starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_value</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
                <span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
        <span class="n">start_at</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span> <span class="k">if</span> <span class="n">starts</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">end_at</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ends</span><span class="p">)</span> <span class="k">if</span> <span class="n">ends</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">_fetch_canvas_calendar_events</span><span class="p">(</span>
            <span class="n">api_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="p">,</span>
            <span class="n">course_id</span><span class="p">,</span>
            <span class="n">start_at</span><span class="o">=</span><span class="n">start_at</span><span class="p">,</span>
            <span class="n">end_at</span><span class="o">=</span><span class="n">end_at</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">existing</span><span class="p">:</span>
            <span class="n">existing_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">_calendar_event_key</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_at&quot;</span><span class="p">),</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end_at&quot;</span><span class="p">),</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">),</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;all_day&quot;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
        <span class="n">start_raw</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DTSTART&quot;</span><span class="p">)</span>
        <span class="n">end_raw</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DTEND&quot;</span><span class="p">)</span>
        <span class="n">start_value</span><span class="p">,</span> <span class="n">start_all_day</span> <span class="o">=</span> <span class="n">_parse_ics_datetime</span><span class="p">(</span><span class="n">start_raw</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">end_value</span><span class="p">,</span> <span class="n">end_all_day</span> <span class="o">=</span> <span class="n">_parse_ics_datetime</span><span class="p">(</span><span class="n">end_raw</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasCalendar] Skipping event without DTSTART.&quot;</span><span class="p">)</span>
            <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">all_day</span> <span class="o">=</span> <span class="n">start_all_day</span> <span class="ow">or</span> <span class="n">end_all_day</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="n">start_dt</span> <span class="o">=</span> <span class="n">start_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">start_value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="n">end_dt</span> <span class="o">=</span> <span class="n">end_value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_value</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
            <span class="n">end_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">end_value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_dt</span> <span class="o">=</span> <span class="n">start_dt</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">event_key</span> <span class="o">=</span> <span class="n">_calendar_event_key</span><span class="p">(</span>
            <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SUMMARY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;Class session&quot;</span><span class="p">,</span>
            <span class="n">start_dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="n">end_dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LOCATION&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">all_day</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">skip_duplicates</span> <span class="ow">and</span> <span class="n">event_key</span> <span class="ow">in</span> <span class="n">existing_keys</span><span class="p">:</span>
            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasCalendar] Skipping duplicate: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SUMMARY&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;Class session&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;calendar_event&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;context_code&quot;</span><span class="p">:</span> <span class="n">context_code</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SUMMARY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;Class session&quot;</span><span class="p">,</span>
                <span class="s2">&quot;start_at&quot;</span><span class="p">:</span> <span class="n">start_dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;end_at&quot;</span><span class="p">:</span> <span class="n">end_dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;location_name&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LOCATION&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DESCRIPTION&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">all_day</span><span class="p">:</span>
            <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;calendar_event&quot;</span><span class="p">][</span><span class="s2">&quot;all_day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">created</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasCalendar] Dry run: </span><span class="si">{</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;calendar_event&#39;</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="n">created</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasCalendar] Created: </span><span class="si">{</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;calendar_event&#39;</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasCalendar] Failed to create event: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasCalendar] Created </span><span class="si">{</span><span class="n">created</span><span class="si">}</span><span class="s2"> event(s), skipped </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2">, failed </span><span class="si">{</span><span class="n">failed</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">created</span><span class="p">,</span> <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="n">skipped</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="n">failed</span><span class="p">}</span></div>


<div class="viewcode-block" id="send_final_evaluations_via_canvas">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.send_final_evaluations_via_canvas">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">send_final_evaluations_via_canvas</span><span class="p">(</span>
    <span class="n">final_dir</span><span class="o">=</span><span class="s2">&quot;final_evaluations&quot;</span><span class="p">,</span>
    <span class="n">db_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read each &quot;&lt;student id&gt;_&lt;student name&gt;_results.txt&quot; in final_dir and send its content</span>
<span class="sd">    to the corresponding student via Canvas conversation. Student&#39;s Canvas ID is looked up</span>
<span class="sd">    from the local database (db_path). Message is in Vietnamese and mentions it was sent</span>
<span class="sd">    automatically and to contact the lecturer ASAP if any problem arises.</span>

<span class="sd">    Enhancement: if the student&#39;s name is missing in the database, extract it from the</span>
<span class="sd">    text filename (the part between the first underscore after the 8-digit id and</span>
<span class="sd">    &quot;_results.txt&quot;), replacing underscores with spaces.</span>

<span class="sd">    dry_run: if True, do not send any messages and only report what would be sent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">db_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">db_path</span> <span class="o">=</span> <span class="n">get_default_db_path</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">final_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SendFinals] Folder not found: </span><span class="si">{</span><span class="n">final_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Folder not found: </span><span class="si">{</span><span class="n">final_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;sent&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="c1"># Load database</span>
    <span class="n">students</span> <span class="o">=</span> <span class="n">load_database</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">sid_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">students</span><span class="p">:</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Student ID&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sid</span><span class="p">:</span>
            <span class="n">sid_map</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">s</span>

    <span class="c1"># Prepare Canvas client</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SendFinals] Failed to initialize Canvas client: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to initialize Canvas client.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;sent&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dry_run_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Capture student id and name part from filename</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\d</span><span class="si">{8}</span><span class="s1">)_(.+?)_results\.txt$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">final_dir</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_results.txt&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SendFinals] Skipping file with unexpected name format: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping file: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="n">sid</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">raw_name_part</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Clean up extracted name: replace underscores and multiple separators with spaces</span>
        <span class="n">extracted_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[_\-\.\s]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">raw_name_part</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># Further sanitize: remove any trailing/leading non-letter characters</span>
        <span class="n">extracted_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[^A-Za-z0-9--]+|[^A-Za-z0-9--]+$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">extracted_name</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">student</span> <span class="o">=</span> <span class="n">sid_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">final_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SendFinals] Failed to read </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">student</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SendFinals] Student ID </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2"> not found in database. Skipping file: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Student ID </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2"> not found, skipped.&quot;</span><span class="p">)</span>
            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="c1"># New preference: prefer name extracted from filename; if it fails/empty, use database name</span>
        <span class="n">db_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">db_name</span> <span class="o">=</span> <span class="n">db_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">db_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">db_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">extracted_name</span><span class="p">:</span>
            <span class="n">student_name</span> <span class="o">=</span> <span class="n">extracted_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">student_name</span> <span class="o">=</span> <span class="n">db_name</span>

        <span class="c1"># As a last resort, if both are empty, derive a readable name from filename base (without id)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">student_name</span><span class="p">:</span>
            <span class="n">student_name</span> <span class="o">=</span> <span class="n">extracted_name</span> <span class="ow">or</span> <span class="n">db_name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>

        <span class="n">canvas_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">&quot;Canvas ID&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">student</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Canvas ID&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">canvas_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SendFinals] Canvas ID missing for student </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Canvas ID missing for </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">, skipped.&quot;</span><span class="p">)</span>
            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="c1"># Ensure recipient id is a string</span>
        <span class="n">recipient</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)</span>

        <span class="n">greeting</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cho </span><span class="si">{</span><span class="n">student_name</span><span class="si">}</span><span class="s2">,</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">student_name</span> <span class="k">else</span> <span class="s2">&quot;Cho bn,</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="n">sent_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M&quot;</span><span class="p">)</span>
        <span class="n">greeting</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;y l thng bo t ng gi kt qu nh gi hc phn cho sinh vin (MSSV: </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">).</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">greeting</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Thi im gi: </span><span class="si">{</span><span class="n">sent_time</span><span class="si">}</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">greeting</span> <span class="o">+=</span> <span class="s2">&quot;Vui lng kim tra k ni dung bn di. Nu c thc mc, sai st v thng tin hoc im s, bn hy phn hi trc tip cho ging vin cng sm cng tt.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">greeting</span> <span class="o">+=</span> <span class="s2">&quot;Chc bn mt hc k tt v kt qu hc tp tin b.</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">course_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">COURSE_CODE</span> <span class="ow">or</span> <span class="n">get_cached_course_code</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">course_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">COURSE_NAME</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">course_code</span><span class="p">:</span>
            <span class="n">course_code</span> <span class="o">=</span> <span class="n">course_code</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">course_name</span><span class="p">:</span>
            <span class="n">course_name</span> <span class="o">=</span> <span class="n">course_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="n">course_title</span> <span class="o">=</span> <span class="s2">&quot; - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">part</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="p">(</span><span class="n">course_code</span><span class="p">,</span> <span class="n">course_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">part</span><span class="p">)</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Thng bo kt qu nh gi hc phn&quot;</span>
        <span class="k">if</span> <span class="n">course_title</span><span class="p">:</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">course_title</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">body</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">greeting</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">dry_run_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SendFinals] Dry run: would send results to </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">recipient</span><span class="si">}</span><span class="s2">) from file </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">canvas</span><span class="o">.</span><span class="n">create_conversation</span><span class="p">(</span>
                <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="n">recipient</span><span class="p">],</span>
                <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                <span class="n">force_new</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">sent</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SendFinals] Sent results to </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">recipient</span><span class="si">}</span><span class="s2">) from file </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SendFinals] Failed to send to </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">recipient</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send to </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sent&quot;</span><span class="p">:</span> <span class="n">sent</span><span class="p">,</span> <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="n">skipped</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">errors</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;dry_run&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dry_run_count</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SendFinals] Completed. Sent: </span><span class="si">{</span><span class="n">sent</span><span class="si">}</span><span class="s2">, Skipped: </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2">, Errors: </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">, Dry-run: </span><span class="si">{</span><span class="n">dry_run_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SendFinals] Completed. Sent: </span><span class="si">{</span><span class="n">sent</span><span class="si">}</span><span class="s2">, Skipped: </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2">, Errors: </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done. Sent: </span><span class="si">{</span><span class="n">sent</span><span class="si">}</span><span class="s2">, Skipped: </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2">, Errors: </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">, Dry-run: </span><span class="si">{</span><span class="n">dry_run_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done. Sent: </span><span class="si">{</span><span class="n">sent</span><span class="si">}</span><span class="s2">, Skipped: </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2">, Errors: </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">summary</span></div>


<div class="viewcode-block" id="sync_students_with_canvas">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.sync_students_with_canvas">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sync_students_with_canvas</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="n">db_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">course_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sync students in the local database with active students from Canvas course.</span>
<span class="sd">    Adds new students from Canvas if not present, updates Canvas ID for existing students,</span>
<span class="sd">    and syncs scores of both total course grade and each assignment category.</span>

<span class="sd">    Args:</span>
<span class="sd">        students: List of Student objects</span>
<span class="sd">        db_path: Path to save the database</span>
<span class="sd">        course_id: Canvas course ID (uses default if None)</span>
<span class="sd">        api_url: Canvas API URL</span>
<span class="sd">        api_key: Canvas API key</span>
<span class="sd">        verbose: If True, print more details; otherwise, print only important notice</span>

<span class="sd">    Returns:</span>
<span class="sd">        (added_count, updated_count): Counts of students added and updated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_scale_score_to_ten</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">max_points</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">score_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">score</span>
            <span class="k">if</span> <span class="n">max_points</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">max_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_points</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">max_val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">score_val</span> <span class="o">/</span> <span class="n">max_val</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="n">score_val</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">score_val</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">score_val</span>

        <span class="k">if</span> <span class="n">course_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">course_id</span> <span class="o">=</span> <span class="n">CANVAS_LMS_COURSE_ID</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SyncCanvas] Fetching students from Canvas course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Syncing students with Canvas course...&quot;</span><span class="p">)</span>
        <span class="n">people</span> <span class="o">=</span> <span class="n">list_canvas_people</span><span class="p">(</span><span class="n">api_url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span>
        <span class="n">canvas_students</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active_students&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">canvas_students</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SyncCanvas] No active students found in Canvas course.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No active students found in Canvas course.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SyncCanvas] Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">canvas_students</span><span class="p">)</span><span class="si">}</span><span class="s2"> active students in Canvas course.&quot;</span><span class="p">)</span>

        <span class="c1"># Helper to normalize names for comparison</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">normalize_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9 ]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Build lookups for matching Canvas records to local students.</span>
        <span class="n">existing_by_email</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">existing_by_name</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">existing_by_canvas_id</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SyncCanvas] Building lookup tables for existing students...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">students</span><span class="p">:</span>
            <span class="n">email</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">canvas_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Canvas ID&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">email</span><span class="p">:</span>
                <span class="n">existing_by_email</span><span class="p">[</span><span class="n">email</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">s</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">norm_name</span> <span class="o">=</span> <span class="n">normalize_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">norm_name</span><span class="p">:</span>
                    <span class="n">existing_by_name</span><span class="p">[</span><span class="n">norm_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
            <span class="k">if</span> <span class="n">canvas_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing_by_canvas_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">s</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">pass</span>

        <span class="c1"># Resolve duplicates by priority (Canvas ID &gt; name &gt; email). If multiple candidates</span>
        <span class="c1"># exist, prompt the operator to pick, create a new student, or skip.</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_canvas_match</span><span class="p">(</span><span class="n">canvas_id_value</span><span class="p">,</span> <span class="n">name_key</span><span class="p">,</span> <span class="n">email_key</span><span class="p">):</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">add_candidate</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">student</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">student</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="n">student</span><span class="p">))</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">student</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">canvas_id_value</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">canvas_id_value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">existing_by_canvas_id</span><span class="p">:</span>
                        <span class="n">add_candidate</span><span class="p">(</span><span class="s2">&quot;canvas_id&quot;</span><span class="p">,</span> <span class="n">existing_by_canvas_id</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="n">name_key</span> <span class="ow">and</span> <span class="n">name_key</span> <span class="ow">in</span> <span class="n">existing_by_name</span><span class="p">:</span>
                <span class="n">add_candidate</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">existing_by_name</span><span class="p">[</span><span class="n">name_key</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">email_key</span> <span class="ow">and</span> <span class="n">email_key</span> <span class="ow">in</span> <span class="n">existing_by_email</span><span class="p">:</span>
                <span class="n">add_candidate</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="n">existing_by_email</span><span class="p">[</span><span class="n">email_key</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[SyncCanvas] Possible duplicate match detected:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">student</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">s_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                <span class="n">s_email</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                <span class="n">s_cid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">&quot;Canvas ID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">s_name</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">s_email</span><span class="si">}</span><span class="s2"> | Canvas ID: </span><span class="si">{</span><span class="n">s_cid</span><span class="si">}</span><span class="s2"> (matched by </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;n. Create new student&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;s. Skip this record&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Choose a match (number), &#39;n&#39; for new, or &#39;s&#39; to skip: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;__skip__&quot;</span>
                <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">sel</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">candidates</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">added_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">updated_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Prepare Canvas API for grades and scores</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SyncCanvas] Connecting to Canvas API...&quot;</span><span class="p">)</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>

        <span class="c1"># Fetch enrollments to get total grades</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SyncCanvas] Fetching enrollments for total grades...&quot;</span><span class="p">)</span>
        <span class="n">enrollments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_enrollments</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;StudentEnrollment&#39;</span><span class="p">]))</span>

        <span class="c1"># Build a map: canvas_id -&gt; total_grade info.</span>
        <span class="n">total_grades_by_canvas_id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">enrollment</span> <span class="ow">in</span> <span class="n">enrollments</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">enrollment</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">enrollment</span><span class="p">,</span> <span class="s2">&quot;grades&quot;</span><span class="p">):</span>
                <span class="n">grades</span> <span class="o">=</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">grades</span>
                <span class="n">total_grades_by_canvas_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;final_score&quot;</span><span class="p">:</span> <span class="n">grades</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;final_score&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;final_grade&quot;</span><span class="p">:</span> <span class="n">grades</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;final_grade&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;current_score&quot;</span><span class="p">:</span> <span class="n">grades</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_score&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;current_grade&quot;</span><span class="p">:</span> <span class="n">grades</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_grade&quot;</span><span class="p">)</span>
                <span class="p">}</span>

        <span class="c1"># Fetch assignment groups for category scores</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SyncCanvas] Fetching assignment groups and scores...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
            <span class="n">group_scores_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/students/submissions?student_ids[]=all&amp;include[]=assignment&amp;include[]=user&amp;include[]=score&amp;grouped=true&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group_scores_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">category_scores_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SyncCanvas] Warning: Could not fetch detailed category scores: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Could not fetch detailed category scores.&quot;</span><span class="p">)</span>
            <span class="n">category_scores_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">assignment_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">,</span> <span class="s1">&#39;score_statistics&#39;</span><span class="p">]))</span>

        <span class="c1"># Build a map: canvas_id -&gt; {group_name: {current_score, current_possible, final_score, final_possible}}.</span>
        <span class="n">group_scores_by_canvas_id</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># First, process score_statistics (current scores)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">assignment_groups</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
            <span class="n">group_id</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">id</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s2">&quot;score_statistics&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">canvas_id_str</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">canvas_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">canvas_id_str</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_scores_by_canvas_id</span><span class="p">:</span>
                    <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">group_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">]:</span>
                    <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">][</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;current_score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;current_possible&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;final_score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;final_possible&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;group_id&#39;</span><span class="p">:</span> <span class="n">group_id</span>
                    <span class="p">}</span>

                <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">][</span><span class="n">group_name</span><span class="p">][</span><span class="s1">&#39;current_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">][</span><span class="n">group_name</span><span class="p">][</span><span class="s1">&#39;current_possible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;possible&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">][</span><span class="n">group_name</span><span class="p">][</span><span class="s1">&#39;final_score&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">][</span><span class="n">group_name</span><span class="p">][</span><span class="s1">&#39;final_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">][</span><span class="n">group_name</span><span class="p">][</span><span class="s1">&#39;final_possible&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">][</span><span class="n">group_name</span><span class="p">][</span><span class="s1">&#39;final_possible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;possible&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Then process submissions data to get final scores aggregated per assignment group.</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SyncCanvas] Processing category final scores...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">assignments_by_group</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">assignment_groups</span><span class="p">:</span>
                <span class="n">assignments_by_group</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s2">&quot;assignments&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;published&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="n">assignments_by_group</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">user_data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">category_scores_data</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing category final scores&quot;</span><span class="p">):</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_scores_by_canvas_id</span><span class="p">:</span>
                    <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">for</span> <span class="n">submission</span> <span class="ow">in</span> <span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submissions&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">assignment</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">assignment</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">group_id</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment_group_id&quot;</span><span class="p">)</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">assignment_groups</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">group_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">group_name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">group_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">]:</span>
                        <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;current_score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s1">&#39;current_possible&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s1">&#39;final_score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s1">&#39;final_possible&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s1">&#39;group_id&#39;</span><span class="p">:</span> <span class="n">group_id</span>
                        <span class="p">}</span>

                    <span class="n">score</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
                    <span class="n">points_possible</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points_possible&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>

                    <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">group_name</span><span class="p">][</span><span class="s1">&#39;final_score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">score</span>
                    <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">group_name</span><span class="p">][</span><span class="s1">&#39;final_possible&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">points_possible</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SyncCanvas] Warning: Error processing category final scores: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Error processing category final scores.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SyncCanvas] Fetching individual assignments...&quot;</span><span class="p">)</span>
        <span class="n">important_assignments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">assignment_groups</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s2">&quot;assignments&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;published&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="n">important_assignments</span><span class="p">[</span><span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                            <span class="s2">&quot;points_possible&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;points_possible&#39;</span><span class="p">],</span>
                            <span class="s2">&quot;group_name&quot;</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
                        <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SyncCanvas] Warning: Could not fetch assignments: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Could not fetch assignments.&quot;</span><span class="p">)</span>

        <span class="n">assignment_scores_by_canvas_id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">assignment_comments_by_canvas_id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">assignment_rubrics_by_canvas_id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">important_assignments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SyncCanvas] Fetching submissions for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">important_assignments</span><span class="p">)</span><span class="si">}</span><span class="s2"> assignments...&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">assignment_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">important_assignments</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>
                    <span class="n">assignment_info</span> <span class="o">=</span> <span class="n">important_assignments</span><span class="p">[</span><span class="n">assignment_id</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">submission</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">get_submissions</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;submission_comments&quot;</span><span class="p">,</span> <span class="s2">&quot;rubric_assessment&quot;</span><span class="p">]),</span>
                                         <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">assignment_info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> submissions&quot;</span><span class="p">):</span>
                        <span class="n">user_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">submission</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">submission</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="n">score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assignment_scores_by_canvas_id</span><span class="p">:</span>
                                <span class="n">assignment_scores_by_canvas_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">assignment_scores_by_canvas_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">assignment_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">assignment_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">assignment_info</span><span class="p">[</span><span class="s2">&quot;group_name&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
                                <span class="s2">&quot;points_possible&quot;</span><span class="p">:</span> <span class="n">assignment_info</span><span class="p">[</span><span class="s2">&quot;points_possible&quot;</span><span class="p">]</span>
                            <span class="p">}</span>
                        <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
                            <span class="n">comments</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">submission</span><span class="p">,</span> <span class="s2">&quot;submission_comments&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assignment_comments_by_canvas_id</span><span class="p">:</span>
                                    <span class="n">assignment_comments_by_canvas_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="n">normalized_comments</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">comments</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                                        <span class="n">normalized_comments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                            <span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author_id&quot;</span><span class="p">),</span>
                                            <span class="s2">&quot;author_name&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author_name&quot;</span><span class="p">),</span>
                                            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comment&quot;</span><span class="p">),</span>
                                            <span class="s2">&quot;posted_at&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;posted_at&quot;</span><span class="p">),</span>
                                        <span class="p">})</span>
                                <span class="n">assignment_comments_by_canvas_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">assignment_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalized_comments</span>
                            <span class="n">rubric</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">submission</span><span class="p">,</span> <span class="s2">&quot;rubric_assessment&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">rubric</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assignment_rubrics_by_canvas_id</span><span class="p">:</span>
                                    <span class="n">assignment_rubrics_by_canvas_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="n">assignment_rubrics_by_canvas_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">assignment_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rubric</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SyncCanvas] Warning: Error fetching assignment submissions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Error fetching assignment submissions.&quot;</span><span class="p">)</span>

        <span class="c1"># Merge Canvas roster and grades into the local database.</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SyncCanvas] Syncing student data...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Syncing student data...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">canvas_student</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">canvas_students</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Syncing students&quot;</span><span class="p">):</span>
            <span class="n">canvas_email</span> <span class="o">=</span> <span class="n">canvas_student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">canvas_name</span> <span class="o">=</span> <span class="n">canvas_student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">canvas_id</span> <span class="o">=</span> <span class="n">canvas_student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;canvas_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">norm_canvas_name</span> <span class="o">=</span> <span class="n">normalize_name</span><span class="p">(</span><span class="n">canvas_name</span><span class="p">)</span>
            <span class="n">matched_student</span> <span class="o">=</span> <span class="n">_resolve_canvas_match</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">,</span> <span class="n">norm_canvas_name</span><span class="p">,</span> <span class="n">canvas_email</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matched_student</span> <span class="o">==</span> <span class="s2">&quot;__skip__&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">matched_student</span><span class="p">:</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="s2">&quot;Canvas ID&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="s2">&quot;Canvas ID&quot;</span><span class="p">):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="s2">&quot;Canvas ID&quot;</span><span class="p">,</span> <span class="n">canvas_id</span><span class="p">)</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">canvas_email</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="s2">&quot;Email&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="s2">&quot;Email&quot;</span><span class="p">)):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span> <span class="n">canvas_email</span><span class="p">)</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">total_grades_by_canvas_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)):</span>
                    <span class="n">grade_data</span> <span class="o">=</span> <span class="n">total_grades_by_canvas_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">grade_field</span><span class="p">,</span> <span class="n">grade_value</span> <span class="ow">in</span> <span class="n">grade_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">grade_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">field_name</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;final_score&quot;</span><span class="p">:</span> <span class="s2">&quot;Total Final Score&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;final_grade&quot;</span><span class="p">:</span> <span class="s2">&quot;Total Final Grade&quot;</span><span class="p">,</span>
                            <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">grade_field</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">field_name</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">grade_field</span> <span class="o">==</span> <span class="s2">&quot;final_score&quot;</span><span class="p">:</span>
                                    <span class="n">grade_value</span> <span class="o">=</span> <span class="n">_scale_score_to_ten</span><span class="p">(</span><span class="n">grade_value</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">grade_value</span><span class="p">:</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">grade_value</span><span class="p">)</span>
                                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">group_scores_by_canvas_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">scores_data</span> <span class="ow">in</span> <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">final_score</span> <span class="o">=</span> <span class="n">_scale_score_to_ten</span><span class="p">(</span>
                            <span class="n">scores_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;final_score&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">scores_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;final_possible&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">final_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2"> Final Score&quot;</span>
                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="n">final_field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">final_score</span><span class="p">:</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="n">final_field</span><span class="p">,</span> <span class="n">final_score</span><span class="p">)</span>
                            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">assignment_scores_by_canvas_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">assignment_id</span><span class="p">,</span> <span class="n">assignment_data</span> <span class="ow">in</span> <span class="n">assignment_scores_by_canvas_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">assignment_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="n">_scale_score_to_ten</span><span class="p">(</span>
                            <span class="n">assignment_data</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">],</span>
                            <span class="n">assignment_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points_possible&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Assignment: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">score</span><span class="p">:</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
                            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">assignment_comments_by_canvas_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)):</span>
                    <span class="n">existing_comments</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="s2">&quot;Canvas Submission Comments&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="n">updated_comments</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">existing_comments</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">assignment_id</span><span class="p">,</span> <span class="n">comments</span> <span class="ow">in</span> <span class="n">assignment_comments_by_canvas_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">important_assignments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">))</span>
                        <span class="n">updated_comments</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">comments</span>
                    <span class="k">if</span> <span class="n">updated_comments</span> <span class="o">!=</span> <span class="n">existing_comments</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="s2">&quot;Canvas Submission Comments&quot;</span><span class="p">,</span> <span class="n">updated_comments</span><span class="p">)</span>
                        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">assignment_rubrics_by_canvas_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)):</span>
                    <span class="n">existing_rubrics</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="s2">&quot;Canvas Rubric Evaluations&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="n">updated_rubrics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">existing_rubrics</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">assignment_id</span><span class="p">,</span> <span class="n">rubric</span> <span class="ow">in</span> <span class="n">assignment_rubrics_by_canvas_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">important_assignments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">))</span>
                        <span class="n">updated_rubrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rubric</span>
                    <span class="k">if</span> <span class="n">updated_rubrics</span> <span class="o">!=</span> <span class="n">existing_rubrics</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">matched_student</span><span class="p">,</span> <span class="s2">&quot;Canvas Rubric Evaluations&quot;</span><span class="p">,</span> <span class="n">updated_rubrics</span><span class="p">)</span>
                        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                    <span class="n">updated_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_student_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">canvas_name</span><span class="p">,</span>
                    <span class="s2">&quot;Email&quot;</span><span class="p">:</span> <span class="n">canvas_email</span><span class="p">,</span>
                    <span class="s2">&quot;Canvas ID&quot;</span><span class="p">:</span> <span class="n">canvas_id</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">total_grades_by_canvas_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)):</span>
                    <span class="n">grade_data</span> <span class="o">=</span> <span class="n">total_grades_by_canvas_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">grade_field</span><span class="p">,</span> <span class="n">grade_value</span> <span class="ow">in</span> <span class="n">grade_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">grade_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">field_name</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;final_score&quot;</span><span class="p">:</span> <span class="s2">&quot;Total Final Score&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;final_grade&quot;</span><span class="p">:</span> <span class="s2">&quot;Total Final Grade&quot;</span><span class="p">,</span>
                            <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">grade_field</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">field_name</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">grade_field</span> <span class="o">==</span> <span class="s2">&quot;final_score&quot;</span><span class="p">:</span>
                                    <span class="n">grade_value</span> <span class="o">=</span> <span class="n">_scale_score_to_ten</span><span class="p">(</span><span class="n">grade_value</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                                <span class="n">new_student_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">grade_value</span>

                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">group_scores_by_canvas_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">scores_data</span> <span class="ow">in</span> <span class="n">group_scores_by_canvas_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">new_student_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2"> Final Score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_scale_score_to_ten</span><span class="p">(</span>
                            <span class="n">scores_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;final_score&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">scores_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;final_possible&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="p">)</span>

                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">assignment_scores_by_canvas_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">assignment_id</span><span class="p">,</span> <span class="n">assignment_data</span> <span class="ow">in</span> <span class="n">assignment_scores_by_canvas_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">assignment_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="n">_scale_score_to_ten</span><span class="p">(</span>
                            <span class="n">assignment_data</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">],</span>
                            <span class="n">assignment_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points_possible&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Assignment: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">new_student_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">assignment_comments_by_canvas_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)):</span>
                    <span class="n">comments</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">assignment_id</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">assignment_comments_by_canvas_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">important_assignments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">))</span>
                        <span class="n">comments</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span>
                    <span class="n">new_student_data</span><span class="p">[</span><span class="s2">&quot;Canvas Submission Comments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comments</span>

                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">assignment_rubrics_by_canvas_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)):</span>
                    <span class="n">rubrics</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">assignment_id</span><span class="p">,</span> <span class="n">rubric</span> <span class="ow">in</span> <span class="n">assignment_rubrics_by_canvas_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">important_assignments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">))</span>
                        <span class="n">rubrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rubric</span>
                    <span class="n">new_student_data</span><span class="p">[</span><span class="s2">&quot;Canvas Rubric Evaluations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rubrics</span>

                <span class="n">students</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Student</span><span class="p">(</span><span class="o">**</span><span class="n">new_student_data</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">canvas_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">existing_by_canvas_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">students</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                        <span class="k">pass</span>
                <span class="k">if</span> <span class="n">canvas_email</span><span class="p">:</span>
                    <span class="n">existing_by_email</span><span class="p">[</span><span class="n">canvas_email</span><span class="p">]</span> <span class="o">=</span> <span class="n">students</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">norm_canvas_name</span><span class="p">:</span>
                    <span class="n">existing_by_name</span><span class="p">[</span><span class="n">norm_canvas_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">students</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">added_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">added_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">updated_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">db_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SyncCanvas] Saving updated database with </span><span class="si">{</span><span class="n">added_count</span><span class="si">}</span><span class="s2"> new and </span><span class="si">{</span><span class="n">updated_count</span><span class="si">}</span><span class="s2"> modified students...&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving updated database with </span><span class="si">{</span><span class="n">added_count</span><span class="si">}</span><span class="s2"> new and </span><span class="si">{</span><span class="n">updated_count</span><span class="si">}</span><span class="s2"> modified students...&quot;</span><span class="p">)</span>
                <span class="n">save_database</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="n">db_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SyncCanvas] Database saved successfully.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database saved successfully.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SyncCanvas] Sync completed: </span><span class="si">{</span><span class="n">added_count</span><span class="si">}</span><span class="s2"> students added, </span><span class="si">{</span><span class="n">updated_count</span><span class="si">}</span><span class="s2"> students updated.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sync completed: </span><span class="si">{</span><span class="n">added_count</span><span class="si">}</span><span class="s2"> students added, </span><span class="si">{</span><span class="n">updated_count</span><span class="si">}</span><span class="s2"> students updated.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">added_count</span><span class="p">,</span> <span class="n">updated_count</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SyncCanvas] Error syncing with Canvas: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error syncing with Canvas: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="interactive_modify_database">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.interactive_modify_database">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">interactive_modify_database</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="n">db_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interactively modify student records in the database.</span>
<span class="sd">    Allows searching, editing, adding, and deleting students.</span>
<span class="sd">    When editing a field, pre-fill the old value for easy modification.</span>
<span class="sd">    After editing a field, ask if the user wants to continue editing other fields of the same student,</span>
<span class="sd">    edit another student, or quit. Always allow quitting at any step.</span>
<span class="sd">    If no response after 60 seconds from user then quit.</span>
<span class="sd">    If verbose is True, print more details; otherwise, print only important notice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">db_path</span><span class="p">:</span>
            <span class="n">students</span> <span class="o">=</span> <span class="n">load_database</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">students</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ModifyDB] No students in the database.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No students in the database.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">list_students</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ModifyDB] List of students:&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;List of students:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Student ID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ModifyDB] Modify Menu:&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Modify Menu:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1. List students&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2. Edit a student&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3. Add a new student&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;4. Delete a student&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;0. Exit modify menu&quot;</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Choose an option (or &#39;q&#39; to quit): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">return</span>
            
            <span class="k">if</span> <span class="n">choice</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
                <span class="n">list_students</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">list_students</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Enter the number of the student to edit (or &#39;q&#39; to quit): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                        <span class="k">return</span>
                    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                        <span class="k">return</span>
                    
                    <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">idx</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">students</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ModifyDB] Invalid index.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid index.&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">students</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ModifyDB] Current fields:&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current fields:&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">field</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Enter field to edit (or leave blank to cancel, or &#39;q&#39; to quit): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                            <span class="k">return</span>
                        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                            <span class="k">return</span>
                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">old_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="c1"># Pre-fill old value for editing</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">prefill_input_with_timeout</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enter new value for &#39;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#39; [</span><span class="si">{</span><span class="n">old_value</span><span class="si">}</span><span class="s2">]: &quot;</span><span class="p">,</span> <span class="n">old_value</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                            <span class="k">return</span>
                        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                            <span class="k">return</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enter new value for &#39;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#39; (old: </span><span class="si">{</span><span class="n">old_value</span><span class="si">}</span><span class="s2">): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">old_value</span>
                            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                                <span class="k">return</span>
                            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                                <span class="k">return</span>
                        
                        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ModifyDB] Student updated: </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Student updated.&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">db_path</span><span class="p">:</span>
                            <span class="n">save_database</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                        <span class="c1"># Ask if continue editing this student, edit another student, or quit</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">next_action</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Continue editing other fields of this student (c), edit another student (a), or quit (q)? [c/a/q]: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                            <span class="k">return</span>
                        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                            <span class="k">return</span>
                        
                        <span class="k">if</span> <span class="n">next_action</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
                            <span class="k">return</span>
                        <span class="k">elif</span> <span class="n">next_action</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="c1"># else continue editing this student</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ModifyDB] Enter new student information (leave blank to skip a field, or &#39;q&#39; to quit):&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter new student information (leave blank to skip a field, or &#39;q&#39; to quit):&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Student ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                        <span class="k">return</span>
                    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                        <span class="k">return</span>
                    
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ModifyDB] Cancelled adding new student.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cancelled adding new student.&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">students</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Student</span><span class="p">(</span><span class="o">**</span><span class="n">fields</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ModifyDB] Student added: </span><span class="si">{</span><span class="n">fields</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Student added.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">db_path</span><span class="p">:</span>
                        <span class="n">save_database</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">list_students</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Enter the number of the student to delete (or &#39;q&#39; to quit): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                        <span class="k">return</span>
                    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                        <span class="k">return</span>
                    
                    <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">idx</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">students</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ModifyDB] Invalid index.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid index.&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">del</span> <span class="n">students</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ModifyDB] Student deleted.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Student deleted.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">db_path</span><span class="p">:</span>
                        <span class="n">save_database</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ModifyDB] Invalid option.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid option.&quot;</span><span class="p">)</span>
    
    <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ModifyDB] Timeout occurred. Exiting modify menu.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout occurred. Exiting modify menu.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ModifyDB] Operation cancelled by user. Exiting modify menu.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user. Exiting modify menu.&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="list_canvas_assignments">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.list_canvas_assignments">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_canvas_assignments</span><span class="p">(</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all assignments in a Canvas course, grouped by assignment category (assignment group), using the canvasapi library.</span>
<span class="sd">    If category is specified (case-insensitive), only list assignments in that category.</span>
<span class="sd">    Assignments are sorted by due date (earliest first; undated last).</span>

<span class="sd">    Args:</span>
<span class="sd">        api_url (str): The base URL for the Canvas instance (e.g., &quot;https://canvas.instructure.com&quot;)</span>
<span class="sd">        api_key (str): Your Canvas API access token</span>
<span class="sd">        course_id (int or str): The Canvas course ID</span>
<span class="sd">        category (str, optional): Assignment group name to filter (case-insensitive)</span>
<span class="sd">        verbose (bool): If True, print more details; otherwise, print only important notice.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict mapping assignment group names to lists of assignment dicts with id, name, due_at, and points_possible</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasAssignments] Listing assignments for course: </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">course</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">course</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Listing assignments for course: </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">course</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">course</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Get all assignment groups with assignments included</span>
        <span class="n">assignment_groups</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">])</span>
        <span class="n">group_assignments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">assignment_groups</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
            <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="n">format_time</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;due_at&#39;</span><span class="p">)),</span>
                    <span class="s2">&quot;due_at_raw&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;due_at&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;points_possible&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;points_possible&#39;</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="c1"># Sort assignments by due date (None last)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">due_sort_key</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_at_raw&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
            <span class="n">assignments</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">due_sort_key</span><span class="p">)</span>
            <span class="c1"># Remove &#39;due_at_raw&#39; from output</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;due_at_raw&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">group_assignments</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">assignments</span>
        <span class="c1"># If category is specified, filter to only that group (case-insensitive)</span>
        <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
            <span class="n">matched</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">group_name</span> <span class="ow">in</span> <span class="n">group_assignments</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">matched</span> <span class="o">=</span> <span class="n">group_name</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">matched</span><span class="p">:</span>
                <span class="n">group_assignments</span> <span class="o">=</span> <span class="p">{</span><span class="n">matched</span><span class="p">:</span> <span class="n">group_assignments</span><span class="p">[</span><span class="n">matched</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasAssignments] No assignment group found matching category &#39;</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No assignment group found matching category &#39;</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>
        <span class="c1"># Print assignments grouped by category</span>
        <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">assignments</span> <span class="ow">in</span> <span class="n">group_assignments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasAssignments] Category: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">)</span><span class="si">}</span><span class="s2"> assignments)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Category: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">)</span><span class="si">}</span><span class="s2"> assignments)&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasAssignments]   ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Name: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;due_at&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Points: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;points_possible&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Name: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;due_at&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Points: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;points_possible&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">group_assignments</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasAssignments] canvasapi library is not installed. Please install it with &#39;pip install canvasapi&#39;.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;canvasapi library is not installed. Please install it with &#39;pip install canvasapi&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasAssignments] Error listing assignments: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error listing assignments: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="list_canvas_people">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.list_canvas_people">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_canvas_people</span><span class="p">(</span><span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span> <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all teachers, TAs, and students in a Canvas course using the canvasapi library.</span>
<span class="sd">    For students, divides into active students and invited students.</span>

<span class="sd">    Args:</span>
<span class="sd">        api_url (str): The base URL for the Canvas instance.</span>
<span class="sd">        api_key (str): Your Canvas API access token.</span>
<span class="sd">        course_id (int or str): The Canvas course ID.</span>
<span class="sd">        verbose (bool): If True, print more details; otherwise, print only important notice.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict with keys &#39;teachers&#39;, &#39;tas&#39;, &#39;active_students&#39;, &#39;invited_students&#39;, each a list of dicts with id, name, email, and canvas_id.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="n">enrollments</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_enrollments</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TeacherEnrollment&#39;</span><span class="p">,</span> <span class="s1">&#39;TaEnrollment&#39;</span><span class="p">,</span> <span class="s1">&#39;StudentEnrollment&#39;</span><span class="p">])</span>
        <span class="n">people</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;teachers&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;tas&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;active_students&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;invited_students&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">enrollment</span> <span class="ow">in</span> <span class="n">enrollments</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">user</span>
            <span class="n">role</span> <span class="o">=</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">person</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="s2">&quot;canvas_id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;login_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;teacherenrollment&#39;</span><span class="p">:</span>
                <span class="n">people</span><span class="p">[</span><span class="s1">&#39;teachers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;taenrollment&#39;</span><span class="p">:</span>
                <span class="n">people</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;studentenrollment&#39;</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">enrollment_state</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span>
                    <span class="n">people</span><span class="p">[</span><span class="s1">&#39;active_students&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;invited&#39;</span><span class="p">:</span>
                    <span class="n">people</span><span class="p">[</span><span class="s1">&#39;invited_students&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">people</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;teachers&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;tas&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;active_students&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;invited_students&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;teachers&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;tas&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;active_students&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;invited_students&#39;</span><span class="p">:</span> <span class="p">[]}</span></div>


<div class="viewcode-block" id="print_canvas_people">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.print_canvas_people">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_canvas_people</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print the Canvas people dictionary returned by list_canvas_people.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">people</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;teachers&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPeople] Teachers (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">people</span><span class="p">[</span><span class="s1">&#39;teachers&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Teachers (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">people</span><span class="p">[</span><span class="s1">&#39;teachers&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">people</span><span class="p">[</span><span class="s1">&#39;teachers&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPeople]   </span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Canvas ID: </span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Canvas ID: </span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">people</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tas&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPeople] TAs (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">people</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TAs (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">people</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ta</span> <span class="ow">in</span> <span class="n">people</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPeople]   </span><span class="si">{</span><span class="n">ta</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ta</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Canvas ID: </span><span class="si">{</span><span class="n">ta</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ta</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ta</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Canvas ID: </span><span class="si">{</span><span class="n">ta</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">people</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_students&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPeople] Active Students (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">people</span><span class="p">[</span><span class="s1">&#39;active_students&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Active Students (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">people</span><span class="p">[</span><span class="s1">&#39;active_students&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">people</span><span class="p">[</span><span class="s1">&#39;active_students&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPeople]   </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">people</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;invited_students&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPeople] Invited Students (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">people</span><span class="p">[</span><span class="s1">&#39;invited_students&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Invited Students (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">people</span><span class="p">[</span><span class="s1">&#39;invited_students&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">people</span><span class="p">[</span><span class="s1">&#39;invited_students&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPeople]   </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="invite_students_if_not_enrolled">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.invite_students_if_not_enrolled">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">invite_students_if_not_enrolled</span><span class="p">(</span>
    <span class="n">students</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;student&quot;</span><span class="p">,</span>
    <span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Invite students to Canvas if they are not already active or invited.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: summary with results and skip counts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">students</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasInvite] No students provided for invitation.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No students provided for invitation.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;invited&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;skipped_enrolled&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;skipped_missing&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;skipped_duplicate&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="n">people</span> <span class="o">=</span> <span class="n">list_canvas_people</span><span class="p">(</span><span class="n">api_url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">enrolled_emails</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;active_students&quot;</span><span class="p">,</span> <span class="s2">&quot;invited_students&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">people</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">email</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">email</span><span class="p">:</span>
                <span class="n">enrolled_emails</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_student_email</span><span class="p">(</span><span class="n">student</span><span class="p">):</span>
        <span class="n">email_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">email_val</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;email&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">email_val</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">email_val</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">email_val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="n">_normalize_student_id</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">&quot;Student ID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sid</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">@hus.edu.vn&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_student_name</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="n">fallback_email</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">name_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name_val</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">name_val</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">name_val</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">name_val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fallback_email</span> <span class="ow">and</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">fallback_email</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fallback_email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;Student&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_student_section</span><span class="p">(</span><span class="n">student</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Canvas Section&quot;</span><span class="p">,</span> <span class="s2">&quot;Section&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">invited</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">skipped_enrolled</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">skipped_missing</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">skipped_duplicate</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">seen_emails</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">student</span> <span class="ow">in</span> <span class="n">students</span><span class="p">:</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">_get_student_email</span><span class="p">(</span><span class="n">student</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
            <span class="n">skipped_missing</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasInvite] Skipping student without email.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">email_key</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">email_key</span> <span class="ow">in</span> <span class="n">seen_emails</span><span class="p">:</span>
            <span class="n">skipped_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">seen_emails</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">email_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">email_key</span> <span class="ow">in</span> <span class="n">enrolled_emails</span><span class="p">:</span>
            <span class="n">skipped_enrolled</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">_get_student_name</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="n">fallback_email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
        <span class="n">student_section</span> <span class="o">=</span> <span class="n">_get_student_section</span><span class="p">(</span><span class="n">student</span><span class="p">)</span> <span class="ow">or</span> <span class="n">section</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">invite_user_to_canvas_course</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
            <span class="n">section</span><span class="o">=</span><span class="n">student_section</span><span class="p">,</span>
            <span class="n">api_url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
            <span class="n">invited</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;[CanvasInvite] Summary: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">invited</span><span class="si">}</span><span class="s2"> invited, </span><span class="si">{</span><span class="n">skipped_enrolled</span><span class="si">}</span><span class="s2"> already enrolled, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">skipped_missing</span><span class="si">}</span><span class="s2"> missing email, </span><span class="si">{</span><span class="n">skipped_duplicate</span><span class="si">}</span><span class="s2"> duplicates.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invited </span><span class="si">{</span><span class="n">invited</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Skipped: </span><span class="si">{</span><span class="n">skipped_enrolled</span><span class="si">}</span><span class="s2"> enrolled, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">skipped_missing</span><span class="si">}</span><span class="s2"> missing email, </span><span class="si">{</span><span class="n">skipped_duplicate</span><span class="si">}</span><span class="s2"> duplicates.&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
        <span class="s2">&quot;invited&quot;</span><span class="p">:</span> <span class="n">invited</span><span class="p">,</span>
        <span class="s2">&quot;skipped_enrolled&quot;</span><span class="p">:</span> <span class="n">skipped_enrolled</span><span class="p">,</span>
        <span class="s2">&quot;skipped_missing&quot;</span><span class="p">:</span> <span class="n">skipped_missing</span><span class="p">,</span>
        <span class="s2">&quot;skipped_duplicate&quot;</span><span class="p">:</span> <span class="n">skipped_duplicate</span><span class="p">,</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="download_canvas_assignment_submissions">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.download_canvas_assignment_submissions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">download_canvas_assignment_submissions</span><span class="p">(</span>
    <span class="n">assignment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dest_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="n">CANVAS_DEFAULT_ASSIGNMENT_CATEGORY</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download only the latest version of each student&#39;s submission file for one or more Canvas assignments.</span>
<span class="sd">    If an old version is already downloaded, delete the old version and keep the new one.</span>
<span class="sd">    If assignment_id is not specified, list all assignments (optionally only in one category) that have at least one submission and prompt user to select one or more (supports ranges, comma-separated, or &#39;a&#39; for all).</span>
<span class="sd">    Files are renamed as: &lt;student name&gt;_&lt;canvas id&gt;_&lt;assignment id&gt;_&lt;submitted time&gt;_&lt;status&gt;.&lt;ext&gt;</span>
<span class="sd">    All files are saved in a folder named &lt;assignment group&gt;_&lt;assignment_name&gt;.</span>
<span class="sd">    After downloading, check PDF content similarity and meaningful level in the downloaded folder.</span>
<span class="sd">    At every user prompt, allow quitting by entering &#39;q&#39; or &#39;quit&#39;.</span>
<span class="sd">    Added options:</span>
<span class="sd">      - Download all latest submissions (delete old versions, skip already downloaded latest)</span>
<span class="sd">      - Perform all tasks (download, check meaningfulness, check similarity)</span>
<span class="sd">      - These options are used as default if user does not respond in 60 seconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[DownloadCanvas] Timeout: No response after 60 seconds. Using default option.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Using default option.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use signal.SIGALRM only if available (not on Windows)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DownloadCanvas] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DownloadCanvas] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[DownloadCanvas] Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback for platforms without SIGALRM (e.g., Windows)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DownloadCanvas] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[DownloadCanvas] Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>

        <span class="c1"># If assignment_id is not specified, list all assignments with at least one submission and prompt user</span>
        <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">assignment_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">assignment_groups</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">and</span> <span class="n">group_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_submitted_submissions&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
                        <span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;due_at&#39;</span><span class="p">)</span>
                    <span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">assignments</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No assignments found with submissions.&quot;</span> <span class="k">if</span> <span class="n">category</span> <span class="k">else</span> <span class="s2">&quot;No assignments found.&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DownloadCanvas] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">assignment_id</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">due_sort_key</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_at&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
            <span class="n">assignments</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">due_sort_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Assignments with at least one submission:&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assignments with at least one submission:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">due</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;due_at&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;No due date&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">due</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                    <span class="s2">&quot;Enter the number(s) of the assignment(s) to download submissions from (e.g. 1,3-5 or &#39;a&#39; for all, or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;a&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Quitting download.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting download.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">):</span>
                    <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="c1"># Parse comma-separated and range input</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                            <span class="n">selected</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Invalid selection. Please enter valid numbers, a range, &#39;a&#39; for all, or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid selection. Please enter valid numbers, a range, &#39;a&#39; for all, or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">assignment_id</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">assignment_id</span> <span class="ow">in</span> <span class="n">assignment_ids</span><span class="p">:</span>
            <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>
            <span class="n">assignment_name</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="c1"># Get assignment group name</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;UnknownGroup&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">group_id</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">assignment_group_id</span>
                <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">ag</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">group_id</span><span class="p">:</span>
                        <span class="n">group_name</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">assignment_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dest_dir</span><span class="p">:</span>
                <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DownloadCanvas] Downloading submissions to: </span><span class="si">{</span><span class="n">out_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading submissions to: </span><span class="si">{</span><span class="n">out_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Use include=[&quot;user&quot;, &quot;attachments&quot;] for fast batch fetch</span>
            <span class="n">submissions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">get_submissions</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;attachments&quot;</span><span class="p">]))</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Precompute due date for all submissions</span>
            <span class="n">due_at</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;due_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">due_at</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">due_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">due_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">due_dt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">due_dt</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Track latest submission info per student (canvas_id)</span>
            <span class="n">latest_submissions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">canvas_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                <span class="n">submitted_at</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">submitted_at</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sub_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">submitted_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">sub_dt</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># Only keep the latest submission for each student</span>
                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">latest_submissions</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sub_dt</span> <span class="ow">and</span> <span class="n">latest_submissions</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">][</span><span class="s2">&quot;sub_dt&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sub_dt</span> <span class="o">&gt;</span> <span class="n">latest_submissions</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">][</span><span class="s2">&quot;sub_dt&quot;</span><span class="p">]):</span>
                    <span class="n">latest_submissions</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;submission&quot;</span><span class="p">:</span> <span class="n">sub</span><span class="p">,</span>
                        <span class="s2">&quot;sub_dt&quot;</span><span class="p">:</span> <span class="n">sub_dt</span><span class="p">,</span>
                        <span class="s2">&quot;submitted_at&quot;</span><span class="p">:</span> <span class="n">submitted_at</span>
                    <span class="p">}</span>

            <span class="c1"># Gather all existing files in the output directory</span>
            <span class="n">existing_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">))</span>

            <span class="c1"># Ask user if they want to download all latest submissions (delete old, skip already downloaded latest)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">download_all_choice</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Do you want to download all latest submissions for &#39;</span><span class="si">{</span><span class="n">assignment_name</span><span class="si">}</span><span class="s2">&#39; (delete old versions, skip already downloaded latest)? (y/n, default &#39;y&#39; in 60s): &quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;y&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">download_all_choice</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>
            <span class="k">if</span> <span class="n">download_all_choice</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Quitting download.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting download.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">download_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">download_all_choice</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">download_all</span><span class="p">:</span>
                <span class="c1"># For each latest submission, download the latest file and remove old versions</span>
                <span class="k">for</span> <span class="n">canvas_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">latest_submissions</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Downloading latest submissions for </span><span class="si">{</span><span class="n">assignment_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="n">sub</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;submission&quot;</span><span class="p">]</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">student_name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;UnknownStudent&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="n">submitted_at</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;submitted_at&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">submitted_at</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">submitted_at</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">submitted_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                                <span class="n">dt_str</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">dt_str</span> <span class="o">=</span> <span class="s2">&quot;no_time&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dt_str</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dt_str</span> <span class="o">=</span> <span class="s2">&quot;no_time&quot;</span>
                    <span class="c1"># Determine on time or late</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;on_time&quot;</span>
                    <span class="k">if</span> <span class="n">due_dt</span> <span class="ow">and</span> <span class="n">submitted_at</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">sub_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">submitted_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;on_time&quot;</span> <span class="k">if</span> <span class="n">sub_dt</span> <span class="o">&lt;=</span> <span class="n">due_dt</span> <span class="k">else</span> <span class="s2">&quot;late&quot;</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;on_time&quot;</span>
                    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;late&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;late&quot;</span>
                    <span class="n">attachments</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;attachments&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attachments</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">attachments</span><span class="p">:</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">)</span>
                        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># Add assignment_id to the filename</span>
                        <span class="n">new_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">student_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">canvas_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">dt_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">status</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">)</span>
                        <span class="c1"># Remove all old versions for this student (same canvas_id, same assignment_id, same ext, but different dt_str)</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">student_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span>
                                <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
                                <span class="ow">and</span> <span class="n">f</span> <span class="o">!=</span> <span class="n">new_filename</span>
                            <span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="k">pass</span>
                        <span class="c1"># Download if not exists or file is empty</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">continue</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span> <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DownloadCanvas] Failed to download </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">student_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">student_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DownloadCanvas] Downloaded </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> files to </span><span class="si">{</span><span class="n">out_dir</span><span class="si">}</span><span class="s2"> (skipped </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2"> already existing latest files)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> files to </span><span class="si">{</span><span class="n">out_dir</span><span class="si">}</span><span class="s2"> (skipped </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2"> already existing latest files)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Skipped downloading all latest submissions.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipped downloading all latest submissions.&quot;</span><span class="p">)</span>

            <span class="c1"># After downloading, check PDF content similarity and meaningful level in the downloaded folder</span>
            <span class="n">pdf_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf_files</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Downloaded PDFs found. You can now check PDF content quality and/or similarity.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloaded PDFs found. You can now check PDF content quality and/or similarity.&quot;</span><span class="p">)</span>

                <span class="c1"># Ask user what to do next, default is &quot;3&quot; (perform all tasks)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">What would you like to do?&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1. Check PDF meaningful level (quality)&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2. Check PDF content similarity&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3. Check both meaningful level and similarity&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;4. Skip checks and exit&quot;</span><span class="p">)</span>
                    <span class="n">choice</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                        <span class="s2">&quot;Enter your choice (1-4, or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;3&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                    <span class="n">choice</span> <span class="o">=</span> <span class="s2">&quot;3&quot;</span>

                <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Quitting after download.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting after download.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Checking meaningful level of PDF submissions...&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking meaningful level of PDF submissions...&quot;</span><span class="p">)</span>
                    <span class="n">detect_meaningful_level_and_notify_students</span><span class="p">(</span>
                        <span class="n">out_dir</span><span class="p">,</span>
                        <span class="n">assignment_id</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">,</span>
                        <span class="n">api_url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                        <span class="n">ocr_service</span><span class="o">=</span><span class="n">DEFAULT_OCR_METHOD</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf_files</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Checking PDF content similarity...&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking PDF content similarity...&quot;</span><span class="p">)</span>
                        <span class="n">compare_texts_from_pdfs_in_folder</span><span class="p">(</span>
                            <span class="n">out_dir</span><span class="p">,</span>
                            <span class="n">api_url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span>
                            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                            <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
                            <span class="n">ocr_service</span><span class="o">=</span><span class="n">DEFAULT_OCR_METHOD</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Not enough PDF files to compare similarity (need at least 2).&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough PDF files to compare similarity (need at least 2).&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Checking meaningful level of PDF submissions...&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking meaningful level of PDF submissions...&quot;</span><span class="p">)</span>
                    <span class="n">detect_meaningful_level_and_notify_students</span><span class="p">(</span>
                        <span class="n">out_dir</span><span class="p">,</span>
                        <span class="n">assignment_id</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">,</span>
                        <span class="n">api_url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                        <span class="n">ocr_service</span><span class="o">=</span><span class="n">DEFAULT_OCR_METHOD</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf_files</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Checking PDF content similarity...&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Checking PDF content similarity...&quot;</span><span class="p">)</span>
                        <span class="n">compare_texts_from_pdfs_in_folder</span><span class="p">(</span>
                            <span class="n">out_dir</span><span class="p">,</span>
                            <span class="n">api_url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span>
                            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                            <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
                            <span class="n">ocr_service</span><span class="o">=</span><span class="n">DEFAULT_OCR_METHOD</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Not enough PDF files to compare similarity (need at least 2).&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough PDF files to compare similarity (need at least 2).&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Skipped PDF quality and similarity checks.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipped PDF quality and similarity checks.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] Invalid choice. Please enter 1, 2, 3, 4, or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid choice. Please enter 1, 2, 3, 4, or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DownloadCanvas] No PDF files found in the downloaded folder to check.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No PDF files found in the downloaded folder to check.&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DownloadCanvas] Error downloading submissions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading submissions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="download_canvas_assignment_submissions_auto">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.download_canvas_assignment_submissions_auto">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">download_canvas_assignment_submissions_auto</span><span class="p">(</span>
    <span class="n">assignment_id</span><span class="p">,</span>
    <span class="n">dest_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download latest submissions for a single Canvas assignment without prompts.</span>
<span class="sd">    Returns (output_dir, downloaded_files).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
    <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
    <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>
    <span class="n">lock_at</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;lock_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lock_at</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lock_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">lock_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lock_dt</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WeeklyAuto] Warning: assignment </span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2"> is not locked yet (lock_at=</span><span class="si">{</span><span class="n">lock_at</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">assignment_name</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;UnknownGroup&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">assignment_group_id</span>
        <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ag</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">group_id</span><span class="p">:</span>
                <span class="n">group_name</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">folder_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">assignment_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dest_dir</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DownloadCanvasAuto] Downloading submissions to: </span><span class="si">{</span><span class="n">out_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading submissions to: </span><span class="si">{</span><span class="n">out_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">submissions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">get_submissions</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;attachments&quot;</span><span class="p">]))</span>
    <span class="n">due_at</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;due_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">due_dt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">due_at</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">due_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">due_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">due_dt</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">latest_submissions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">canvas_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">submitted_at</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sub_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">submitted_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">sub_dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">latest_submissions</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sub_dt</span> <span class="ow">and</span> <span class="n">latest_submissions</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">][</span><span class="s2">&quot;sub_dt&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sub_dt</span> <span class="o">&gt;</span> <span class="n">latest_submissions</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">][</span><span class="s2">&quot;sub_dt&quot;</span><span class="p">]):</span>
            <span class="n">latest_submissions</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;submission&quot;</span><span class="p">:</span> <span class="n">sub</span><span class="p">,</span>
                <span class="s2">&quot;sub_dt&quot;</span><span class="p">:</span> <span class="n">sub_dt</span><span class="p">,</span>
                <span class="s2">&quot;submitted_at&quot;</span><span class="p">:</span> <span class="n">submitted_at</span>
            <span class="p">}</span>

    <span class="n">downloaded_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">canvas_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">latest_submissions</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Downloading latest submissions for </span><span class="si">{</span><span class="n">assignment_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;submission&quot;</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">student_name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;UnknownStudent&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">submitted_at</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;submitted_at&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">submitted_at</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">submitted_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                <span class="n">dt_str</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">dt_str</span> <span class="o">=</span> <span class="s2">&quot;no_time&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dt_str</span> <span class="o">=</span> <span class="s2">&quot;no_time&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;on_time&quot;</span>
        <span class="k">if</span> <span class="n">due_dt</span> <span class="ow">and</span> <span class="n">submitted_at</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sub_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">submitted_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;on_time&quot;</span> <span class="k">if</span> <span class="n">sub_dt</span> <span class="o">&lt;=</span> <span class="n">due_dt</span> <span class="k">else</span> <span class="s2">&quot;late&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;on_time&quot;</span>
        <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;late&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;late&quot;</span>
        <span class="n">attachments</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;attachments&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attachments</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">attachments</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">)</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">student_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">canvas_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">dt_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">status</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">downloaded_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span> <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">downloaded_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DownloadCanvasAuto] Failed to download </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">student_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">student_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">downloaded_files</span></div>


<div class="viewcode-block" id="compare_texts_from_pdfs_in_folder">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.compare_texts_from_pdfs_in_folder">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compare_texts_from_pdfs_in_folder</span><span class="p">(</span>
    <span class="n">folder_path</span><span class="p">,</span>
    <span class="n">ocr_service</span><span class="o">=</span><span class="n">DEFAULT_OCR_METHOD</span><span class="p">,</span>
    <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">simple_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">refine</span><span class="o">=</span><span class="n">DEFAULT_AI_METHOD</span><span class="p">,</span>
    <span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span>
    <span class="n">db_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">auto_send</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract texts from all PDFs in a folder, compare the extracted texts,</span>
<span class="sd">    and output the names of the corresponding PDFs which have high similarity in contents.</span>
<span class="sd">    Also saves the comparison results to a TXT file in the same folder.</span>
<span class="sd">    If two or more PDFs are highly similar, send a message to all corresponding students</span>
<span class="sd">    asking them to resubmit, indicating that this is cheating and not allowed.</span>

<span class="sd">    Additionally, save the status of message sent for each pair to the TXT file.</span>
<span class="sd">    On later runs, do not send message for the same pair of PDFs again.</span>

<span class="sd">    Args:</span>
<span class="sd">        folder_path (str): Path to the folder containing PDF files.</span>
<span class="sd">        ocr_service (str): OCR service to use (&quot;ocrspace&quot;, &quot;tesseract&quot;, &quot;paddleocr&quot;).</span>
<span class="sd">        lang (str): OCR language.</span>
<span class="sd">        simple_text (bool): If True, extract simple text.</span>
<span class="sd">        refine (str): AI refinement for generated messages (&quot;gemini&quot;, &quot;huggingface&quot;, or None).</span>
<span class="sd">        similarity_threshold (float): Threshold for considering two PDFs as similar (0-1).</span>
<span class="sd">        api_url (str): Canvas API base URL.</span>
<span class="sd">        api_key (str): Canvas API key.</span>
<span class="sd">        course_id (str): Canvas course ID.</span>
<span class="sd">        verbose (bool): If True, print more details; otherwise, print only important notice.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tuples: [(pdf1, pdf2, similarity), ...] for pairs above threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">assignment_name_guess</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">image_phash_threshold</span> <span class="o">=</span> <span class="mf">0.95</span>
    <span class="n">image_ssim_threshold</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">layout_threshold</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">shingle_threshold</span> <span class="o">=</span> <span class="mf">0.6</span>
    <span class="n">embedding_threshold</span> <span class="o">=</span> <span class="mf">0.8</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_metadata_from_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="c1"># Expected pattern: &lt;name&gt;_&lt;canvas_id&gt;_&lt;assignment_id&gt;_&lt;time&gt;_&lt;status&gt;.pdf</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">base</span><span class="p">,</span>
            <span class="s2">&quot;student_name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;canvas_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;assignment_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;submitted_at&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?P&lt;name&gt;.+)_(?P&lt;canvas_id&gt;</span><span class="se">\\</span><span class="s2">d+)_(?P&lt;assignment_id&gt;</span><span class="se">\\</span><span class="s2">d+)_(?P&lt;submitted&gt;[^_]+)_(?P&lt;status&gt;[^_]+)</span><span class="se">\\</span><span class="s2">.pdf$&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;student_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;canvas_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;canvas_id&quot;</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;assignment_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;assignment_id&quot;</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;submitted_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;submitted&quot;</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">meta</span>
        <span class="c1"># Fallback: try to infer a canvas id from numeric tokens</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">numeric</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">numeric</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;canvas_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numeric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;student_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">parts</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">meta</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_file_md5</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">):</span>
        <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_size</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">digest</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">digest</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_phash</span><span class="p">(</span><span class="n">gray_image</span><span class="p">):</span>
        <span class="c1"># Perceptual hash via DCT on a 32x32 grayscale image.</span>
        <span class="n">resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">gray_image</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dct</span><span class="p">(</span><span class="n">resized</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">dct_low</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[:</span><span class="mi">8</span><span class="p">,</span> <span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dct_low</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dct_low</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">dct_low</span> <span class="o">&gt;</span> <span class="n">median</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;1&quot;</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="s2">&quot;0&quot;</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bits</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_phash_similarity</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">h2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">h2</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c1</span> <span class="o">!=</span> <span class="n">c2</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">))</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">dist</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h1</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ssim</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">):</span>
        <span class="c1"># Basic SSIM on full-image statistics (fast, no sliding window).</span>
        <span class="n">img1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">img2</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.01</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.03</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">mu1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">mu2</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">sigma1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
        <span class="n">sigma2</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
        <span class="n">sigma12</span> <span class="o">=</span> <span class="p">((</span><span class="n">img1</span> <span class="o">-</span> <span class="n">mu1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img2</span> <span class="o">-</span> <span class="n">mu2</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">mu1</span> <span class="o">*</span> <span class="n">mu2</span> <span class="o">+</span> <span class="n">c1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma12</span> <span class="o">+</span> <span class="n">c2</span><span class="p">)</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">mu2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">c1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma1</span> <span class="o">+</span> <span class="n">sigma2</span> <span class="o">+</span> <span class="n">c2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">denominator</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_psnr</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">PSNR</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">img1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">-</span> <span class="n">img2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mse</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">255.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_layout_signature</span><span class="p">(</span><span class="n">pil_image</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="c1"># Layout signature based on OCR bounding boxes bucketed into a grid.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pytesseract</span><span class="o">.</span><span class="n">image_to_data</span><span class="p">(</span><span class="n">pil_image</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="n">pytesseract</span><span class="o">.</span><span class="n">Output</span><span class="o">.</span><span class="n">DICT</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">pil_image</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">width</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">cy</span> <span class="o">=</span> <span class="n">top</span> <span class="o">+</span> <span class="n">height</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">gx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">grid_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">cx</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid_size</span><span class="p">)))</span>
            <span class="n">gy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">grid_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">cy</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid_size</span><span class="p">)))</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">gy</span><span class="p">,</span> <span class="n">gx</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">vec</span> <span class="o">/</span> <span class="n">norm</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cosine_similarity_vector</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">vec1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">vec2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">denom</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_shingles</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">t</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">size</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span>

    <span class="n">pdf_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
    <span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pdf_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[PDFSimilarity] No PDF files found in the folder.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No PDF files found in the folder.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Collect file metadata and extract texts for all PDFs</span>
    <span class="n">file_metadata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">extracted_texts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pdf_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">pdf_files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Extracting texts from PDFs&quot;</span><span class="p">):</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">_extract_metadata_from_filename</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">)</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;size_bytes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_file_md5</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">PyPDF2</span><span class="o">.</span><span class="n">PdfReader</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;page_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;producer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/Producer&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Producer&quot;</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;creator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/Creator&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Creator&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;page_count&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">file_metadata</span><span class="p">[</span><span class="n">pdf_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">txt_path</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_text_</span><span class="si">{</span><span class="n">ocr_service</span><span class="si">}</span><span class="s2">.txt&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">txt_path</span><span class="p">):</span>
            <span class="n">txt_path</span> <span class="o">=</span> <span class="n">extract_text_from_scanned_pdf</span><span class="p">(</span>
                <span class="n">pdf_path</span><span class="p">,</span>
                <span class="n">txt_output_path</span><span class="o">=</span><span class="n">txt_path</span><span class="p">,</span>
                <span class="n">service</span><span class="o">=</span><span class="n">ocr_service</span><span class="p">,</span>
                <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">,</span>
                <span class="n">simple_text</span><span class="o">=</span><span class="n">simple_text</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">txt_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">txt_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1"># Normalize text: remove whitespace, lowercase</span>
            <span class="n">norm_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">extracted_texts</span><span class="p">[</span><span class="n">pdf_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extracted_texts</span><span class="p">[</span><span class="n">pdf_path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Prepare image-based features and layout signatures (first page only)</span>
    <span class="n">image_features</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pdf_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">pdf_files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Extracting image features&quot;</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">convert_from_path</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">,</span> <span class="n">first_page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">last_page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">images</span><span class="p">:</span>
                <span class="n">pil_image</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pil_image</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2GRAY</span><span class="p">)</span>
                <span class="n">resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
                <span class="n">features</span><span class="p">[</span><span class="s2">&quot;phash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_phash</span><span class="p">(</span><span class="n">gray</span><span class="p">)</span>
                <span class="n">features</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_layout_signature</span><span class="p">(</span><span class="n">pil_image</span><span class="p">)</span>
                <span class="n">features</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">image_features</span><span class="p">[</span><span class="n">pdf_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>

    <span class="c1"># Build shingle sets for text similarity</span>
    <span class="n">shingle_sets</span> <span class="o">=</span> <span class="p">{</span><span class="n">pdf_path</span><span class="p">:</span> <span class="n">_make_shingles</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">pdf_path</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">extracted_texts</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># Compare all pairs using multiple similarity metrics for better accuracy</span>

    <span class="n">similar_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pdf_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extracted_texts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># (pdf1, pdf2) -&gt; ratio</span>
    <span class="n">all_pairs_detail</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Prepare TF-IDF vectors for all texts</span>
    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">extracted_texts</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pdf_list</span><span class="p">]</span>
    <span class="n">tfidf_matrix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
        <span class="n">tfidf_vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
        <span class="n">tfidf_matrix</span> <span class="o">=</span> <span class="n">tfidf_vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>

    <span class="c1"># Optional sentence-embedding similarity (if sentence-transformers is installed)</span>
    <span class="n">embedding_vectors</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">embedding_method</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sentence_transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">SentenceTransformer</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s2">&quot;all-MiniLM-L6-v2&quot;</span><span class="p">)</span>
        <span class="n">embedding_vectors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">convert_to_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">embedding_method</span> <span class="o">=</span> <span class="s2">&quot;sentence_transformers/all-MiniLM-L6-v2&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">embedding_vectors</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Helper to compute Jaccard similarity</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">jaccard_similarity</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">set_a</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="n">set_b</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="n">set_a</span> <span class="o">&amp;</span> <span class="n">set_b</span>
        <span class="n">union</span> <span class="o">=</span> <span class="n">set_a</span> <span class="o">|</span> <span class="n">set_b</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">union</span><span class="p">)</span> <span class="k">if</span> <span class="n">union</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="c1"># Helper to compute Euclidean distance similarity (1 / (1 + distance))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">euclidean_similarity</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec1</span> <span class="o">-</span> <span class="n">vec2</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">dist</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pdf1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pdf_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf_list</span><span class="p">)):</span>
            <span class="n">pdf2</span> <span class="o">=</span> <span class="n">pdf_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">text1</span> <span class="o">=</span> <span class="n">extracted_texts</span><span class="p">[</span><span class="n">pdf1</span><span class="p">]</span>
            <span class="n">text2</span> <span class="o">=</span> <span class="n">extracted_texts</span><span class="p">[</span><span class="n">pdf2</span><span class="p">]</span>

            <span class="n">meta1</span> <span class="o">=</span> <span class="n">file_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">meta2</span> <span class="o">=</span> <span class="n">file_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf2</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">exact_hash</span> <span class="o">=</span> <span class="n">meta1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;md5&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">meta1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;md5&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">meta2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;md5&quot;</span><span class="p">)</span>

            <span class="c1"># Cosine similarity (TF-IDF)</span>
            <span class="k">if</span> <span class="n">tfidf_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">tfidf_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tfidf_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">euc_sim</span> <span class="o">=</span> <span class="n">euclidean_similarity</span><span class="p">(</span><span class="n">tfidf_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="n">tfidf_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cos_sim</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">euc_sim</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="c1"># Jaccard similarity</span>
            <span class="n">jac_sim</span> <span class="o">=</span> <span class="n">jaccard_similarity</span><span class="p">(</span><span class="n">text1</span><span class="p">,</span> <span class="n">text2</span><span class="p">)</span> <span class="k">if</span> <span class="n">text1</span> <span class="ow">and</span> <span class="n">text2</span> <span class="k">else</span> <span class="mf">0.0</span>

            <span class="c1"># SequenceMatcher similarity</span>
            <span class="n">seq_sim</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">text1</span><span class="p">,</span> <span class="n">text2</span><span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="k">if</span> <span class="n">text1</span> <span class="ow">and</span> <span class="n">text2</span> <span class="k">else</span> <span class="mf">0.0</span>

            <span class="c1"># Weighted average (can adjust weights as needed)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">cos_sim</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.25</span> <span class="o">*</span> <span class="n">jac_sim</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">seq_sim</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.15</span> <span class="o">*</span> <span class="n">euc_sim</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exact_hash</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># Image-based similarity (first page)</span>
            <span class="n">img1</span> <span class="o">=</span> <span class="n">image_features</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
            <span class="n">img2</span> <span class="o">=</span> <span class="n">image_features</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf2</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
            <span class="n">phash_sim</span> <span class="o">=</span> <span class="n">_phash_similarity</span><span class="p">(</span>
                <span class="n">image_features</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phash&quot;</span><span class="p">),</span>
                <span class="n">image_features</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf2</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phash&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">ssim_value</span> <span class="o">=</span> <span class="n">_ssim</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">)</span> <span class="k">if</span> <span class="n">img1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">img2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">psnr_value</span> <span class="o">=</span> <span class="n">_psnr</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">)</span> <span class="k">if</span> <span class="n">img1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">img2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="c1"># Layout-aware similarity</span>
            <span class="n">layout_sim</span> <span class="o">=</span> <span class="n">_cosine_similarity_vector</span><span class="p">(</span>
                <span class="n">image_features</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;layout&quot;</span><span class="p">),</span>
                <span class="n">image_features</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf2</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;layout&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># N-gram shingle similarity</span>
            <span class="n">shingle_sim</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">shingles1</span> <span class="o">=</span> <span class="n">shingle_sets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
            <span class="n">shingles2</span> <span class="o">=</span> <span class="n">shingle_sets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf2</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">shingles1</span> <span class="ow">and</span> <span class="n">shingles2</span><span class="p">:</span>
                <span class="n">shingle_sim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shingles1</span> <span class="o">&amp;</span> <span class="n">shingles2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shingles1</span> <span class="o">|</span> <span class="n">shingles2</span><span class="p">))</span>

            <span class="c1"># Embedding similarity (optional)</span>
            <span class="n">embed_sim</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">embedding_vectors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">embed_sim</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">embedding_vectors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">embedding_vectors</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

            <span class="c1"># Metadata match (does not trigger by itself)</span>
            <span class="n">meta_match</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">meta1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;producer&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">meta2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;producer&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">meta1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;producer&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">meta2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;producer&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">meta1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;creator&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">meta2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;creator&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">meta1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page_count&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">meta2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page_count&quot;</span><span class="p">):</span>
                    <span class="n">meta_match</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">all_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdf1</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdf2</span><span class="p">),</span> <span class="n">ratio</span><span class="p">))</span>
            <span class="n">similarity_matrix</span><span class="p">[(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ratio</span>
            <span class="n">similarity_matrix</span><span class="p">[(</span><span class="n">pdf2</span><span class="p">,</span> <span class="n">pdf1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ratio</span>
            <span class="n">text_flag</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span>
            <span class="n">image_phash_flag</span> <span class="o">=</span> <span class="n">phash_sim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">phash_sim</span> <span class="o">&gt;=</span> <span class="n">image_phash_threshold</span>
            <span class="n">image_ssim_flag</span> <span class="o">=</span> <span class="n">ssim_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ssim_value</span> <span class="o">&gt;=</span> <span class="n">image_ssim_threshold</span>
            <span class="n">layout_flag</span> <span class="o">=</span> <span class="n">layout_sim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">layout_sim</span> <span class="o">&gt;=</span> <span class="n">layout_threshold</span>
            <span class="n">shingle_flag</span> <span class="o">=</span> <span class="n">shingle_sim</span> <span class="o">&gt;=</span> <span class="n">shingle_threshold</span>
            <span class="n">embedding_flag</span> <span class="o">=</span> <span class="n">embed_sim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">embed_sim</span> <span class="o">&gt;=</span> <span class="n">embedding_threshold</span>

            <span class="c1"># Balanced rule: exact hash OR (text similarity + at least one image/layout signal).</span>
            <span class="n">flagged</span> <span class="o">=</span> <span class="n">exact_hash</span> <span class="ow">or</span> <span class="p">(</span><span class="n">text_flag</span> <span class="ow">and</span> <span class="p">(</span><span class="n">image_phash_flag</span> <span class="ow">or</span> <span class="n">image_ssim_flag</span> <span class="ow">or</span> <span class="n">layout_flag</span><span class="p">))</span>

            <span class="n">reasons</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">flagged</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exact_hash</span><span class="p">:</span>
                    <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;exact_hash&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">text_flag</span><span class="p">:</span>
                    <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;text_similarity&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">image_phash_flag</span><span class="p">:</span>
                    <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;image_phash&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">image_ssim_flag</span><span class="p">:</span>
                    <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;image_ssim&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">layout_flag</span><span class="p">:</span>
                    <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;layout_similarity&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shingle_flag</span><span class="p">:</span>
                    <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ngram_shingles&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">embedding_flag</span><span class="p">:</span>
                    <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;embedding_similarity&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">meta_match</span><span class="p">:</span>
                    <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;metadata_match&quot;</span><span class="p">)</span>
                <span class="n">similar_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdf1</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdf2</span><span class="p">),</span> <span class="n">ratio</span><span class="p">))</span>
            <span class="n">all_pairs_detail</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;pdf1&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdf1</span><span class="p">),</span>
                <span class="s2">&quot;pdf2&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdf2</span><span class="p">),</span>
                <span class="s2">&quot;ratio&quot;</span><span class="p">:</span> <span class="n">ratio</span><span class="p">,</span>
                <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;cosine&quot;</span><span class="p">:</span> <span class="n">cos_sim</span><span class="p">,</span>
                    <span class="s2">&quot;jaccard&quot;</span><span class="p">:</span> <span class="n">jac_sim</span><span class="p">,</span>
                    <span class="s2">&quot;sequence&quot;</span><span class="p">:</span> <span class="n">seq_sim</span><span class="p">,</span>
                    <span class="s2">&quot;euclidean&quot;</span><span class="p">:</span> <span class="n">euc_sim</span><span class="p">,</span>
                    <span class="s2">&quot;phash_similarity&quot;</span><span class="p">:</span> <span class="n">phash_sim</span><span class="p">,</span>
                    <span class="s2">&quot;ssim&quot;</span><span class="p">:</span> <span class="n">ssim_value</span><span class="p">,</span>
                    <span class="s2">&quot;psnr&quot;</span><span class="p">:</span> <span class="n">psnr_value</span><span class="p">,</span>
                    <span class="s2">&quot;layout_similarity&quot;</span><span class="p">:</span> <span class="n">layout_sim</span><span class="p">,</span>
                    <span class="s2">&quot;shingle_jaccard&quot;</span><span class="p">:</span> <span class="n">shingle_sim</span><span class="p">,</span>
                    <span class="s2">&quot;embedding_cosine&quot;</span><span class="p">:</span> <span class="n">embed_sim</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;exact_hash&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">exact_hash</span><span class="p">),</span>
                <span class="s2">&quot;metadata_match&quot;</span><span class="p">:</span> <span class="n">meta_match</span><span class="p">,</span>
                <span class="s2">&quot;reasons&quot;</span><span class="p">:</span> <span class="n">reasons</span><span class="p">,</span>
            <span class="p">})</span>

    <span class="c1"># Save results to file in the same folder</span>
    <span class="n">result_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="s2">&quot;pdf_similarity_results.txt&quot;</span><span class="p">)</span>
    <span class="n">status_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="s2">&quot;pdf_similarity_status.json&quot;</span><span class="p">)</span>
    <span class="n">report_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="s2">&quot;pdf_similarity_report.json&quot;</span><span class="p">)</span>

    <span class="c1"># Load previous status if exists</span>
    <span class="n">sent_status</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">status_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">sent_status</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">sent_status</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Helper to create a unique key for a pair (order-independent)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pair_key</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;||&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">pdf1</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">pdf2</span><span class="o">.</span><span class="n">lower</span><span class="p">()]))</span>

    <span class="c1"># Save results to txt</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;PDF similarity comparison results:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">all_pairs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">mark</span> <span class="o">=</span> <span class="s2">&quot; &lt;== HIGH SIMILARITY&quot;</span> <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">pair_key</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">)</span>
                <span class="n">msg_status</span> <span class="o">=</span> <span class="n">sent_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;NOT_SENT&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">: similarity = </span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}{</span><span class="n">mark</span><span class="si">}</span><span class="s2"> [Message: </span><span class="si">{</span><span class="n">msg_status</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No PDF pairs to compare.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">similar_pairs</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">PDF pairs with high similarity (&gt;= </span><span class="si">{:.2f}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">similarity_threshold</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">similar_pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">pair_key</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">)</span>
                <span class="n">msg_status</span> <span class="o">=</span> <span class="n">sent_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;NOT_SENT&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">: similarity = </span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> [Message: </span><span class="si">{</span><span class="n">msg_status</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No highly similar PDF pairs found.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Comparison results saved to </span><span class="si">{</span><span class="n">result_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Comparison results saved to </span><span class="si">{</span><span class="n">result_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">pair_details_by_key</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">pair_key</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;pdf1&quot;</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;pdf2&quot;</span><span class="p">]):</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">all_pairs_detail</span>
    <span class="p">}</span>

    <span class="c1"># Cluster detection for groups of similar submissions</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_clusters</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">union</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ra</span> <span class="o">!=</span> <span class="n">rb</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">[</span><span class="n">rb</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span>

        <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reasons&quot;</span><span class="p">):</span>
                <span class="n">union</span><span class="p">(</span><span class="n">detail</span><span class="p">[</span><span class="s2">&quot;pdf1&quot;</span><span class="p">],</span> <span class="n">detail</span><span class="p">[</span><span class="s2">&quot;pdf2&quot;</span><span class="p">])</span>

        <span class="n">clusters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">detail</span><span class="p">[</span><span class="s2">&quot;pdf1&quot;</span><span class="p">],</span> <span class="n">detail</span><span class="p">[</span><span class="s2">&quot;pdf2&quot;</span><span class="p">]):</span>
                <span class="n">root</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">clusters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">members</span><span class="p">))</span> <span class="k">for</span> <span class="n">members</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="n">_build_clusters</span><span class="p">(</span><span class="n">all_pairs_detail</span><span class="p">)</span>

    <span class="c1"># Save a structured report for downstream processing</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">report_payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;generated_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="n">similarity_threshold</span><span class="p">,</span>
            <span class="s2">&quot;assignment_name&quot;</span><span class="p">:</span> <span class="n">assignment_name_guess</span><span class="p">,</span>
            <span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;text_similarity_threshold&quot;</span><span class="p">:</span> <span class="n">similarity_threshold</span><span class="p">,</span>
                <span class="s2">&quot;image_phash_threshold&quot;</span><span class="p">:</span> <span class="n">image_phash_threshold</span><span class="p">,</span>
                <span class="s2">&quot;image_ssim_threshold&quot;</span><span class="p">:</span> <span class="n">image_ssim_threshold</span><span class="p">,</span>
                <span class="s2">&quot;layout_threshold&quot;</span><span class="p">:</span> <span class="n">layout_threshold</span><span class="p">,</span>
                <span class="s2">&quot;shingle_threshold&quot;</span><span class="p">:</span> <span class="n">shingle_threshold</span><span class="p">,</span>
                <span class="s2">&quot;embedding_threshold&quot;</span><span class="p">:</span> <span class="n">embedding_threshold</span><span class="p">,</span>
                <span class="s2">&quot;embedding_method&quot;</span><span class="p">:</span> <span class="n">embedding_method</span><span class="p">,</span>
                <span class="s2">&quot;flag_rule&quot;</span><span class="p">:</span> <span class="s2">&quot;exact_hash OR (text_similarity AND (image_phash OR image_ssim OR layout_similarity))&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">file_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
            <span class="s2">&quot;pairs&quot;</span><span class="p">:</span> <span class="n">all_pairs_detail</span><span class="p">,</span>
            <span class="s2">&quot;high_similarity&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">all_pairs_detail</span>
                <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;reasons&quot;</span><span class="p">]</span>
            <span class="p">],</span>
            <span class="s2">&quot;clusters&quot;</span><span class="p">:</span> <span class="n">clusters</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">report_payload</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Report saved to </span><span class="si">{</span><span class="n">report_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Failed to save report JSON: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">similar_pairs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[PDFSimilarity] PDF pairs with high similarity:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">similar_pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">pair_key</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">)</span>
                <span class="n">msg_status</span> <span class="o">=</span> <span class="n">sent_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;NOT_SENT&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">: similarity = </span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> [Message: </span><span class="si">{</span><span class="n">msg_status</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PDF pairs with high similarity found.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[PDFSimilarity] No highly similar PDF pairs found.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No highly similar PDF pairs found.&quot;</span><span class="p">)</span>

    <span class="c1"># Update local database with similarity flags if possible</span>
    <span class="k">if</span> <span class="n">db_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">db_path</span> <span class="o">=</span> <span class="n">get_default_db_path</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">db_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">similar_pairs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">students</span> <span class="o">=</span> <span class="n">load_database</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">sid_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">name_map</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_norm_name</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">students</span><span class="p">:</span>
                <span class="n">canvas_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Canvas ID&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sid_map</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">s</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">name_map</span><span class="p">[</span><span class="n">_norm_name</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">s</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_student</span><span class="p">(</span><span class="n">meta</span><span class="p">):</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;canvas_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sid</span> <span class="ow">and</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">sid_map</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">sid_map</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                <span class="n">name_key</span> <span class="o">=</span> <span class="n">_norm_name</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;student_name&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">name_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name_key</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_pair_key</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;||&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]))</span>

            <span class="k">for</span> <span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">similar_pairs</span><span class="p">:</span>
                <span class="n">meta1</span> <span class="o">=</span> <span class="n">file_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">pdf1</span><span class="p">),</span> <span class="n">file_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="p">{}))</span>
                <span class="n">meta2</span> <span class="o">=</span> <span class="n">file_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">),</span> <span class="n">file_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf2</span><span class="p">,</span> <span class="p">{}))</span>
                <span class="n">student1</span> <span class="o">=</span> <span class="n">_resolve_student</span><span class="p">(</span><span class="n">meta1</span><span class="p">)</span>
                <span class="n">student2</span> <span class="o">=</span> <span class="n">_resolve_student</span><span class="p">(</span><span class="n">meta2</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">student1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">student2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">pair_key</span> <span class="o">=</span> <span class="n">_pair_key</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">)</span>
                <span class="n">detail</span> <span class="o">=</span> <span class="n">pair_details_by_key</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair_key</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">reasons</span> <span class="o">=</span> <span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reasons&quot;</span><span class="p">,</span> <span class="p">[])</span>

                <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;pair_key&quot;</span><span class="p">:</span> <span class="n">pair_key</span><span class="p">,</span>
                    <span class="s2">&quot;other_file&quot;</span><span class="p">:</span> <span class="n">pdf2</span><span class="p">,</span>
                    <span class="s2">&quot;similarity&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="s2">&quot;reasons&quot;</span><span class="p">:</span> <span class="n">reasons</span><span class="p">,</span>
                    <span class="s2">&quot;report_path&quot;</span><span class="p">:</span> <span class="n">report_path</span><span class="p">,</span>
                    <span class="s2">&quot;assignment_id&quot;</span><span class="p">:</span> <span class="n">meta1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">meta2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment_id&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;assignment_name&quot;</span><span class="p">:</span> <span class="n">assignment_name_guess</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">entry_other</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;pair_key&quot;</span><span class="p">:</span> <span class="n">pair_key</span><span class="p">,</span>
                    <span class="s2">&quot;other_file&quot;</span><span class="p">:</span> <span class="n">pdf1</span><span class="p">,</span>
                    <span class="s2">&quot;similarity&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="s2">&quot;reasons&quot;</span><span class="p">:</span> <span class="n">reasons</span><span class="p">,</span>
                    <span class="s2">&quot;report_path&quot;</span><span class="p">:</span> <span class="n">report_path</span><span class="p">,</span>
                    <span class="s2">&quot;assignment_id&quot;</span><span class="p">:</span> <span class="n">meta1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">meta2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment_id&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;assignment_name&quot;</span><span class="p">:</span> <span class="n">assignment_name_guess</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="k">for</span> <span class="n">student</span><span class="p">,</span> <span class="n">payload</span> <span class="ow">in</span> <span class="p">((</span><span class="n">student1</span><span class="p">,</span> <span class="n">entry</span><span class="p">),</span> <span class="p">(</span><span class="n">student2</span><span class="p">,</span> <span class="n">entry_other</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">student</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">&quot;Plagiarism Matches&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">existing</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">existing</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pair_key&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">pair_key</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                        <span class="n">existing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">&quot;Plagiarism Matches&quot;</span><span class="p">,</span> <span class="n">existing</span><span class="p">)</span>

            <span class="n">save_database</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Saved plagiarism flags to database: </span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Failed to update database: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Only send messages for pairs that have not been sent before</span>
    <span class="n">pairs_to_notify</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">similar_pairs</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">pair_key</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sent_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;NOT_SENT&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;SENT&quot;</span><span class="p">:</span>
            <span class="n">pairs_to_notify</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">,</span> <span class="n">ratio</span><span class="p">))</span>

    <span class="c1"># If there are highly similar pairs to notify, send a separate message for each pair</span>
    <span class="k">if</span> <span class="n">pairs_to_notify</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[PDFSimilarity] Sending messages to students involved in newly detected highly similar submissions (one message per pair)...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sending messages to students involved in highly similar submissions...&quot;</span><span class="p">)</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>

        <span class="c1"># Helper to extract Canvas ID from filename</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">extract_canvas_id_from_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Ask user if they want to refine the message via AI if refine is None</span>
        <span class="k">if</span> <span class="n">refine</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">auto_send</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="c1"># Use signal.SIGALRM only if available (not on Windows)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">default</span>
                        <span class="k">return</span> <span class="n">result</span>
                    <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">default</span>
                        <span class="k">raise</span>
                    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Fallback for platforms without SIGALRM (e.g., Windows)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">default</span>
                        <span class="k">return</span> <span class="n">result</span>
                    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                        <span class="k">raise</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">refine_choice</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                    <span class="s2">&quot;Do you want to refine the message via AI? (none/gemini/huggingface/local) [none]: &quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">refine_choice</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;gemini&quot;</span><span class="p">,</span> <span class="s2">&quot;huggingface&quot;</span><span class="p">):</span>
                    <span class="n">refine</span> <span class="o">=</span> <span class="n">refine_choice</span> <span class="k">if</span> <span class="n">refine_choice</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[PDFSimilarity] Invalid choice. Using default &#39;none&#39;.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid choice. Using default &#39;none&#39;.&quot;</span><span class="p">)</span>
                    <span class="n">refine</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[PDFSimilarity] No response after 60 seconds. Using default &#39;none&#39;.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No response after 60 seconds. Using default &#39;none&#39;.&quot;</span><span class="p">)</span>
                <span class="n">refine</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">refine</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">auto_send</span><span class="p">:</span>
            <span class="n">refine</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">pairs_to_notify</span><span class="p">:</span>
            <span class="n">canvas_id1</span> <span class="o">=</span> <span class="n">extract_canvas_id_from_filename</span><span class="p">(</span><span class="n">pdf1</span><span class="p">)</span>
            <span class="n">canvas_id2</span> <span class="o">=</span> <span class="n">extract_canvas_id_from_filename</span><span class="p">(</span><span class="n">pdf2</span><span class="p">)</span>
            <span class="n">recipients</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">canvas_id1</span><span class="p">:</span>
                <span class="n">recipients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">canvas_id1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">canvas_id2</span> <span class="ow">and</span> <span class="n">canvas_id2</span> <span class="o">!=</span> <span class="n">canvas_id1</span><span class="p">:</span>
                <span class="n">recipients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">canvas_id2</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">recipients</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Could not extract Canvas IDs from </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">. Skipping message.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract Canvas IDs from </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">. Skipping message.&quot;</span><span class="p">)</span>
                <span class="n">sent_status</span><span class="p">[</span><span class="n">pair_key</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>
                <span class="k">continue</span>

            <span class="n">detail</span> <span class="o">=</span> <span class="n">pair_details_by_key</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair_key</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">),</span> <span class="p">{})</span>
            <span class="n">reasons</span> <span class="o">=</span> <span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reasons&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metrics&quot;</span><span class="p">,</span> <span class="p">{})</span>

            <span class="n">method_descriptions</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;exact_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;Exact file hash match&quot;</span><span class="p">,</span>
                <span class="s2">&quot;text_similarity&quot;</span><span class="p">:</span> <span class="s2">&quot;Text similarity (TF-IDF/sequence)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;image_phash&quot;</span><span class="p">:</span> <span class="s2">&quot;Perceptual image hash match&quot;</span><span class="p">,</span>
                <span class="s2">&quot;image_ssim&quot;</span><span class="p">:</span> <span class="s2">&quot;Image structural similarity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;layout_similarity&quot;</span><span class="p">:</span> <span class="s2">&quot;Layout similarity from OCR bounding boxes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ngram_shingles&quot;</span><span class="p">:</span> <span class="s2">&quot;N-gram shingle overlap&quot;</span><span class="p">,</span>
                <span class="s2">&quot;embedding_similarity&quot;</span><span class="p">:</span> <span class="s2">&quot;Embedding similarity (if available)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;metadata_match&quot;</span><span class="p">:</span> <span class="s2">&quot;PDF metadata match (producer/creator/pages)&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">methods_used</span> <span class="o">=</span> <span class="p">[</span><span class="n">method_descriptions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reasons</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">methods_used</span><span class="p">:</span>
                <span class="n">methods_used</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Text similarity (TF-IDF/sequence)&quot;</span><span class="p">]</span>
            <span class="n">method_block</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">methods_used</span><span class="p">])</span>

            <span class="c1"># Generate message for this pair</span>
            <span class="n">similarity_results</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">: similarity = </span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">metrics_summary</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;TF-IDF cosine: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Jaccard: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jaccard&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Sequence: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sequence&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Image pHash: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phash_similarity&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;SSIM: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ssim&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Layout: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;layout_similarity&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Shingles: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shingle_jaccard&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Embedding: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;embedding_cosine&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">refine</span> <span class="ow">in</span> <span class="n">ALL_AI_METHODS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Generating message using AI service: </span><span class="si">{</span><span class="n">refine</span><span class="si">}</span><span class="s2"> for pair </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating message using AI service: </span><span class="si">{</span><span class="n">refine</span><span class="si">}</span><span class="s2"> for pair </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;You are an expert assistant. Compose a clear, formal, and professional message in Vietnamese to notify students &quot;</span>
                    <span class="s2">&quot;about potential similarity detected in their submissions by the system. The message should include the following points:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;1. Provide the similarity results, listing the pair of submissions with their similarity score.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;2. Explain the methods used (text similarity, image similarity, layout similarity, n-gram overlap, metadata match, optional embedding similarity).</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;3. Emphasize that automated detection can produce false positives and the case will be reviewed by lecturers and TAs before any final decision.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;4. Ask students to wait for review or respond if they believe the detection is incorrect.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Ensure the message is complete, concise, and does not require any additional edits or replacements.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Similarity result:</span><span class="se">\n</span><span class="si">{text}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Methods:</span><span class="se">\n</span><span class="si">{methods}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Metrics:</span><span class="se">\n</span><span class="si">{metrics}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">refine_text_with_ai</span><span class="p">(</span>
                    <span class="n">similarity_results</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span>
                    <span class="n">user_prompt</span><span class="o">=</span><span class="n">prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">similarity_results</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">method_block</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics_summary</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Potential similarity detected by automated checks for the following submissions:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="n">similarity_results</span> <span class="o">+</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Assignment: &quot;</span>
                    <span class="o">+</span> <span class="n">assignment_name_guess</span> <span class="o">+</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Methods used:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="n">method_block</span> <span class="o">+</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Metrics:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="n">metrics_summary</span> <span class="o">+</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Note: Automated detection can produce false positives (OCR errors, formatting differences, or similar templates). &quot;</span>
                    <span class="s2">&quot;This case will be reviewed by the lecturers and TAs before any final decision. &quot;</span>
                    <span class="s2">&quot;If you believe this detection is incorrect, you may respond with clarification.&quot;</span>
                <span class="p">)</span>

            <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Notice: Potential similarity detected in submissions&quot;</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Subject:</span><span class="se">\n</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Message for </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prepared message for </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_send</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Only use SIGALRM if available (not on Windows)</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
                            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
                            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># 60 second timeout</span>
                            <span class="n">confirm</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Do you want to send this message for </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">? (y/n, or &#39;r&#39; to regenerate, default &#39;y&#39; in 60s): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Cancel the alarm</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Fallback for Windows (no timeout)</span>
                            <span class="n">confirm</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Do you want to send this message for </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">? (y/n, or &#39;r&#39; to regenerate): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">:</span>
                                <span class="n">confirm</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>  <span class="c1"># Default value</span>

                        <span class="k">if</span> <span class="n">confirm</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span> <span class="ow">or</span> <span class="n">confirm</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="n">confirm</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Message sending canceled for this pair.&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Message sending canceled for this pair.&quot;</span><span class="p">)</span>
                            <span class="n">sent_status</span><span class="p">[</span><span class="n">pair_key</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;SKIPPED&quot;</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="n">confirm</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Regenerating message...&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regenerating message...&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">refine</span> <span class="ow">in</span> <span class="n">ALL_AI_METHODS</span><span class="p">:</span>
                                <span class="n">message</span> <span class="o">=</span> <span class="n">refine_text_with_ai</span><span class="p">(</span><span class="n">similarity_results</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="s2">&quot;Potential similarity detected by automated checks for the following submissions:</span><span class="se">\n</span><span class="s2">&quot;</span>
                                    <span class="o">+</span> <span class="n">similarity_results</span> <span class="o">+</span>
                                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Assignment: &quot;</span>
                                    <span class="o">+</span> <span class="n">assignment_name_guess</span> <span class="o">+</span>
                                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Methods used:</span><span class="se">\n</span><span class="s2">&quot;</span>
                                    <span class="o">+</span> <span class="n">method_block</span> <span class="o">+</span>
                                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Metrics:</span><span class="se">\n</span><span class="s2">&quot;</span>
                                    <span class="o">+</span> <span class="n">metrics_summary</span> <span class="o">+</span>
                                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Note: Automated detection can produce false positives (OCR errors, formatting differences, or similar templates). &quot;</span>
                                    <span class="s2">&quot;This case will be reviewed by the lecturers and TAs before any final decision. &quot;</span>
                                    <span class="s2">&quot;If you believe this detection is incorrect, you may respond with clarification.&quot;</span>
                                <span class="p">)</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Regenerated Message:</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regenerated message.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[PDFSimilarity] Invalid input. Please enter &#39;y&#39;, &#39;n&#39;, or &#39;r&#39;.&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid input. Please enter &#39;y&#39;, &#39;n&#39;, or &#39;r&#39;.&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[PDFSimilarity] No response after 60 seconds, using default &#39;y&#39;.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No response after 60 seconds, using default &#39;y&#39;.&quot;</span><span class="p">)</span>
                        <span class="k">break</span>  <span class="c1"># Use default &#39;y&#39; option and break the loop</span>

            <span class="k">if</span> <span class="n">sent_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair_key</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;SKIPPED&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">canvas</span><span class="o">.</span><span class="n">create_conversation</span><span class="p">(</span>
                    <span class="n">recipients</span><span class="o">=</span><span class="n">recipients</span><span class="p">,</span>
                    <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
                    <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                    <span class="n">force_new</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Message sent successfully to students for </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message sent for </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">sent_status</span><span class="p">[</span><span class="n">pair_key</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;SENT&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Failed to send message for </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send message for </span><span class="si">{</span><span class="n">pdf1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pdf2</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sent_status</span><span class="p">[</span><span class="n">pair_key</span><span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>

        <span class="c1"># Save updated status to JSON</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sent_status</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Message status saved to </span><span class="si">{</span><span class="n">status_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Failed to save message status: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save message status: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Save status file even if nothing to send, to keep track</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sent_status</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Message status saved to </span><span class="si">{</span><span class="n">status_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PDFSimilarity] Failed to save message status: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save message status: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">similar_pairs</span></div>


<div class="viewcode-block" id="detect_meaningful_level_and_notify_students">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.detect_meaningful_level_and_notify_students">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">detect_meaningful_level_and_notify_students</span><span class="p">(</span>
    <span class="n">folder_path</span><span class="p">,</span>
    <span class="n">assignment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ocr_service</span><span class="o">=</span><span class="n">DEFAULT_OCR_METHOD</span><span class="p">,</span>
    <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">simple_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">refine</span><span class="o">=</span><span class="n">DEFAULT_AI_METHOD</span><span class="p">,</span>
    <span class="n">meaningfulness_threshold</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">auto_send</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect the meaningful level of extracted texts from PDFs in a folder using AI agent.</span>
<span class="sd">    If the meaningful level is too low, generate a message via AI and send it to the student</span>
<span class="sd">    asking them to reformat and resubmit their submissions.</span>

<span class="sd">    Args:</span>
<span class="sd">        folder_path (str): Path to the folder containing PDF files.</span>
<span class="sd">        assignment_id (str): Canvas assignment ID for sending messages.</span>
<span class="sd">        ocr_service (str): OCR service to use (&quot;ocrspace&quot;, &quot;tesseract&quot;, &quot;paddleocr&quot;).</span>
<span class="sd">        lang (str): OCR language.</span>
<span class="sd">        simple_text (bool): If True, extract simple text.</span>
<span class="sd">        refine (str): AI refinement (&quot;gemini&quot;, &quot;huggingface&quot;, or None).</span>
<span class="sd">        meaningfulness_threshold (float): Threshold for considering text as meaningful (0-1).</span>
<span class="sd">        api_url, api_key, course_id: Canvas API configuration.</span>
<span class="sd">        verbose (bool): If True, print more details; otherwise, print only important notice.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict with results: {filename: {&quot;meaningful_score&quot;: score, &quot;message_sent&quot;: bool}, ...}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout_default</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use signal.SIGALRM only if available (not on Windows)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Meaningfulness] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Meaningfulness] No response after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds, using default &#39;</span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No response after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds, using default &#39;</span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Meaningfulness] Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback for platforms without SIGALRM (e.g., Windows)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Meaningfulness] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Meaningfulness] Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

    <span class="n">pdf_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
    <span class="p">])</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pdf_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Meaningfulness] No PDF files found in the folder.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No PDF files found in the folder.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">status_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="s2">&quot;meaningfulness_status.json&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">status_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">sent_status</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">sent_status</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sent_status</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">refine</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">auto_send</span><span class="p">:</span>
        <span class="n">refine</span> <span class="o">=</span> <span class="n">get_input_with_timeout_default</span><span class="p">(</span>
            <span class="s2">&quot;Which AI model do you want to use for meaningfulness analysis? (gemini/huggingface/local, default &#39;gemini&#39; in 60s): &quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;gemini&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">refine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALL_AI_METHODS</span><span class="p">:</span>
            <span class="n">refine</span> <span class="o">=</span> <span class="s2">&quot;gemini&quot;</span>
    <span class="k">elif</span> <span class="n">refine</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">auto_send</span><span class="p">:</span>
        <span class="n">refine</span> <span class="o">=</span> <span class="n">DEFAULT_AI_METHOD</span> <span class="ow">or</span> <span class="kc">None</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">low_quality_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">text_lengths</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">extracted_texts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pdf_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">pdf_files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Extracting texts from PDFs&quot;</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">txt_path</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_text_</span><span class="si">{</span><span class="n">ocr_service</span><span class="si">}</span><span class="s2">.txt&quot;</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">sent_status</span> <span class="ow">and</span> <span class="s2">&quot;meaningful_score&quot;</span> <span class="ow">in</span> <span class="n">sent_status</span><span class="p">[</span><span class="n">filename</span><span class="p">]:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;meaningful_score&quot;</span><span class="p">:</span> <span class="n">sent_status</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meaningful_score&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="s2">&quot;message_sent&quot;</span><span class="p">:</span> <span class="n">sent_status</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_sent&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">sent_status</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="s2">&quot;text_length&quot;</span> <span class="ow">in</span> <span class="n">sent_status</span><span class="p">[</span><span class="n">filename</span><span class="p">]:</span>
                <span class="n">text_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sent_status</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;text_length&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">txt_path</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">text_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">txt_path</span><span class="p">):</span>
            <span class="n">txt_path</span> <span class="o">=</span> <span class="n">extract_text_from_scanned_pdf</span><span class="p">(</span>
                <span class="n">pdf_path</span><span class="p">,</span>
                <span class="n">txt_output_path</span><span class="o">=</span><span class="n">txt_path</span><span class="p">,</span>
                <span class="n">service</span><span class="o">=</span><span class="n">ocr_service</span><span class="p">,</span>
                <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">,</span>
                <span class="n">simple_text</span><span class="o">=</span><span class="n">simple_text</span><span class="p">,</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">txt_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">txt_path</span><span class="p">):</span>
            <span class="n">results</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;meaningful_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;message_sent&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Failed to extract text&quot;</span><span class="p">}</span>
            <span class="n">sent_status</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
            <span class="k">continue</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        
        <span class="n">extracted_texts</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
        <span class="n">text_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>

    <span class="n">average_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">text_lengths</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_lengths</span><span class="p">)</span> <span class="k">if</span> <span class="n">text_lengths</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Meaningfulness] Average text length: </span><span class="si">{</span><span class="n">average_length</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> characters&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average text length: </span><span class="si">{</span><span class="n">average_length</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> characters&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">extracted_texts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Analyzing PDF meaningfulness&quot;</span><span class="p">):</span>
        <span class="n">meaningful_score</span> <span class="o">=</span> <span class="n">analyze_text_meaningfulness</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">refine</span><span class="p">,</span> <span class="n">average_length</span><span class="p">)</span>
        <span class="c1"># Store diagnostic metrics so the report can show why a file was flagged.</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">_compute_text_quality_metrics</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">issues</span> <span class="o">=</span> <span class="n">_summarize_quality_issues</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">average_length</span><span class="o">=</span><span class="n">average_length</span><span class="p">)</span>
        <span class="n">already_sent</span> <span class="o">=</span> <span class="n">sent_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_sent&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;meaningful_score&quot;</span><span class="p">:</span> <span class="n">meaningful_score</span><span class="p">,</span>
            <span class="s2">&quot;message_sent&quot;</span><span class="p">:</span> <span class="n">already_sent</span><span class="p">,</span>
            <span class="s2">&quot;text_length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
            <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="n">issues</span><span class="p">,</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;vn_char_ratio&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;vn_char_ratio&quot;</span><span class="p">],</span>
                <span class="s2">&quot;alnum_ratio&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;alnum_ratio&quot;</span><span class="p">],</span>
                <span class="s2">&quot;symbol_ratio&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;symbol_ratio&quot;</span><span class="p">],</span>
                <span class="s2">&quot;unique_char_ratio&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;unique_char_ratio&quot;</span><span class="p">],</span>
                <span class="s2">&quot;repeat_char_ratio&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;repeat_char_ratio&quot;</span><span class="p">],</span>
                <span class="s2">&quot;line_empty_ratio&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;line_empty_ratio&quot;</span><span class="p">],</span>
                <span class="s2">&quot;likely_math&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;likely_math&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">sent_status</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">meaningful_score</span> <span class="o">&lt;</span> <span class="n">meaningfulness_threshold</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">already_sent</span><span class="p">:</span>
            <span class="n">low_quality_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filename</span><span class="p">,</span> <span class="n">meaningful_score</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
    
    <span class="n">result_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="s2">&quot;meaningfulness_analysis.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;PDF meaningfulness analysis results:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Threshold: </span><span class="si">{</span><span class="n">meaningfulness_threshold</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average text length: </span><span class="si">{</span><span class="n">average_length</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> characters</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis date: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">total_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">low_quality_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;meaningful_score&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">meaningfulness_threshold</span><span class="p">)</span>
        <span class="n">acceptable_count</span> <span class="o">=</span> <span class="n">total_files</span> <span class="o">-</span> <span class="n">low_quality_count</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summary:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total files analyzed: </span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Acceptable quality: </span><span class="si">{</span><span class="n">acceptable_count</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Low quality: </span><span class="si">{</span><span class="n">low_quality_count</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Detailed results:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;meaningful_score&quot;</span><span class="p">]</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;LOW QUALITY&quot;</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">meaningfulness_threshold</span> <span class="k">else</span> <span class="s2">&quot;ACCEPTABLE&quot;</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">text_length</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text_length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">length_ratio</span> <span class="o">=</span> <span class="n">text_length</span> <span class="o">/</span> <span class="n">average_length</span> <span class="k">if</span> <span class="n">average_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">msg_status</span> <span class="o">=</span> <span class="s2">&quot;SENT&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_sent&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;NOT_SENT&quot;</span>
            <span class="n">issues</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issues&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metrics&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">issues_text</span> <span class="o">=</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span> <span class="k">if</span> <span class="n">issues</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: score = </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">), length = </span><span class="si">{</span><span class="n">text_length</span><span class="si">}</span><span class="s2"> chars (</span><span class="si">{</span><span class="n">length_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x avg), message: </span><span class="si">{</span><span class="n">msg_status</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; - ERROR: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Issues: </span><span class="si">{</span><span class="n">issues_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="c1"># Keep metrics on one line to simplify manual scanning.</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  Metrics: &quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;vn_ratio=</span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vn_char_ratio&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, alnum=</span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alnum_ratio&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;symbol=</span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol_ratio&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, unique=</span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unique_char_ratio&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;repeat=</span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repeat_char_ratio&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, empty_lines=</span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;line_empty_ratio&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;likely_math=</span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;likely_math&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">low_quality_files</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Low quality files requiring attention (&lt; </span><span class="si">{</span><span class="n">meaningfulness_threshold</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">low_quality_files</span><span class="p">:</span>
                <span class="n">text_length</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text_length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">length_ratio</span> <span class="o">=</span> <span class="n">text_length</span> <span class="o">/</span> <span class="n">average_length</span> <span class="k">if</span> <span class="n">average_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">msg_status</span> <span class="o">=</span> <span class="s2">&quot;SENT&quot;</span> <span class="k">if</span> <span class="n">sent_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_sent&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;NOT_SENT&quot;</span>
                <span class="n">issues</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issues&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">issues_text</span> <span class="o">=</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span> <span class="k">if</span> <span class="n">issues</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: score = </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, length = </span><span class="si">{</span><span class="n">text_length</span><span class="si">}</span><span class="s2"> chars (</span><span class="si">{</span><span class="n">length_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x avg), message: </span><span class="si">{</span><span class="n">msg_status</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Issues: </span><span class="si">{</span><span class="n">issues_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Meaningfulness] Analysis results saved to </span><span class="si">{</span><span class="n">result_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis results saved to </span><span class="si">{</span><span class="n">result_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sent_status</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">low_quality_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Meaningfulness] Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">low_quality_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> low quality submissions (not yet notified):&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">low_quality_files</span><span class="p">:</span>
                <span class="n">text_length</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text_length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">length_ratio</span> <span class="o">=</span> <span class="n">text_length</span> <span class="o">/</span> <span class="n">average_length</span> <span class="k">if</span> <span class="n">average_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: score = </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, length = </span><span class="si">{</span><span class="n">text_length</span><span class="si">}</span><span class="s2"> chars (</span><span class="si">{</span><span class="n">length_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x avg)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">low_quality_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> low quality submissions (not yet notified).&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_send</span><span class="p">:</span>
            <span class="n">send_messages</span> <span class="o">=</span> <span class="n">get_input_with_timeout_default</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Do you want to send messages to students with low quality submissions? (y/n, or &#39;q&#39; to quit, default &#39;y&#39; in 60s): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;y&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">send_messages</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sent_status</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
            <span class="k">if</span> <span class="n">send_messages</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Meaningfulness] Messages not sent.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Messages not sent.&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sent_status</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
            <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">low_quality_files</span><span class="p">:</span>
                <span class="n">canvas_id</span> <span class="o">=</span> <span class="n">extract_canvas_id_from_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">canvas_id</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Meaningfulness] Could not extract Canvas ID from </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract Canvas ID from </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">generate_low_quality_message</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">refine</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Meaningfulness] Subject: </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Meaningfulness] Message to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Prepared message for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_send</span><span class="p">:</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">action</span> <span class="o">=</span> <span class="n">get_input_with_timeout_default</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">What would you like to do? (s)end, (r)egenerate, or (q)uit [default: s in 60s]: &quot;</span><span class="p">,</span>
                            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;s&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Meaningfulness] Quitting message sending.&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting message sending.&quot;</span><span class="p">)</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sent_status</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">results</span>
                        <span class="k">elif</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;send&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;regenerate&#39;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Meaningfulness] Regenerating message...&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regenerating message...&quot;</span><span class="p">)</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="n">generate_low_quality_message</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">refine</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Meaningfulness] Regenerated message:&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regenerated message.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Meaningfulness] Please enter &#39;s&#39; to send, &#39;r&#39; to regenerate, or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please enter &#39;s&#39; to send, &#39;r&#39; to regenerate, or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">canvas</span><span class="o">.</span><span class="n">create_conversation</span><span class="p">(</span>
                        <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)],</span>
                        <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Yu cu nh dng li v np li bi tp&quot;</span><span class="p">,</span>
                        <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                        <span class="n">force_new</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;message_sent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">sent_status</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;message_sent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Meaningfulness] Message sent to student </span><span class="si">{</span><span class="n">canvas_id</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message sent to student </span><span class="si">{</span><span class="n">canvas_id</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Meaningfulness] Failed to send message for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send message for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;message_sent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">sent_status</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;message_sent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Meaningfulness] Error setting up Canvas connection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error setting up Canvas connection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Message sending results:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;meaningful_score&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">meaningfulness_threshold</span><span class="p">:</span>
                    <span class="n">message_status</span> <span class="o">=</span> <span class="s2">&quot;SENT&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message_sent&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;FAILED&quot;</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: Message </span><span class="si">{</span><span class="n">message_status</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sent_status</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Meaningfulness] All submissions have acceptable meaningfulness scores.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All submissions have acceptable meaningfulness scores.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sent_status</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="extract_canvas_id_from_filename">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.extract_canvas_id_from_filename">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_canvas_id_from_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract Canvas ID from filename with format: &lt;student name&gt;_&lt;canvas id&gt;_&lt;time&gt;_&lt;status&gt;.&lt;ext&gt;</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        filename (str): The PDF filename.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        int or None: Canvas ID if found, None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="notify_missing_submissions_after_due">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.notify_missing_submissions_after_due">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">notify_missing_submissions_after_due</span><span class="p">(</span>
    <span class="n">assignment_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="n">CANVAS_DEFAULT_ASSIGNMENT_CATEGORY</span><span class="p">,</span>
    <span class="n">refine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">auto_send</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Notify students who have not submitted for assignments whose due date has passed but are not locked.</span>
<span class="sd">    Returns a summary dict mapping assignment_id to missing student info.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
    <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

    <span class="n">people</span> <span class="o">=</span> <span class="n">list_canvas_people</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">course_id</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">active_students</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active_students&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">active_map</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;canvas_id&quot;</span><span class="p">]):</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">active_students</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;canvas_id&quot;</span><span class="p">)}</span>

    <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">group_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;assignments&quot;</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">group_map</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignments</span><span class="p">())</span>

    <span class="n">selected_assignments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">assignment_ids</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assignment_ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">assignment_ids</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">assignment_ids</span><span class="p">}:</span>
                <span class="n">selected_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment_group_id&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">group_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;assignment_group_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">and</span> <span class="n">group_name</span> <span class="ow">and</span> <span class="n">group_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">selected_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">selected_assignments</span><span class="p">:</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">due_at</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_at&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;due_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">lock_at</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lock_at&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;lock_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">due_at</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">due_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">due_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">due_dt</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">lock_at</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lock_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">lock_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lock_dt</span> <span class="o">&lt;=</span> <span class="n">now</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">assignment_obj</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">submissions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assignment_obj</span><span class="o">.</span><span class="n">get_submissions</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]))</span>
        <span class="n">submitted_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
            <span class="n">submitted_at</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">submitted_at</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">canvas_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">canvas_id</span><span class="p">:</span>
                    <span class="n">submitted_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">))</span>

        <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">canvas_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">active_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">submitted_ids</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;assignment_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;missing&quot;</span><span class="p">:</span> <span class="n">missing</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">student</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
            <span class="n">canvas_id</span> <span class="o">=</span> <span class="n">student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;canvas_id&quot;</span><span class="p">)</span>
            <span class="n">student_name</span> <span class="o">=</span> <span class="n">student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">canvas_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cho </span><span class="si">{</span><span class="n">student_name</span><span class="si">}</span><span class="s2">,</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;H thng ghi nhn bn cha np bi cho </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> mc d  qu hn np. &quot;</span>
                <span class="s2">&quot;Vui lng np bi sm nht c th hoc lin h ging vin nu gp kh khn.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Thng bo ny c gi t ng t h thng.&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">refine</span> <span class="ow">in</span> <span class="n">ALL_AI_METHODS</span><span class="p">:</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Bn l tr ging. Hy vit li thng bo sau bng ting Vit, lch s, r rng, &quot;</span>
                    <span class="s2">&quot;nhc sinh vin cha np bi sau hn nhng cha b kha. Tr v ni dung hon chnh.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Thng bo:</span><span class="se">\n</span><span class="si">{text}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">refine_text_with_ai</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_send</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">canvas</span><span class="o">.</span><span class="n">create_conversation</span><span class="p">(</span>
                    <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)],</span>
                    <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Nhc nh: Cha np bi qu hn&quot;</span><span class="p">,</span>
                    <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                    <span class="n">force_new</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MissingSubmissions] Failed to notify </span><span class="si">{</span><span class="n">student_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">canvas_id</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>



<div class="viewcode-block" id="run_weekly_canvas_automation">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.run_weekly_canvas_automation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_weekly_canvas_automation</span><span class="p">(</span>
    <span class="n">assignment_id</span><span class="p">,</span>
    <span class="n">dest_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">teacher_canvas_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="n">CANVAS_DEFAULT_ASSIGNMENT_CATEGORY</span><span class="p">,</span>
    <span class="n">ocr_service</span><span class="o">=</span><span class="n">DEFAULT_OCR_METHOD</span><span class="p">,</span>
    <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">refine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span>
    <span class="n">meaningfulness_threshold</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
    <span class="n">auto_grade_score</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">notify_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run weekly automation for a closed assignment:</span>
<span class="sd">    - Download submissions</span>
<span class="sd">    - Check meaningfulness + similarity and notify students</span>
<span class="sd">    - Assign score to clean submissions</span>
<span class="sd">    - Notify missing submissions for overdue assignments</span>
<span class="sd">    - Send summary to teacher</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">assignment_id</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;assignment_id is required&quot;</span><span class="p">)</span>

    <span class="n">out_dir</span><span class="p">,</span> <span class="n">files</span> <span class="o">=</span> <span class="n">download_canvas_assignment_submissions_auto</span><span class="p">(</span>
        <span class="n">assignment_id</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">,</span>
        <span class="n">dest_dir</span><span class="o">=</span><span class="n">dest_dir</span><span class="p">,</span>
        <span class="n">api_url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
        <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">meaningful_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">similarity_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">meaningful_results</span> <span class="o">=</span> <span class="n">detect_meaningful_level_and_notify_students</span><span class="p">(</span>
            <span class="n">out_dir</span><span class="p">,</span>
            <span class="n">assignment_id</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">,</span>
            <span class="n">ocr_service</span><span class="o">=</span><span class="n">ocr_service</span><span class="p">,</span>
            <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">,</span>
            <span class="n">refine</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span>
            <span class="n">meaningfulness_threshold</span><span class="o">=</span><span class="n">meaningfulness_threshold</span><span class="p">,</span>
            <span class="n">api_url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
            <span class="n">auto_send</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">similarity_pairs</span> <span class="o">=</span> <span class="n">compare_texts_from_pdfs_in_folder</span><span class="p">(</span>
            <span class="n">out_dir</span><span class="p">,</span>
            <span class="n">ocr_service</span><span class="o">=</span><span class="n">ocr_service</span><span class="p">,</span>
            <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">,</span>
            <span class="n">refine</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span>
            <span class="n">similarity_threshold</span><span class="o">=</span><span class="n">similarity_threshold</span><span class="p">,</span>
            <span class="n">api_url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
            <span class="n">auto_send</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">flagged_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="p">(</span><span class="n">meaningful_results</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meaningful_score&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">meaningfulness_threshold</span><span class="p">:</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">extract_canvas_id_from_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cid</span><span class="p">:</span>
                <span class="n">flagged_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cid</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">(</span><span class="n">similarity_pairs</span> <span class="ow">or</span> <span class="p">[]):</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">):</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">extract_canvas_id_from_filename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cid</span><span class="p">:</span>
                <span class="n">flagged_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cid</span><span class="p">))</span>

    <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
    <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
    <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>
    <span class="n">assignment_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;assignment_</span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">safe_assignment</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._-]+&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">assignment_name</span><span class="p">)</span>

    <span class="n">evidence_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">flagged_ids</span> <span class="ow">and</span> <span class="n">out_dir</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
        <span class="n">evidence_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
            <span class="sa">f</span><span class="s2">&quot;flagged_submissions_</span><span class="si">{</span><span class="n">safe_assignment</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">evidence_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="n">src_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">src_path</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">extract_canvas_id_from_filename</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cid</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span> <span class="ow">in</span> <span class="n">flagged_ids</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">evidence_dir</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WeeklyAuto] Failed to save evidence for </span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">submissions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">get_submissions</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]))</span>
    <span class="n">graded</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">skipped</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">canvas_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">submitted_at</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">flagged_ids</span><span class="p">:</span>
            <span class="n">skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">current_score</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_score</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">current_score</span> <span class="o">&lt;</span> <span class="n">auto_grade_score</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;posted_grade&quot;</span><span class="p">:</span> <span class="n">auto_grade_score</span><span class="p">})</span>
                <span class="n">graded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">canvas_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WeeklyAuto] Failed to grade </span><span class="si">{</span><span class="n">canvas_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">missing_summary</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">notify_missing</span><span class="p">:</span>
        <span class="n">missing_summary</span> <span class="o">=</span> <span class="n">notify_missing_submissions_after_due</span><span class="p">(</span>
            <span class="n">assignment_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">api_url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span>
            <span class="n">refine</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span>
            <span class="n">auto_send</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">summary_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weekly automation summary for assignment </span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded files: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flagged (issues): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">flagged_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Graded with </span><span class="si">{</span><span class="n">auto_grade_score</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">graded</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped (issues): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">similarity_pairs</span><span class="p">:</span>
        <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similarity pairs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">similarity_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">low_quality</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">(</span><span class="n">meaningful_results</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meaningful_score&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">meaningfulness_threshold</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">low_quality</span><span class="p">:</span>
        <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Low quality submissions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">low_quality</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_summary</span><span class="p">:</span>
        <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assignments with missing submissions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_summary</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">summary_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_lines</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">teacher_canvas_id</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">canvas</span><span class="o">.</span><span class="n">create_conversation</span><span class="p">(</span>
                <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">teacher_canvas_id</span><span class="p">)],</span>
                <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Weekly submission checks summary&quot;</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="n">summary_text</span><span class="p">,</span>
                <span class="n">force_new</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WeeklyAuto] Failed to send summary: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">summary_payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;assignment_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">),</span>
        <span class="s2">&quot;assignment_name&quot;</span><span class="p">:</span> <span class="n">assignment_name</span><span class="p">,</span>
        <span class="s2">&quot;generated_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s2">&quot;flagged_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagged_ids</span><span class="p">),</span>
        <span class="s2">&quot;graded_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">graded</span><span class="p">),</span>
        <span class="s2">&quot;skipped_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">skipped</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;weekly_automation_summary.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">summary_payload</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WeeklyAuto] Failed to write weekly summary: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">out_dir</span><span class="p">,</span>
        <span class="s2">&quot;flagged_ids&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">flagged_ids</span><span class="p">),</span>
        <span class="s2">&quot;graded&quot;</span><span class="p">:</span> <span class="n">graded</span><span class="p">,</span>
        <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="n">skipped</span><span class="p">,</span>
        <span class="s2">&quot;missing_summary&quot;</span><span class="p">:</span> <span class="n">missing_summary</span><span class="p">,</span>
        <span class="s2">&quot;similarity_pairs&quot;</span><span class="p">:</span> <span class="n">similarity_pairs</span><span class="p">,</span>
        <span class="s2">&quot;low_quality_files&quot;</span><span class="p">:</span> <span class="n">low_quality</span><span class="p">,</span>
        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">summary_text</span><span class="p">,</span>
        <span class="s2">&quot;evidence_dir&quot;</span><span class="p">:</span> <span class="n">evidence_dir</span><span class="p">,</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="list_closed_assignments_for_weekly_automation">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.list_closed_assignments_for_weekly_automation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_closed_assignments_for_weekly_automation</span><span class="p">(</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">require_submissions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List assignments whose lock date has passed (closed) for weekly automation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
    <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;assignments&quot;</span><span class="p">]))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WeeklyAuto] Failed to list assignments: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">group_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">group_map</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">closed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">category</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
            <span class="n">lock_at</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lock_at&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lock_at</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">lock_at_clean</span> <span class="o">=</span> <span class="n">lock_at</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">lock_at</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">lock_at</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lock_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">lock_at_clean</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">lock_at</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">):</span>
                <span class="n">lock_dt</span> <span class="o">=</span> <span class="n">lock_dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lock_dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lock_dt</span> <span class="o">=</span> <span class="n">lock_dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lock_dt</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">require_submissions</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;has_submitted_submissions&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">closed</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)),</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;lock_at&quot;</span><span class="p">:</span> <span class="n">lock_at</span><span class="p">,</span>
                <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">group_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assignment_group_id&quot;</span><span class="p">)),</span>
            <span class="p">})</span>

    <span class="n">closed</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lock_at&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">closed</span></div>


<div class="viewcode-block" id="add_comment_to_canvas_submission">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.add_comment_to_canvas_submission">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_comment_to_canvas_submission</span><span class="p">(</span>
    <span class="n">assignment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">student_canvas_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">comment_text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="n">CANVAS_DEFAULT_ASSIGNMENT_CATEGORY</span><span class="p">,</span>
    <span class="n">refine</span><span class="o">=</span><span class="n">DEFAULT_AI_METHOD</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a comment to a student&#39;s submission for a given Canvas assignment.</span>
<span class="sd">    If assignment_id or student_canvas_id is None, interactively prompt the user to select.</span>
<span class="sd">    If comment_text is None, prompt the user to input the comment (multi-line supported).</span>
<span class="sd">    Only list assignments having at least one submission (submitted_at is not None for any student).</span>
<span class="sd">    If category is specified, only list assignments in that category.</span>
<span class="sd">    If refine is &#39;gemini&#39;, &#39;huggingface&#39;, or &#39;local&#39;, refine the comment via AI before posting.</span>
<span class="sd">    Returns True if successful, False otherwise.</span>
<span class="sd">    At every user prompt, allow quitting by entering &#39;q&#39; or &#39;quit&#39;.</span>
<span class="sd">    If no response after 60 seconds, execute the default option (quit if available).</span>
<span class="sd">    If verbose is True, print more details; otherwise, print only important notice.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasComment] Timeout: No response after 60 seconds. Using default option.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Using default option.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasComment] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasComment] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasComment] Operation cancelled by user.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>

        <span class="c1"># Select assignment if not provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">assignment_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] No assignment ID specified. Listing assignments with at least one actual submission:&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No assignment ID specified. Listing assignments with at least one actual submission:&quot;</span><span class="p">)</span>
            <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">assignment_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">assignment_groups</span><span class="p">:</span>
                <span class="n">group_name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">category</span> <span class="ow">and</span> <span class="n">group_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_submitted_submissions&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                            <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
                            <span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;due_at&#39;</span><span class="p">)</span>
                        <span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">assignments</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No assignments found with submissions.&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">category</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;No assignments found with submissions in category &#39;</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasComment] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">due_sort_key</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_at&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
            <span class="n">assignments</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">due_sort_key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">due</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;due_at&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;No due date&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasComment] </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">due</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">due</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                        <span class="s2">&quot;Enter the number of the assignment to comment on (or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="s2">&quot;q&quot;</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">):</span>
                    <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">assignments</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] Invalid selection. Please enter a valid number or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid selection. Please enter a valid number or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>

        <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>

        <span class="c1"># Select student if not provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">student_canvas_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] Fetching submissions for the assignment...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fetching submissions for the assignment...&quot;</span><span class="p">)</span>
            <span class="n">students</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get_submissions</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]):</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">student_name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;UnknownStudent&quot;</span><span class="p">)</span>
                <span class="n">canvas_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                <span class="n">submitted_at</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">submitted_at</span><span class="p">:</span>
                    <span class="n">students</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;canvas_id&quot;</span><span class="p">:</span> <span class="n">canvas_id</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">student_name</span><span class="p">,</span>
                        <span class="s2">&quot;submitted_at&quot;</span><span class="p">:</span> <span class="n">submitted_at</span>
                    <span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">students</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] No students found with submissions for this assignment.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No students found with submissions for this assignment.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">students</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">submitted</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;submitted_at&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;No submission&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasComment] </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Submitted at: </span><span class="si">{</span><span class="n">submitted</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Submitted at: </span><span class="si">{</span><span class="n">submitted</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                        <span class="s2">&quot;Enter the number of the student to comment on (or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="s2">&quot;q&quot;</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">students</span><span class="p">):</span>
                    <span class="n">student_canvas_id</span> <span class="o">=</span> <span class="n">students</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] Invalid selection. Please enter a valid number or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid selection. Please enter a valid number or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">comment_text</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] Enter the comment to add (multi-line, end with an empty line). Enter &#39;q&#39; or &#39;quit&#39; on a new line to quit.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter the comment to add (multi-line, end with an empty line). Enter &#39;q&#39; or &#39;quit&#39; on a new line to quit.&quot;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] No input after 60 seconds. Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No input after 60 seconds. Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">comment_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">comment_text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] No comment entered. Aborting.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No comment entered. Aborting.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Optionally refine the comment using AI</span>
        <span class="k">if</span> <span class="n">refine</span> <span class="ow">in</span> <span class="n">ALL_AI_METHODS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasComment] Refining comment using AI service: </span><span class="si">{</span><span class="n">refine</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refining comment using AI service: </span><span class="si">{</span><span class="n">refine</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;You are an expert assistant. Please refine the following comment for clarity, &quot;</span>
                <span class="s2">&quot;correct any spelling or grammar mistakes, and improve readability. &quot;</span>
                <span class="s2">&quot;Keep the meaning and important information unchanged. &quot;</span>
                <span class="s2">&quot;Return ONLY the improved comment, no explanations.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Comment:</span><span class="se">\n</span><span class="si">{text}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">refined_comment</span> <span class="o">=</span> <span class="n">refine_text_with_ai</span><span class="p">(</span><span class="n">comment_text</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasComment] Refined comment:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">refined_comment</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Refined comment:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">refined_comment</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">confirm</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Do you want to use the refined comment? (y/n, or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                    <span class="n">confirm</span> <span class="o">=</span> <span class="s2">&quot;q&quot;</span>
                <span class="k">if</span> <span class="n">confirm</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">confirm</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                    <span class="n">comment_text</span> <span class="o">=</span> <span class="n">refined_comment</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">confirm</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] Using the original comment.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using the original comment.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasComment] Please enter &#39;y&#39;, &#39;n&#39;, or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please enter &#39;y&#39;, &#39;n&#39;, or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>

        <span class="n">submission</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get_submission</span><span class="p">(</span><span class="n">student_canvas_id</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;text_comment&#39;</span><span class="p">:</span> <span class="n">comment_text</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasComment] Comment added to submission of student </span><span class="si">{</span><span class="n">student_canvas_id</span><span class="si">}</span><span class="s2"> for assignment </span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Comment added to submission of student </span><span class="si">{</span><span class="n">student_canvas_id</span><span class="si">}</span><span class="s2"> for assignment </span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasComment] Failed to add comment: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to add comment: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="search_canvas_user">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.search_canvas_user">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">search_canvas_user</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span> <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for a user in Canvas by name or email address and print details, including only total grades and assignment category grades.</span>

<span class="sd">    Args:</span>
<span class="sd">        query (str): Name or email to search for.</span>
<span class="sd">        api_url (str): Canvas API base URL.</span>
<span class="sd">        api_key (str): Canvas API key.</span>
<span class="sd">        course_id (str or int): Canvas course ID.</span>
<span class="sd">        verbose (bool): If True, print more details; otherwise, print only important notice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="n">enrollments</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_enrollments</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TeacherEnrollment&#39;</span><span class="p">,</span> <span class="s1">&#39;TaEnrollment&#39;</span><span class="p">,</span> <span class="s1">&#39;StudentEnrollment&#39;</span><span class="p">])</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">query_lower</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">enrollment</span> <span class="ow">in</span> <span class="n">enrollments</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">user</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;login_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">query_lower</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">query_lower</span> <span class="ow">in</span> <span class="n">email</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasUser] User found:&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;User found:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Name: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Email: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;login_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Canvas ID: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Role: </span><span class="si">{</span><span class="n">enrollment</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Enrollment State: </span><span class="si">{</span><span class="n">enrollment</span><span class="o">.</span><span class="n">enrollment_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Only print total grades and assignment category grades if student</span>
                <span class="k">if</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;studentenrollment&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                        <span class="n">total_grade</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">enrollment</span><span class="p">,</span> <span class="s2">&quot;grades&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;final_grade&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">total_score</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">enrollment</span><span class="p">,</span> <span class="s2">&quot;grades&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;final_score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Grades:&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - Total Grade: </span><span class="si">{</span><span class="n">total_grade</span><span class="si">}</span><span class="s2"> (Score: </span><span class="si">{</span><span class="n">total_score</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                        <span class="n">assignment_groups</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">,</span> <span class="s1">&#39;score_statistics&#39;</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">assignment_groups</span><span class="p">:</span>
                            <span class="n">group_score</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">group_possible</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s2">&quot;score_statistics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">group</span><span class="o">.</span><span class="n">score_statistics</span><span class="p">:</span>
                                <span class="n">stats</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">score_statistics</span>
                                <span class="n">user_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">user_stats</span><span class="p">:</span>
                                    <span class="n">group_score</span> <span class="o">=</span> <span class="n">user_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>
                                    <span class="n">group_possible</span> <span class="o">=</span> <span class="n">user_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;possible&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">group_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">group_score</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">group_possible</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">submission</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get_submission</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                                        <span class="n">score</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">score</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">submission</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                                        <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                            <span class="n">group_score</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                                        <span class="n">group_possible</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;points_possible&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                        <span class="k">continue</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">group_score</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">group_possible</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasUser] Printed grades for user </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasUser] Could not fetch assignments/grades: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Could not fetch assignments/grades: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasUser] No user found matching the query.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No user found matching the query.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasUser] Error searching for user: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error searching for user: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="invite_user_to_canvas_course">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.invite_user_to_canvas_course">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">invite_user_to_canvas_course</span><span class="p">(</span>
    <span class="n">email</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;student&quot;</span><span class="p">,</span>
    <span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Add section parameter</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Invite a single user to a Canvas course via email by creating an account and enrolling them.</span>
<span class="sd">    Supports roles: &quot;student&quot;, &quot;teacher&quot;, &quot;ta&quot;, &quot;observer&quot;, &quot;designer&quot;.</span>
<span class="sd">    If the user already exists in the course, does not invite again.</span>
<span class="sd">    If section is specified, enrolls the user into that specific section.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): User email address.</span>
<span class="sd">        name (str): Full name of the user.</span>
<span class="sd">        role (str): Role to enroll (&quot;student&quot;, &quot;teacher&quot;, &quot;ta&quot;, &quot;observer&quot;, &quot;designer&quot;). Default: &quot;student&quot;.</span>
<span class="sd">        section (str): Optional section name to enroll user into.</span>
<span class="sd">        api_url (str): Canvas API base URL.</span>
<span class="sd">        api_key (str): Canvas API key.</span>
<span class="sd">        course_id (str or int): Canvas course ID.</span>
<span class="sd">        verbose (bool): If True, print more details; otherwise, print only important notice.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Success/error information about the invitation process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasInvite] Email and name are required.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Email and name are required.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Email and name are required.&quot;</span><span class="p">}</span>

        <span class="n">role</span> <span class="o">=</span> <span class="n">role</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">role_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;student&quot;</span><span class="p">:</span> <span class="s2">&quot;StudentEnrollment&quot;</span><span class="p">,</span>
            <span class="s2">&quot;teacher&quot;</span><span class="p">:</span> <span class="s2">&quot;TeacherEnrollment&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ta&quot;</span><span class="p">:</span> <span class="s2">&quot;TaEnrollment&quot;</span><span class="p">,</span>
            <span class="s2">&quot;observer&quot;</span><span class="p">:</span> <span class="s2">&quot;ObserverEnrollment&quot;</span><span class="p">,</span>
            <span class="s2">&quot;designer&quot;</span><span class="p">:</span> <span class="s2">&quot;DesignerEnrollment&quot;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">role_map</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Invalid role: </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">. Must be one of: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">role_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid role: </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">. Must be one of: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">role_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid role: </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>

        <span class="c1"># Check if already enrolled</span>
        <span class="n">enrollments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_enrollments</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="n">role_map</span><span class="p">[</span><span class="n">role</span><span class="p">]],</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">enrollment</span> <span class="ow">in</span> <span class="n">enrollments</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">enrollment</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">user_email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;login_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">user_email</span> <span class="o">==</span> <span class="n">email</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] User with email </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> is already enrolled in course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User with email </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> is already enrolled in course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;already_enrolled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

        <span class="c1"># Find section ID if section is specified</span>
        <span class="n">section_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">section</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">course_sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_sections</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">course_sections</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">section</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">section_id</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Found section &#39;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">&#39; with ID </span><span class="si">{</span><span class="n">section_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found section &#39;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">&#39; with ID </span><span class="si">{</span><span class="n">section_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">section_id</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Warning: Section &#39;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">&#39; not found in course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Section &#39;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">&#39; not found in course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">section_error</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Error finding section: </span><span class="si">{</span><span class="n">section_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error finding section: </span><span class="si">{</span><span class="n">section_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="p">}</span>

        <span class="n">account_id</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">if</span> <span class="s2">&quot;canvas.instructure.com&quot;</span> <span class="ow">in</span> <span class="n">api_url</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">account_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/accounts/</span><span class="si">{</span><span class="n">account_id</span><span class="si">}</span><span class="s2">/users&quot;</span>

        <span class="n">name_parts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">first_name</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">last_name</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">short_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">sortable_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">first_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">short_name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">sortable_name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">account_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;short_name&#39;</span><span class="p">:</span> <span class="n">short_name</span><span class="p">,</span>
                <span class="s1">&#39;sortable_name&#39;</span><span class="p">:</span> <span class="n">sortable_name</span><span class="p">,</span>
                <span class="s1">&#39;terms_of_use&#39;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">},</span>
            <span class="s1">&#39;pseudonym&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;unique_id&#39;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                <span class="s1">&#39;force_self_registration&#39;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">account_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">account_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">account_data</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">account_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span><span class="p">:</span>
            <span class="n">response_data</span> <span class="o">=</span> <span class="n">account_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;already belongs to a user&#39;</span> <span class="ow">in</span> <span class="n">error_message</span> <span class="ow">or</span> <span class="s1">&#39;id already in use&#39;</span> <span class="ow">in</span> <span class="n">error_message</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Email </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> already has a Canvas account. Finding existing user...&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Email </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> already has a Canvas account. Finding existing user...&quot;</span><span class="p">)</span>
                
                <span class="c1"># Find user ID by querying /api/v1/accounts/self/users with search_term=&lt;email&gt;</span>
                <span class="n">search_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/accounts/self/users?search_term=</span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">search_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">search_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">search_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">users</span> <span class="o">=</span> <span class="n">search_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;login_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">email</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Found existing user with ID </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> via search API&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found existing user with ID </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> via search API&quot;</span><span class="p">)</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Could not find existing user for email </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find existing user for email </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Could not find existing user for email </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Account creation failed: </span><span class="si">{</span><span class="n">response_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Account creation failed: </span><span class="si">{</span><span class="n">response_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Account creation failed: </span><span class="si">{</span><span class="n">response_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">account_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Account creation failed: </span><span class="si">{</span><span class="n">account_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">account_response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Account creation failed: </span><span class="si">{</span><span class="n">account_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">account_response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Account creation failed: </span><span class="si">{</span><span class="n">account_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">account_response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_user_data</span> <span class="o">=</span> <span class="n">account_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">new_user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Canvas account created for </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> (User ID: </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Canvas account created for </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> (User ID: </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Enroll user using POST to /api/v1/courses/:course_id/enrollments</span>
        <span class="n">enroll_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s1">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s1">/enrollments&#39;</span>
        <span class="n">enroll_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;enrollment[user_id]&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s1">&#39;enrollment[type]&#39;</span><span class="p">:</span> <span class="n">role_map</span><span class="p">[</span><span class="n">role</span><span class="p">],</span>
            <span class="s1">&#39;enrollment[enrollment_state]&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span>
            <span class="s1">&#39;enrollment[notify]&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
        
        <span class="c1"># Add section_id to enrollment if specified and found</span>
        <span class="k">if</span> <span class="n">section_id</span><span class="p">:</span>
            <span class="n">enroll_data</span><span class="p">[</span><span class="s1">&#39;enrollment[course_section_id]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">section_id</span>
            <span class="n">enroll_data</span><span class="p">[</span><span class="s1">&#39;enrollment[limit_privileges_to_course_section]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Enrolling user in section ID </span><span class="si">{</span><span class="n">section_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enrolling user in section ID </span><span class="si">{</span><span class="n">section_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="n">headers_form</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>
        <span class="p">}</span>
        <span class="n">enroll_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">enroll_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers_form</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">enroll_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enroll_response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">]:</span>
            <span class="n">enrollment_data</span> <span class="o">=</span> <span class="n">enroll_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">section_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; in section &#39;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="n">section_id</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Successfully enrolled </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> in course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}{</span><span class="n">section_info</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully enrolled </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> in course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}{</span><span class="n">section_info</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                <span class="s2">&quot;section_id&quot;</span><span class="p">:</span> <span class="n">section_id</span><span class="p">,</span>
                <span class="s2">&quot;enrollment_state&quot;</span><span class="p">:</span> <span class="n">enrollment_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enrollment_state&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Enrollment failed: </span><span class="si">{</span><span class="n">enroll_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">enroll_response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enrollment failed: </span><span class="si">{</span><span class="n">enroll_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">enroll_response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Enrollment failed: </span><span class="si">{</span><span class="n">enroll_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">enroll_response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span>
            <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Error inviting user: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error inviting user: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span></div>


<div class="viewcode-block" id="invite_users_to_canvas_course">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.invite_users_to_canvas_course">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">invite_users_to_canvas_course</span><span class="p">(</span>
    <span class="n">data_file</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;student&quot;</span><span class="p">,</span>
    <span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Invite one or more users (student, teacher, or TA) to a Canvas course from a TXT file or a string.</span>

<span class="sd">    Supported input formats for `data_file`:</span>
<span class="sd">      - Path to a TXT file (each line: &quot;name,email,role,section&quot; or &quot;name,email,role&quot; or &quot;name,email&quot; or just &quot;email&quot;; also supports semicolon-separated pairs in file)</span>
<span class="sd">      - A string of pairs: &quot;&lt;name&gt;,&lt;email&gt;,&lt;role&gt;,&lt;section&gt;;&lt;name&gt;,&lt;email&gt;,&lt;role&gt;,&lt;section&gt;;...&quot; (semicolon-separated)</span>
<span class="sd">      - A string of emails separated by commas/semicolons/spaces/newlines (if `name` is provided separately)</span>
<span class="sd">      - A string of alternating &quot;name,email,role,section,name,email,role,section,...&quot; (if no semicolons, will try to group as quads)</span>
<span class="sd">      - If only email is provided, the part before @ is used as the name, and `role` and `section` arguments are used.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_file (str): Path to TXT file or string with user info.</span>
<span class="sd">            - If a file path exists, reads from file.</span>
<span class="sd">            - Otherwise, parses as string input.</span>
<span class="sd">        name (str or None): Optional name(s) if data_file is only emails.</span>
<span class="sd">            - If provided, should be comma/semicolon/space/newline separated, matching the number of emails.</span>
<span class="sd">        role (str): Role to enroll (&quot;student&quot;, &quot;teacher&quot;, &quot;ta&quot;). Default: &quot;student&quot;.</span>
<span class="sd">            - Can be overridden per user if specified in the input.</span>
<span class="sd">        section (str): Optional Canvas section name to enroll users into.</span>
<span class="sd">            - Can be overridden per user if specified in the input.</span>
<span class="sd">        course_id (str): Canvas course ID.</span>
<span class="sd">        api_url (str): Canvas API URL.</span>
<span class="sd">        api_key (str): Canvas API key.</span>
<span class="sd">        verbose (bool): If True, print more details; otherwise, print only important notice.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of dicts with invitation results for each user.</span>
<span class="sd">        Each dict contains success/error info for that user.</span>

<span class="sd">    Details:</span>
<span class="sd">        - If a line or entry is &quot;name,email,role,section&quot;, uses all four.</span>
<span class="sd">        - If &quot;name,email,role&quot;, uses provided section argument.</span>
<span class="sd">        - If &quot;name,email&quot;, uses provided role and section arguments.</span>
<span class="sd">        - If only email is provided, uses the part before &quot;@&quot; as the name and provided role and section.</span>
<span class="sd">        - Skips invalid emails and prints a warning.</span>
<span class="sd">        - Calls invite_user_to_canvas_course() for each user.</span>
<span class="sd">        - Prints a summary of how many users were invited.</span>
<span class="sd">        - Handles both file and string input robustly.</span>
<span class="sd">        - Returns a list of results (one per user processed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">email_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$&quot;</span><span class="p">)</span>
    <span class="n">valid_roles</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;student&quot;</span><span class="p">,</span> <span class="s2">&quot;teacher&quot;</span><span class="p">,</span> <span class="s2">&quot;ta&quot;</span><span class="p">}</span>

    <span class="c1"># Helper to parse a line or entry</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_entry</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">default_role</span><span class="p">,</span> <span class="n">default_section</span><span class="p">):</span>
        <span class="c1"># Try &quot;name,email,role,section&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(.*?),(.*?),(.*?),(.*)$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">email_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_roles</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">default_role</span>
            <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span>
        <span class="c1"># Try &quot;name,email,role&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(.*?),(.*?),(.*)$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">email_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_roles</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">default_role</span>
            <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">default_section</span>
        <span class="c1"># Try &quot;name,email&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(.*?),(.*)$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">email_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">default_role</span><span class="p">,</span> <span class="n">default_section</span>
        <span class="c1"># Try just email</span>
        <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">email_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">default_role</span><span class="p">,</span> <span class="n">default_section</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Read and normalize input lines</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">file_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># Support both one-user-per-line and multi-pair string format in file</span>
        <span class="c1"># If file contains semicolons, treat as multi-pair string</span>
        <span class="k">if</span> <span class="s2">&quot;;&quot;</span> <span class="ow">in</span> <span class="n">file_content</span><span class="p">:</span>
            <span class="n">raw_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">file_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, treat each non-empty line as a record</span>
            <span class="n">raw_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file_content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">raw_lines</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Otherwise, treat as string of pairs/triples/quads or emails</span>
        <span class="c1"># Try to split by semicolon first (for &quot;name,email,role,section;name,email,role,section;...&quot;)</span>
        <span class="k">if</span> <span class="s2">&quot;;&quot;</span> <span class="ow">in</span> <span class="n">data_file</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">elif</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">data_file</span> <span class="ow">and</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">data_file</span><span class="p">:</span>
            <span class="c1"># Could be &quot;name,email,role,section,name,email,role,section&quot; or &quot;name,email,role,name,email,role&quot; etc</span>
            <span class="c1"># If name is provided separately, use it</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">emails</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[;, \n]&quot;</span><span class="p">,</span> <span class="n">data_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[;, \n]&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">emails</span><span class="p">):</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">emails</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Fallback: treat as emails only</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">emails</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Try to group as quads (name,email,role,section)</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="c1"># name,email,role,section</span>
                        <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_roles</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="n">role</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="c1"># name,email,role</span>
                        <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_roles</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="n">role</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">3</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="c1"># name,email</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Space/comma/semicolon/newline separated emails</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[;, \n]&quot;</span><span class="p">,</span> <span class="n">data_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">parse_entry</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">email_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Invalid email format: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (line: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid email: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">invite_user_to_canvas_course</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
            <span class="n">role</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>
            <span class="n">section</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
            <span class="n">api_url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasInvite] Invited </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> users from input.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invited </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> users from input.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_parse_announcement_file</span><span class="p">(</span><span class="n">message_path</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">message_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">message_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">in_message</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;title:&quot;</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;message:&quot;</span><span class="p">):</span>
            <span class="n">in_message</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">in_message</span><span class="p">:</span>
            <span class="n">message_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">or</span> <span class="n">in_message</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">title</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message_lines</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<div class="viewcode-block" id="add_canvas_announcement">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.add_canvas_announcement">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_canvas_announcement</span><span class="p">(</span>
    <span class="n">title</span><span class="p">,</span>
    <span class="n">message</span><span class="p">,</span>
    <span class="n">message_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">refine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add an announcement to a Canvas course.</span>
<span class="sd">    Accepts a short message (manual input or TXT file), optionally refines with AI,</span>
<span class="sd">    confirms with the user, and posts to Canvas.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasAnnouncement] Timeout: No response after 60 seconds. Using default option.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Using default option.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasAnnouncement] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasAnnouncement] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasAnnouncement] Operation cancelled by user.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">message_path</span><span class="p">:</span>
            <span class="n">file_title</span><span class="p">,</span> <span class="n">file_message</span> <span class="o">=</span> <span class="n">_parse_announcement_file</span><span class="p">(</span><span class="n">message_path</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="ow">or</span> <span class="n">file_title</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">message</span> <span class="ow">or</span> <span class="n">file_message</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">title</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">title</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Announcement title: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Short announcement message: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">refine</span> <span class="ow">and</span> <span class="n">refine</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_prompt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;You are a formal announcement editor. Rewrite the following message in a more formal tone. &quot;</span>
                    <span class="s2">&quot;Keep all details accurate (dates, times, deadlines, numbers, and names must not change). &quot;</span>
                    <span class="s2">&quot;The final message must start with a greeting such as &#39;Dear all,&#39; or &#39;Cho cc bn,&#39;. &quot;</span>
                    <span class="s2">&quot;Choose the greeting to match the language of the input. &quot;</span>
                    <span class="s2">&quot;Return ONLY the rewritten announcement text.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Message:</span><span class="se">\n</span><span class="si">{text}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">refined</span> <span class="o">=</span> <span class="n">refine_text_with_ai</span><span class="p">(</span>
                    <span class="n">message</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                    <span class="n">user_prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">refined</span> <span class="ow">and</span> <span class="n">refined</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">refined</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasAnnouncement] Failed to refine message: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Confirm submission</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasAnnouncement] Preview of announcement to submit:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Title: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Message:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Preview of announcement to submit:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Title: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Message:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
            <span class="n">confirm</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finish editing and submit this announcement? (y/n, default y): &quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;y&quot;</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasAnnouncement] No response after 60 seconds. Using default: y&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No response after 60 seconds. Using default: y&quot;</span><span class="p">)</span>
            <span class="n">confirm</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasAnnouncement] Operation cancelled by user.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">temp_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User cancelled.&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">confirm</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasAnnouncement] Cancelled.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cancelled.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User cancelled.&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">or</span> <span class="n">DRY_RUN</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasAnnouncement] Dry run: &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; not posted.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dry run: &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; not posted.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dry_run&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>

        <span class="c1"># Post to Canvas</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">create_discussion_topic</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">is_announcement</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasAnnouncement] Announcement &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; created for course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Announcement &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; created for course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">discussion</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasAnnouncement] Failed to create announcement: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create announcement: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span></div>


<div class="viewcode-block" id="send_canvas_message_to_students">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.send_canvas_message_to_students">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">send_canvas_message_to_students</span><span class="p">(</span>
    <span class="n">subject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">student_canvas_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">refine</span><span class="o">=</span><span class="n">DEFAULT_AI_METHOD</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a message via Canvas to one or more students.</span>
<span class="sd">    If student_canvas_ids is not specified, list all active students and allow user to select (supports ranges, e.g., 1-5,7,9).</span>
<span class="sd">    Args:</span>
<span class="sd">        subject (str): Subject of the message.</span>
<span class="sd">        message (str): Message body (plain text or HTML).</span>
<span class="sd">        student_canvas_ids (list): List of Canvas user IDs to send to.</span>
<span class="sd">        api_url, api_key, course_id: Canvas API info.</span>
<span class="sd">        refine (str): Refine message using AI (&#39;gemini&#39;, &#39;huggingface&#39;, or None).</span>
<span class="sd">        verbose (bool): If True, print more details; otherwise, print only important notice.</span>
<span class="sd">    Returns:</span>
<span class="sd">        True if sent, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasMessage] Timeout: No response after 60 seconds. Using default option.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Using default option.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMessage] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMessage] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasMessage] Operation cancelled by user.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="c1"># Get all active students if not provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">student_canvas_ids</span><span class="p">:</span>
            <span class="n">people</span> <span class="o">=</span> <span class="n">list_canvas_people</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">course_id</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">students</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active_students&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">students</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] No active students found.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No active students found.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] Active students:&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Active students:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMessage] </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] Select students to send message to (e.g., 1-5,7,9 or &#39;a&#39; for all, or &#39;q&#39; to quit):&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select students to send message to (e.g., 1-5,7,9 or &#39;a&#39; for all, or &#39;q&#39; to quit):&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Enter selection: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">):</span>
                    <span class="n">selected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">students</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">selected</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                        <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                                <span class="n">selected</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">continue</span>
                        <span class="k">elif</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">selected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
                    <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">students</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] No valid selection. Try again or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid selection. Try again or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">student_canvas_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">students</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;canvas_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>
                <span class="k">break</span>

        <span class="c1"># Prompt for subject if not provided</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">subject</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subject</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] Quitting.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Prompt for message if not provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] Enter message body (multi-line, end with an empty line, or &#39;q&#39; to quit):&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter message body (multi-line, end with an empty line, or &#39;q&#39; to quit):&quot;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] Message body is required.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Message body is required.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Optionally refine the message using AI</span>
        <span class="k">if</span> <span class="n">refine</span> <span class="ow">in</span> <span class="n">ALL_AI_METHODS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMessage] Refining message using AI service: </span><span class="si">{</span><span class="n">refine</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refining message using AI service: </span><span class="si">{</span><span class="n">refine</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;You are an expert assistant. Please refine the following message for clarity, &quot;</span>
                <span class="s2">&quot;correct any spelling or grammar mistakes, and improve readability. &quot;</span>
                <span class="s2">&quot;Keep the meaning and important information unchanged. &quot;</span>
                <span class="s2">&quot;Return ONLY the improved message, no explanations.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Message:</span><span class="se">\n</span><span class="si">{text}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">refined_message</span> <span class="o">=</span> <span class="n">refine_text_with_ai</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasMessage] Refined message:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">refined_message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Refined message:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">refined_message</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">confirm</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Do you want to use the refined message? (y/n, or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">confirm</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">confirm</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">refined_message</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">confirm</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] Using the original message.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using the original message.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] Please enter &#39;y&#39;, &#39;n&#39;, or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please enter &#39;y&#39;, &#39;n&#39;, or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>

        <span class="c1"># Send message via Canvas Conversations API</span>
        <span class="n">recipient_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">student_canvas_ids</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMessage] Sending message from </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recipient_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> student(s)...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending message from </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recipient_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> student(s)...&quot;</span><span class="p">)</span>
        <span class="n">canvas</span><span class="o">.</span><span class="n">create_conversation</span><span class="p">(</span>
            <span class="n">recipients</span><span class="o">=</span><span class="n">recipient_ids</span><span class="p">,</span>
            <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">force_new</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMessage] Message sent successfully.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Message sent successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMessage] Failed to send message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="notify_incomplete_canvas_peer_reviews">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.notify_incomplete_canvas_peer_reviews">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">notify_incomplete_canvas_peer_reviews</span><span class="p">(</span>
    <span class="n">assignment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="n">CANVAS_DEFAULT_ASSIGNMENT_CATEGORY</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">refine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">confirm_each</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># New option: if False, send to all without confirmation</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each submission in a Canvas assignment, list students who are assigned to review that submission.</span>
<span class="sd">    For each reviewer with pending reviews, send a reminder message to that user (optionally refined via AI),</span>
<span class="sd">    including the list of pending reviews and the assignment title. Reviews are considered incomplete if rubric points are not given.</span>
<span class="sd">    Only list assignments whose lock date has passed.</span>
<span class="sd">    Allows user to select one or more assignments (supports ranges, comma-separated, or &#39;a&#39; for all).</span>
<span class="sd">    Optionally allows sending messages to all students without confirming one by one.</span>
<span class="sd">    Does not return anything.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">_signum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Quitting...&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use signal.SIGALRM only if available (not on Windows)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback for platforms without SIGALRM (e.g., Windows)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">assignment_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">]))</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">assignment_groups</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">and</span> <span class="n">group_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                <span class="c1"># Only include assignments whose lock date has passed</span>
                <span class="n">lock_at</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lock_at&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lock_at</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">lock_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">lock_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">lock_dt</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If no lock date, skip (do not include assignments without lock date)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_submitted_submissions&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
                        <span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;due_at&#39;</span><span class="p">),</span>
                        <span class="s2">&quot;lock_at&quot;</span><span class="p">:</span> <span class="n">lock_at</span>
                    <span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">assignments</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No assignments found with submissions and lock date passed.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">due_sort_key</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_at&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
        <span class="n">assignments</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">due_sort_key</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assignments with submissions and lock date passed:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">due</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;due_at&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;No due date&quot;</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;lock_at&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;No lock date&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">due</span><span class="si">}</span><span class="s2">, Lock: </span><span class="si">{</span><span class="n">lock</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">selected_assignment_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">assignment_id</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                    <span class="s2">&quot;Enter the number(s) of the assignment(s) to view reviews (e.g. 1,3-5 or &#39;a&#39; for all, or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">):</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">):</span>
                    <span class="n">selected_assignment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                            <span class="n">selected</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid selection. Please enter valid numbers, a range, &#39;a&#39; for all, or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">selected_assignment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_assignment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">assignment_id</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">assignment_id</span> <span class="ow">in</span> <span class="n">selected_assignment_ids</span><span class="p">:</span>
            <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>
            <span class="n">assignment_title</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">name</span>
            <span class="n">submissions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">get_submissions</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]))</span>
            <span class="n">canvas_id_to_name</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">canvas_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">canvas_id</span><span class="p">:</span>
                    <span class="n">canvas_id_to_name</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/assignments/</span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2">/peer_reviews?include[]=user&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">peer_reviews</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

            <span class="n">submission_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">canvas_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">submitted</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">submission_map</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;canvas_id&quot;</span><span class="p">:</span> <span class="n">canvas_id</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;submitted&quot;</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span>
                    <span class="s2">&quot;reviewers&quot;</span><span class="p">:</span> <span class="p">[]</span>
                <span class="p">}</span>

            <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">peer_reviews</span><span class="p">:</span>
                <span class="n">asset_user_id</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
                <span class="n">assessor_id</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assessor_id&quot;</span><span class="p">)</span>
                <span class="n">workflow_state</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow_state&quot;</span><span class="p">)</span>
                <span class="n">reviewed_at</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">workflow_state</span> <span class="o">==</span> <span class="s2">&quot;completed&quot;</span><span class="p">:</span>
                    <span class="n">reviewed_at</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reviewed_at&quot;</span><span class="p">,</span> <span class="s2">&quot;DONE&quot;</span><span class="p">)</span>
                <span class="n">reviewer_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="s2">&quot;assessor&quot;</span> <span class="ow">in</span> <span class="n">pr</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s2">&quot;assessor&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">reviewer_name</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s2">&quot;assessor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">assessor_id</span> <span class="ow">in</span> <span class="n">canvas_id_to_name</span><span class="p">:</span>
                    <span class="n">reviewer_name</span> <span class="o">=</span> <span class="n">canvas_id_to_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">assessor_id</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">reviewer_info</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;canvas_id&quot;</span><span class="p">:</span> <span class="n">assessor_id</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">reviewer_name</span><span class="p">,</span>
                    <span class="s2">&quot;reviewed_at&quot;</span><span class="p">:</span> <span class="n">reviewed_at</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">asset_user_id</span> <span class="ow">in</span> <span class="n">submission_map</span><span class="p">:</span>
                    <span class="n">submission_map</span><span class="p">[</span><span class="n">asset_user_id</span><span class="p">][</span><span class="s2">&quot;reviewers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reviewer_info</span><span class="p">)</span>

            <span class="n">submission_reviewers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">submission_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">reviewer_pending_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">sub_info</span> <span class="ow">in</span> <span class="n">submission_reviewers</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sub_info</span><span class="p">[</span><span class="s2">&quot;reviewers&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;reviewed_at&quot;</span><span class="p">]:</span>
                        <span class="n">reviewer_id</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;canvas_id&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">reviewer_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reviewer_pending_map</span><span class="p">:</span>
                            <span class="n">reviewer_pending_map</span><span class="p">[</span><span class="n">reviewer_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">reviewer_pending_map</span><span class="p">[</span><span class="n">reviewer_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_info</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">reviewer_pending_map</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No reviewers with pending reviews for assignment ID </span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reviewers with pending reviews for assignment &#39;</span><span class="si">{</span><span class="n">assignment_title</span><span class="si">}</span><span class="s2">&#39;:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">reviewer_id</span><span class="p">,</span> <span class="n">pending_subs</span> <span class="ow">in</span> <span class="n">reviewer_pending_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">reviewer_name</span> <span class="o">=</span> <span class="n">canvas_id_to_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reviewer_id</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">reviewer_name</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">reviewer_id</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pending_subs</span><span class="p">)</span><span class="si">}</span><span class="s2"> pending reviews&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">pending_subs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    * </span><span class="si">{</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># Ask if user wants to send all messages without confirmation</span>
            <span class="n">send_all</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">send_messages</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Do you want to send reminder messages to these reviewers? (y/n, &#39;a&#39; for all without confirmation, or &#39;q&#39; to quit, default &#39;a&#39; in 60s): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;a&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">send_messages</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">send_messages</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
                <span class="n">send_all</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">send_messages</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Messages not sent.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">reviewer_id</span><span class="p">,</span> <span class="n">pending_subs</span> <span class="ow">in</span> <span class="n">reviewer_pending_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">reviewer_name</span> <span class="o">=</span> <span class="n">canvas_id_to_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reviewer_id</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">pending_list_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">pending_subs</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">note</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Lu : Mt bi nh gi c coi l cha hon thnh nu bn cha cho im cc tiu ch (rubrics) trong phn nh gi.&quot;</span>
                <span class="p">)</span>
                <span class="n">base_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cho </span><span class="si">{</span><span class="n">reviewer_name</span><span class="si">}</span><span class="s2">,</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;H thng pht hin bn cn </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pending_subs</span><span class="p">)</span><span class="si">}</span><span class="s2"> bi nh gi cha hon thnh cho bi tp </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">assignment_title</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pending_list_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">note</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Vui lng hon thnh cc nh gi cng sm cng tt  m bo tin  hc tp.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Thng bo ny c gi t ng bi h thng.&quot;</span>
                <span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">base_message</span>
                <span class="k">if</span> <span class="n">refine</span> <span class="ow">in</span> <span class="n">ALL_AI_METHODS</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Bn l tr l gio dc chuyn nghip. Hy vit li thng bo sau bng ting Vit, lch s, r rng, &quot;</span>
                        <span class="s2">&quot;gii thch rng cc bi nh gi c coi l cha hon thnh nu cha cho im cc tiu ch (rubrics), &quot;</span>
                        <span class="s2">&quot;v nhc sinh vin hon thnh cc nh gi cn thiu. a vo danh sch cc bi cn nh gi v tn bi tp. &quot;</span>
                        <span class="s2">&quot;Ch tr v thng bo  chnh sa, khng gii thch g thm.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;Thng bo:</span><span class="se">\n</span><span class="si">{text}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">refine_text_with_ai</span><span class="p">(</span><span class="n">base_message</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Refined message preview:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">send_all</span> <span class="ow">and</span> <span class="n">confirm_each</span><span class="p">:</span>
                        <span class="n">confirm</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                            <span class="s2">&quot;Send this refined message? (y/n, or &#39;q&#39; to skip): &quot;</span><span class="p">,</span>
                            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;y&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">confirm</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipped sending message to this reviewer.&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Message preview:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">send_all</span> <span class="ow">and</span> <span class="n">confirm_each</span><span class="p">:</span>
                        <span class="n">confirm</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                            <span class="s2">&quot;Send this message? (y/n, or &#39;q&#39; to skip): &quot;</span><span class="p">,</span>
                            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;y&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">confirm</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipped sending message to this reviewer.&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">canvas</span><span class="o">.</span><span class="n">create_conversation</span><span class="p">(</span>
                        <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">reviewer_id</span><span class="p">)],</span>
                        <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
                        <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                        <span class="n">force_new</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reminder sent to reviewer </span><span class="si">{</span><span class="n">reviewer_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">reviewer_id</span><span class="si">}</span><span class="s2">) for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pending_subs</span><span class="p">)</span><span class="si">}</span><span class="s2"> pending reviews.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send reminder to reviewer </span><span class="si">{</span><span class="n">reviewer_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">reviewer_id</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All reminders sent to reviewers with pending reviews for assignment ID </span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasReviews] Error listing reviews or sending reminders: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error listing reviews or sending reminders: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="grade_canvas_assignment_submissions">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.grade_canvas_assignment_submissions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">grade_canvas_assignment_submissions</span><span class="p">(</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="n">CANVAS_DEFAULT_ASSIGNMENT_CATEGORY</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">restricted</span><span class="o">=</span><span class="n">DEFAULT_RESTRICTED</span>  <span class="c1"># New option: if False, list all assignments with submissions and all students who submitted</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all assignments with at least one submission and whose lock date has passed (if restricted=True),</span>
<span class="sd">    or all assignments with at least one submission (if restricted=False).</span>
<span class="sd">    Allow user to select one or more (supports ranges).</span>
<span class="sd">    For each selected assignment, list all students who submitted but have not yet been given scores (if restricted=True),</span>
<span class="sd">    or all students who submitted (if restricted=False).</span>
<span class="sd">    Allow user to select one or more (supports ranges), then prompt for a score (optionally same for all), and set the score for those submissions.</span>
<span class="sd">    Allow quitting at any step.</span>
<span class="sd">    If verbose is True, print more details; otherwise, print only important notice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_quit</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>

        <span class="c1"># Step 1: List assignments with at least one submission</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">assignment_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">]))</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">assignment_groups</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">and</span> <span class="n">group_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_submitted_submissions&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">restricted</span><span class="p">:</span>
                        <span class="n">lock_at</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lock_at&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">lock_at</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">lock_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">lock_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">lock_dt</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
                                    <span class="k">continue</span>  <span class="c1"># Skip if lock date is in the future</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">continue</span>  <span class="c1"># Skip if lock date is invalid</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>  <span class="c1"># Skip if no lock date</span>
                    <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
                        <span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;due_at&#39;</span><span class="p">),</span>
                        <span class="s2">&quot;lock_at&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lock_at&#39;</span><span class="p">)</span>
                    <span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">assignments</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No assignments found with submissions and lock date passed.&quot;</span> <span class="k">if</span> <span class="n">restricted</span> <span class="k">else</span> <span class="s2">&quot;No assignments found with submissions.&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradeCanvas] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Sort by due date</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">due_sort_key</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_at&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
        <span class="n">assignments</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">due_sort_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[GradeCanvas] Assignments with at least one submission</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; and lock date passed&quot;</span> <span class="k">if</span> <span class="n">restricted</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assignments with at least one submission</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; and lock date passed&quot;</span> <span class="k">if</span> <span class="n">restricted</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">due</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;due_at&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;No due date&quot;</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;lock_at&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;No lock date&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradeCanvas] </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">due</span><span class="si">}</span><span class="s2">, Lock: </span><span class="si">{</span><span class="n">lock</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">due</span><span class="si">}</span><span class="s2">, Lock: </span><span class="si">{</span><span class="n">lock</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Step 2: Select assignments to grade (supports ranges, comma-separated, &#39;a&#39; for all)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_quit</span><span class="p">(</span>
                <span class="s2">&quot;Enter the number(s) of the assignment(s) to grade (e.g. 1,3-5 or &#39;a&#39; for all, or &#39;q&#39; to quit): &quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[GradeCanvas] Quitting.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">):</span>
                <span class="n">selected_assignments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_assignments</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                            <span class="n">selected_assignments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">selected_assignments</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
                <span class="n">selected_assignments</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected_assignments</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_assignments</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid selection. Please enter valid numbers, a range, &#39;a&#39; for all, or &#39;q&#39; to quit.&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradeCanvas] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">break</span>

        <span class="c1"># Step 3: For each selected assignment, process grading</span>
        <span class="k">for</span> <span class="n">assign_idx</span> <span class="ow">in</span> <span class="n">selected_assignments</span><span class="p">:</span>
            <span class="n">assignment_info</span> <span class="o">=</span> <span class="n">assignments</span><span class="p">[</span><span class="n">assign_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">assignment_info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[GradeCanvas] Grading assignment: [</span><span class="si">{</span><span class="n">assignment_info</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">assignment_info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Grading assignment: [</span><span class="si">{</span><span class="n">assignment_info</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">assignment_info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">assignment_id</span><span class="si">}</span><span class="s2">) ---&quot;</span><span class="p">)</span>

            <span class="c1"># List all students who submitted</span>
            <span class="n">submissions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">get_submissions</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]))</span>
            <span class="n">students_to_grade</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">student_name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;UnknownStudent&quot;</span><span class="p">)</span>
                <span class="n">canvas_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                <span class="n">submitted_at</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># Only include if submitted (on time or late)</span>
                <span class="k">if</span> <span class="n">submitted_at</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">restricted</span><span class="p">:</span>
                        <span class="c1"># Only include if score is None or 0</span>
                        <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">score</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                            <span class="n">students_to_grade</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s2">&quot;canvas_id&quot;</span><span class="p">:</span> <span class="n">canvas_id</span><span class="p">,</span>
                                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">student_name</span><span class="p">,</span>
                                <span class="s2">&quot;submitted_at&quot;</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">,</span>
                                <span class="s2">&quot;submission&quot;</span><span class="p">:</span> <span class="n">sub</span>
                            <span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">students_to_grade</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;canvas_id&quot;</span><span class="p">:</span> <span class="n">canvas_id</span><span class="p">,</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">student_name</span><span class="p">,</span>
                            <span class="s2">&quot;submitted_at&quot;</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">,</span>
                            <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
                            <span class="s2">&quot;submission&quot;</span><span class="p">:</span> <span class="n">sub</span>
                        <span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">students_to_grade</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No students have</span><span class="si">{}</span><span class="s2"> submissions for this assignment.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; ungraded&quot;</span> <span class="k">if</span> <span class="n">restricted</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradeCanvas] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">students_to_grade</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[GradeCanvas] Students who submitted</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; but have not yet been graded&quot;</span> <span class="k">if</span> <span class="n">restricted</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Students who submitted</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; but have not yet been graded&quot;</span> <span class="k">if</span> <span class="n">restricted</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">students_to_grade</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">submitted</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;submitted_at&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;No submission&quot;</span>
                <span class="n">score_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, Current Score: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;score&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">restricted</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradeCanvas] </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Submitted at: </span><span class="si">{</span><span class="n">submitted</span><span class="si">}{</span><span class="n">score_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Submitted at: </span><span class="si">{</span><span class="n">submitted</span><span class="si">}{</span><span class="n">score_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Select students to grade (supports ranges, comma-separated, &#39;a&#39; for all)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_quit</span><span class="p">(</span>
                    <span class="s2">&quot;Enter the number(s) of the student(s) to grade (e.g. 1,3-5 or &#39;a&#39; for all, or &#39;q&#39; to quit): &quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[GradeCanvas] Quitting grading for this assignment.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting grading for this assignment.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">):</span>
                    <span class="n">selected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">students_to_grade</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">selected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                        <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                                <span class="n">selected</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">continue</span>
                        <span class="k">elif</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
                    <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">students_to_grade</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid selection. Please enter valid numbers, a range, &#39;a&#39; for all, or &#39;q&#39; to quit.&quot;</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradeCanvas] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Ask for score to give (optionally same for all)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">get_input_with_quit</span><span class="p">(</span><span class="s2">&quot;Enter the score to assign to all selected submissions (or &#39;q&#39; to quit): &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[GradeCanvas] Quitting grading for this assignment.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting grading for this assignment.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid score. Skipping this assignment.&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradeCanvas] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Confirm and assign scores</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Assigning score </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span><span class="si">}</span><span class="s2"> submission(s) for assignment &#39;</span><span class="si">{</span><span class="n">assignment_info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradeCanvas] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">confirm</span> <span class="o">=</span> <span class="n">get_input_with_quit</span><span class="p">(</span><span class="s2">&quot;Proceed? (y/n): &quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">confirm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">confirm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[GradeCanvas] Aborted grading for this assignment.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aborted grading for this assignment.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">students_to_grade</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;submission&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sub</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">submission</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;posted_grade&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradeCanvas] Assigned score </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assigned score </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradeCanvas] Failed to assign score to </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to assign score to </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradeCanvas] Done grading selected submissions for assignment &#39;</span><span class="si">{</span><span class="n">assignment_info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done grading selected submissions for assignment &#39;</span><span class="si">{</span><span class="n">assignment_info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[GradeCanvas] Finished grading all selected assignments.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished grading all selected assignments.&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradeCanvas] Error grading submissions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error grading submissions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="fetch_and_reply_canvas_messages">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.fetch_and_reply_canvas_messages">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_and_reply_canvas_messages</span><span class="p">(</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">only_unread</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">reply_text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">refine</span><span class="o">=</span><span class="n">DEFAULT_AI_METHOD</span><span class="p">,</span>
    <span class="n">max_messages</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches Canvas inbox conversations (messages), prints them, and allows replying.</span>
<span class="sd">    If only_unread is True, only fetches unread conversations.</span>
<span class="sd">    If reply_text is provided, replies with that text to all selected conversations.</span>
<span class="sd">    If refine is &#39;gemini&#39;, &#39;huggingface&#39;, or &#39;local&#39;, refines the reply via AI before sending.</span>
<span class="sd">    Messages are shown in order of latest first.</span>
<span class="sd">    max_messages: maximum number of conversations to fetch and display (default: 3)</span>
<span class="sd">    Also fetches and prints the full content of each message in the conversation.</span>
<span class="sd">    If verbose is True, print more details; otherwise, print only important notice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg] Fetching Canvas inbox for user: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching Canvas inbox for user: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">inbox</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_conversations</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;unread&quot;</span> <span class="k">if</span> <span class="n">only_unread</span> <span class="k">else</span> <span class="s2">&quot;unread,read&quot;</span><span class="p">)</span>
        <span class="n">conversations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inbox</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">conversations</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No messages found.&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Sort conversations by last_message_at, latest first</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">parse_time</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span>
        <span class="n">conversations</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">parse_time</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;last_message_at&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Limit number of conversations</span>
        <span class="k">if</span> <span class="n">max_messages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_messages</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">conversations</span> <span class="o">=</span> <span class="n">conversations</span><span class="p">[:</span><span class="n">max_messages</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg] Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conversations</span><span class="p">)</span><span class="si">}</span><span class="s2"> conversation(s) (showing up to </span><span class="si">{</span><span class="n">max_messages</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conversations</span><span class="p">)</span><span class="si">}</span><span class="s2"> conversation(s) (showing up to </span><span class="si">{</span><span class="n">max_messages</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conversations</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasMsg] --- Conversation </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg] Subject: </span><span class="si">{</span><span class="n">conv</span><span class="o">.</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg] ID: </span><span class="si">{</span><span class="n">conv</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg] Last message at: </span><span class="si">{</span><span class="n">conv</span><span class="o">.</span><span class="n">last_message_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg] Participants: </span><span class="si">{</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">conv</span><span class="o">.</span><span class="n">participants</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Conversation </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject: </span><span class="si">{</span><span class="n">conv</span><span class="o">.</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ID: </span><span class="si">{</span><span class="n">conv</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Last message at: </span><span class="si">{</span><span class="n">conv</span><span class="o">.</span><span class="n">last_message_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Participants: </span><span class="si">{</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">conv</span><span class="o">.</span><span class="n">participants</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Fetch full content of messages in this conversation</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">full_conv</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_conversation</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">full_conv</span><span class="p">,</span> <span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span> <span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="c1"># Sort messages by created_at, latest first</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">msg_time</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span>
            <span class="n">messages_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">msg_time</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages_sorted</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">sender</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;display_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg]   [</span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Print all message contents (full history)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMsg] Full message history (oldest first):&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Full message history (oldest first):&quot;</span><span class="p">)</span>
            <span class="n">messages_sorted_oldest</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">msg_time</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages_sorted_oldest</span><span class="p">:</span>
                <span class="n">sender</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;display_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">created_at</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg]   [</span><span class="si">{</span><span class="n">created_at</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">created_at</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Ask user which conversations to reply to</span>
        <span class="c1"># Use input with timeout if possible, fallback to normal input on platforms without SIGALRM</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Using default option.&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">default</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">default</span>
                    <span class="k">raise</span>
                <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># On platforms without SIGALRM (e.g., Windows), just use input without timeout</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Enter conversation numbers to reply (comma/range, &#39;a&#39; for all, or &#39;q&#39; to quit): &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">):</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">conversations</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                        <span class="n">selected</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">conversations</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No valid selection.&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="n">conversations</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reply_text</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasMsg] Replying to conversation </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> (Subject: </span><span class="si">{</span><span class="n">conv</span><span class="o">.</span><span class="n">subject</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMsg] Enter reply message (multi-line, end with empty line, or &#39;q&#39; to skip):&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Replying to conversation </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> (Subject: </span><span class="si">{</span><span class="n">conv</span><span class="o">.</span><span class="n">subject</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter reply message (multi-line, end with empty line, or &#39;q&#39; to skip):&quot;</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">):</span>
                        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMsg] Skipped.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipped.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">reply_text</span>
            <span class="c1"># Optionally refine</span>
            <span class="k">if</span> <span class="n">refine</span> <span class="ow">in</span> <span class="n">ALL_AI_METHODS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg] Refining reply using AI service: </span><span class="si">{</span><span class="n">refine</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refining reply using AI service: </span><span class="si">{</span><span class="n">refine</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;You are an expert assistant. Please refine the following reply for clarity, &quot;</span>
                    <span class="s2">&quot;correct any spelling or grammar mistakes, and improve readability. &quot;</span>
                    <span class="s2">&quot;Keep the meaning and important information unchanged. &quot;</span>
                    <span class="s2">&quot;Return ONLY the improved reply, no explanations.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Reply:</span><span class="se">\n</span><span class="si">{text}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">refine_text_with_ai</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasMsg] Refined reply:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Refined reply:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">confirm</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Send this reply? (y/n): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">confirm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMsg] Skipped.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipped.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="c1"># Use the Conversation.add_message method to reply</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conv</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasMsg] Reply sent.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reply sent.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg] Failed to send reply: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send reply: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasMsg] Error fetching or replying to messages: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching or replying to messages: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="list_and_update_canvas_pages">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.list_and_update_canvas_pages">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_and_update_canvas_pages</span><span class="p">(</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">refine</span><span class="o">=</span><span class="n">DEFAULT_AI_METHOD</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all pages in a Canvas course and allow the user to update or delete one or more pages.</span>
<span class="sd">    For each selected page, fetch the content to a temporary file in the current folder, open that file for editing,</span>
<span class="sd">    and after editing, re-upload the content to Canvas using the official API (PUT /v1/courses/:course_id/pages/:url_or_id).</span>
<span class="sd">    Also allows deleting a page. Optionally refine the new content using AI before updating.</span>
<span class="sd">    If no response from user within 60 seconds, use default option.</span>
<span class="sd">    If verbose is True, print more details; otherwise, print only important notice.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">_signum</span><span class="p">,</span> <span class="n">_frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasPages] Timeout: No response after 60 seconds. Using default option.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Using default option.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use signal.SIGALRM only if available (not on Windows)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasPages] Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># On platforms without SIGALRM (e.g., Windows), just use input without timeout</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Ensure api_url is valid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_url</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;http://&quot;</span><span class="p">,</span> <span class="s2">&quot;https://&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Error: Canvas API URL is missing or invalid. Please provide a valid HTTP or HTTPS URL for the Canvas instance. </span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Canvas API URL is missing or invalid.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_pages</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pages</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasPages] No pages found in this course.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No pages found in this course.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Sort pages by title</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasPages] Pages in this course:&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pages in this course:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2"> (url: </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2"> (url: </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="c1"># Prompt user to select pages to update/delete</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
            <span class="s2">&quot;Enter page numbers to update/delete (e.g. 1,3-5 or &#39;a&#39; for all, or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">):</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                        <span class="n">selected</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasPages] No valid selection.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid selection.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasPages] --- Page </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Page </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
            <span class="n">full_page</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_page</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="n">old_body</span> <span class="o">=</span> <span class="n">full_page</span><span class="o">.</span><span class="n">body</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasPages] Current content (truncated to 500 chars):&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">old_body</span><span class="p">[:</span><span class="mi">500</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current content (truncated to 500 chars):&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">old_body</span><span class="p">[:</span><span class="mi">500</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Options: [e]dit, [d]elete, [s]kip&quot;</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;What do you want to do with this page? (e/d/s): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;s&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
                <span class="n">confirm</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Are you sure you want to delete page &#39;</span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;? (y/n): &quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;n&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">confirm</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">full_page</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Page &#39;</span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; deleted successfully.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page &#39;</span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; deleted successfully.&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Failed to delete page &#39;</span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete page &#39;</span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasPages] Skipped deleting this page.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipped deleting this page.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasPages] Skipped this page.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipped this page.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">!=</span> <span class="s2">&quot;e&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasPages] Unknown action, skipping this page.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown action, skipping this page.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Write old content to a temp file in the current folder</span>
            <span class="n">safe_title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;-_.&quot;</span> <span class="k">else</span> <span class="s2">&quot;_&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="p">)[:</span><span class="mi">40</span><span class="p">]</span>
            <span class="n">temp_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;canvas_page_</span><span class="si">{</span><span class="n">safe_title</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">.html&quot;</span>
            <span class="n">temp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">temp_filename</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">old_body</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasPages] Edit the content for this page in your editor: </span><span class="si">{</span><span class="n">temp_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasPages] After saving and closing the editor, the content will be uploaded to Canvas.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Edit the content for this page in your editor: </span><span class="si">{</span><span class="n">temp_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;After saving and closing the editor, the content will be uploaded to Canvas.&quot;</span><span class="p">)</span>
            <span class="n">default_editor</span> <span class="o">=</span> <span class="s2">&quot;notepad&quot;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;nano&quot;</span> <span class="k">if</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;nano&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;vi&quot;</span><span class="p">)</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;EDITOR&quot;</span><span class="p">,</span> <span class="n">default_editor</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">editor</span><span class="p">,</span> <span class="n">temp_path</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Could not open editor: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not open editor: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Read the edited content</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Reading edited content from: </span><span class="si">{</span><span class="n">temp_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading edited content from: </span><span class="si">{</span><span class="n">temp_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">new_body</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Could not read edited file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not read edited file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Ask user if they want to refine the new content using AI</span>
            <span class="n">refine_choice</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">refine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">refine_choice</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                        <span class="s2">&quot;Do you want to refine the page content using AI? (none/gemini/huggingface/local) [none]: &quot;</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CanvasPages] No response after 60 seconds. Using default: none&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No response after 60 seconds. Using default: none&quot;</span><span class="p">)</span>
                    <span class="n">refine_choice</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
                <span class="k">if</span> <span class="n">refine_choice</span> <span class="ow">in</span> <span class="n">ALL_AI_METHODS</span><span class="p">:</span>
                    <span class="n">refine</span> <span class="o">=</span> <span class="n">refine_choice</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">refine</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">refine</span> <span class="ow">in</span> <span class="n">ALL_AI_METHODS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Refining page content using AI service: </span><span class="si">{</span><span class="n">refine</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refining page content using AI service: </span><span class="si">{</span><span class="n">refine</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;You are an expert assistant. Please refine the following Canvas page content for clarity, &quot;</span>
                    <span class="s2">&quot;correct any spelling or grammar mistakes, and improve readability. &quot;</span>
                    <span class="s2">&quot;Keep the meaning and important information unchanged. &quot;</span>
                    <span class="s2">&quot;Return ONLY the improved content, no explanations.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Content:</span><span class="se">\n</span><span class="si">{text}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">refined_body</span> <span class="o">=</span> <span class="n">refine_text_with_ai</span><span class="p">(</span><span class="n">new_body</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CanvasPages] Refined content preview (truncated to 500 chars):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">refined_body</span><span class="p">[:</span><span class="mi">500</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Refined content preview (truncated to 500 chars):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">refined_body</span><span class="p">[:</span><span class="mi">500</span><span class="p">])</span>
                <span class="n">confirm</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                    <span class="s2">&quot;Use refined content? (y/n): &quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;y&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">confirm</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                    <span class="n">new_body</span> <span class="o">=</span> <span class="n">refined_body</span>

            <span class="c1"># Ask if user wants to update the title</span>
            <span class="n">update_title</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Do you want to update the page title? (current: &#39;</span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;) (y/n): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;n&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">new_title</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">title</span>
            <span class="k">if</span> <span class="n">update_title</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                    <span class="s2">&quot;Enter new title (leave blank to keep current): &quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">new_title</span> <span class="o">=</span> <span class="n">t</span>

            <span class="c1"># Ask for optional parameters</span>
            <span class="n">editing_roles</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;Enter editing roles (comma-separated, e.g. teachers,students) or leave blank to keep unchanged: &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">notify_of_update</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;Notify participants of update? (y/n, default n): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;n&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">published</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;Publish page? (y/n, default y): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;y&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">front_page</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;Set as front page? (y/n, default n): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;n&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="c1"># Prepare API request</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/pages/</span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span>
            <span class="p">}</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;wiki_page&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">new_title</span><span class="p">,</span>
                    <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">new_body</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">editing_roles</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wiki_page&quot;</span><span class="p">][</span><span class="s2">&quot;editing_roles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">editing_roles</span>
            <span class="k">if</span> <span class="n">notify_of_update</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wiki_page&quot;</span><span class="p">][</span><span class="s2">&quot;notify_of_update&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">published</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wiki_page&quot;</span><span class="p">][</span><span class="s2">&quot;published&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wiki_page&quot;</span><span class="p">][</span><span class="s2">&quot;published&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">front_page</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;wiki_page&quot;</span><span class="p">][</span><span class="s2">&quot;front_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Send PUT request to update the page</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Page &#39;</span><span class="si">{</span><span class="n">new_title</span><span class="si">}</span><span class="s2">&#39; updated successfully.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page &#39;</span><span class="si">{</span><span class="n">new_title</span><span class="si">}</span><span class="s2">&#39; updated successfully.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Failed to update page &#39;</span><span class="si">{</span><span class="n">new_title</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update page &#39;</span><span class="si">{</span><span class="n">new_title</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Failed to update page &#39;</span><span class="si">{</span><span class="n">new_title</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update page &#39;</span><span class="si">{</span><span class="n">new_title</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Remove the temporary file after updating</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Temporary file </span><span class="si">{</span><span class="n">temp_path</span><span class="si">}</span><span class="s2"> removed.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temporary file </span><span class="si">{</span><span class="n">temp_path</span><span class="si">}</span><span class="s2"> removed.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Could not remove temporary file </span><span class="si">{</span><span class="n">temp_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not remove temporary file </span><span class="si">{</span><span class="n">temp_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CanvasPages] Error listing or updating Canvas pages: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error listing or updating Canvas pages: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="list_students_with_multiple_submissions_on_time">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.list_students_with_multiple_submissions_on_time">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_students_with_multiple_submissions_on_time</span><span class="p">(</span>
    <span class="n">assignment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="n">CANVAS_DEFAULT_ASSIGNMENT_CATEGORY</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all students who submitted at least twice to an assignment,</span>
<span class="sd">    where the first submission is on time and the second submission is late.</span>
<span class="sd">    If assignment_id is None, list all assignments in the specified category and ask user to select one or more.</span>

<span class="sd">    For students who have first submission on time and from second submission late,</span>
<span class="sd">    update the late_policy_status from the second submission to &quot;none&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        assignment_id (str or int or None): Canvas assignment ID. If None, prompt user to select.</span>
<span class="sd">        api_url, api_key, course_id: Canvas API info.</span>
<span class="sd">        category (str): Assignment group/category to filter.</span>
<span class="sd">        verbose (bool): Print more details.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of dicts: [{canvas_id, name, submissions: [submission_times], first_on_time: True/False, second_late: True/False}, ...]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="c1"># Arguments are required by signal handler signature but not used</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Using default: all&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use signal.SIGALRM only if available (not on Windows)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># On platforms without SIGALRM (e.g., Windows), just use input without timeout</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>

        <span class="c1"># If assignment_id is None, list all assignments in the specified category and prompt user</span>
        <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">assignment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">assignment_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">assignment_groups</span><span class="p">:</span>
                <span class="n">group_name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">category</span> <span class="ow">and</span> <span class="n">group_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_submitted_submissions&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                            <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
                            <span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;due_at&#39;</span><span class="p">)</span>
                        <span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">assignments</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No assignments found with submissions in category &#39;</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&#39;.&quot;</span> <span class="k">if</span> <span class="n">category</span> <span class="k">else</span> <span class="s2">&quot;No assignments found.&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MultipleSubmissions] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="c1"># Sort by due date</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">due_sort_key</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_at&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
            <span class="n">assignments</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">due_sort_key</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assignments with at least one submission:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">due</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;due_at&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;No due date&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">due</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                        <span class="s2">&quot;Enter the number(s) of the assignment(s) to check (e.g. 1,3-5 or &#39;a&#39; for all, or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;a&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">):</span>
                    <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                            <span class="n">selected</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid selection. Please enter valid numbers, a range, &#39;a&#39; for all, or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">assignment_id</span><span class="p">]</span>

        <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">assignment_ids</span><span class="p">:</span>
            <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
            <span class="n">due_at</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;due_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">due_at</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">due_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">due_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">due_dt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">due_dt</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">submissions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">get_submissions</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;submission_history&quot;</span><span class="p">]))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">canvas_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="c1"># Get all submission attempts (submission_history)</span>
                <span class="n">history</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;submission_history&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="p">:</span>
                    <span class="c1"># Fallback: treat as single submission</span>
                    <span class="n">submitted_at</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">submitted_at</span><span class="p">:</span>
                        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">submitted_at</span><span class="p">]</span>
                        <span class="n">histories</span> <span class="o">=</span> <span class="p">[</span><span class="n">sub</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">histories</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submitted_at&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submitted_at&quot;</span><span class="p">)]</span>
                    <span class="n">histories</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submitted_at&quot;</span><span class="p">)]</span>
                <span class="c1"># Only consider students with 2 or more submissions</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># Sort submission times chronologically, keep mapping to histories</span>
                <span class="n">times_histories</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">histories</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">times_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">times_histories</span><span class="p">]</span>
                <span class="n">histories_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">times_histories</span><span class="p">]</span>
                <span class="n">first_time</span> <span class="o">=</span> <span class="n">times_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">second_time</span> <span class="o">=</span> <span class="n">times_sorted</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">first_time</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">second_time</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">due_dt</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">first_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">first_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                    <span class="n">second_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">second_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">first_on_time</span> <span class="o">=</span> <span class="n">first_dt</span> <span class="o">&lt;=</span> <span class="n">due_dt</span>
                <span class="n">second_late</span> <span class="o">=</span> <span class="n">second_dt</span> <span class="o">&gt;</span> <span class="n">due_dt</span>
                <span class="k">if</span> <span class="n">first_on_time</span> <span class="ow">and</span> <span class="n">second_late</span><span class="p">:</span>
                    <span class="c1"># Update late_policy_status from second submission onward to &quot;none&quot;</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">histories_sorted</span><span class="p">)):</span>
                        <span class="n">h</span> <span class="o">=</span> <span class="n">histories_sorted</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                        <span class="c1"># Only update if late_policy_status is not &quot;none&quot;</span>
                        <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;late_policy_status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Use the API to update the submission&#39;s late_policy_status</span>
                                <span class="c1"># Canvas API: PUT /api/v1/courses/:course_id/assignments/:assignment_id/submissions/:user_id</span>
                                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/assignments/</span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">/submissions/</span><span class="si">{</span><span class="n">canvas_id</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span>
                                <span class="p">}</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;submission&quot;</span><span class="p">:</span> <span class="p">{</span>
                                        <span class="s2">&quot;late_policy_status&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                                <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MultipleSubmissions] Updated late_policy_status to &#39;none&#39; for student </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">canvas_id</span><span class="si">}</span><span class="s2">), submission at </span><span class="si">{</span><span class="n">histories_sorted</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;submitted_at&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, status code: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MultipleSubmissions] Failed to update late_policy_status for student </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">canvas_id</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;canvas_id&quot;</span><span class="p">:</span> <span class="n">canvas_id</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="s2">&quot;submissions&quot;</span><span class="p">:</span> <span class="n">times_sorted</span><span class="p">,</span>
                        <span class="s2">&quot;first_on_time&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;second_late&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;assignment_id&quot;</span><span class="p">:</span> <span class="n">aid</span><span class="p">,</span>
                        <span class="s2">&quot;assignment_name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">})</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MultipleSubmissions] Assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> students with first submission on time and second late:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;submissions&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> submissions, first: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;submissions&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, second: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;submissions&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> students with first submission on time and second late.&quot;</span><span class="p">)</span>
            <span class="n">all_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_results</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MultipleSubmissions] Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="grade_resubmissions">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.grade_resubmissions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">grade_resubmissions</span><span class="p">(</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">assignment_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">keep_old_grade</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each assignment, find resubmissions after a graded attempt and prompt to regrade them.</span>

<span class="sd">    If assignment_ids is None, prompt to select from assignments with submissions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_assignment_submissions</span><span class="p">(</span><span class="n">aid</span><span class="p">):</span>
        <span class="n">submissions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/assignments/</span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">/submissions&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;include[]&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;submission_history&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">],</span>
            <span class="s2">&quot;per_page&quot;</span><span class="p">:</span> <span class="mi">100</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">submissions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="n">next_url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">link_header</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Link&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">link_header</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">link_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;rel=&quot;next&quot;&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                        <span class="n">next_url</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&lt;&gt;&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">next_url</span>
            <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">submissions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_selection</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">start</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="n">end</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">total</span><span class="p">:</span>
                            <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">total</span><span class="p">:</span>
                    <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prompt_grade</span><span class="p">(</span><span class="n">old_grade</span><span class="p">,</span> <span class="n">force_keep_old</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keep_old_grade</span> <span class="ow">or</span> <span class="n">force_keep_old</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">old_grade</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New grade (blank=keep </span><span class="si">{</span><span class="n">old_grade</span><span class="si">}</span><span class="s2">, k=keep, s=skip, q=quit): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">old_grade</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">raw</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;keep&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">old_grade</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">raw</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">raw</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">raw</span><span class="p">),</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_entry_score</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="s2">&quot;entered_score&quot;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_entry_time</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">assignment_ids</span><span class="p">:</span>
            <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">assignment_ids</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignments</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;has_submitted_submissions&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;roll call attendance&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;due_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">assignments</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No assignments found with resubmissions.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
                <span class="n">aid</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">aid</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">submissions</span> <span class="o">=</span> <span class="n">_fetch_assignment_submissions</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">need_regrade</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
                    <span class="n">history</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submission_history&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">sorted_hist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
                    <span class="n">last_graded</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">sorted_hist</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="n">_get_entry_score</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                        <span class="n">submitted_at</span> <span class="o">=</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">)</span>
                        <span class="n">graded_at</span> <span class="o">=</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s2">&quot;graded_at&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">submitted_at</span> <span class="ow">and</span> <span class="n">graded_at</span> <span class="ow">and</span> <span class="n">graded_at</span> <span class="o">&gt;</span> <span class="n">submitted_at</span><span class="p">:</span>
                            <span class="n">last_graded</span> <span class="o">=</span> <span class="n">h</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_graded</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">latest</span> <span class="o">=</span> <span class="n">sorted_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">latest_submitted</span> <span class="o">=</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">latest</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">)</span>
                    <span class="n">latest_graded</span> <span class="o">=</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">latest</span><span class="p">,</span> <span class="s2">&quot;graded_at&quot;</span><span class="p">)</span>
                    <span class="n">latest_score</span> <span class="o">=</span> <span class="n">_get_entry_score</span><span class="p">(</span><span class="n">latest</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">latest_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">latest_graded</span> <span class="ow">and</span> <span class="n">latest_submitted</span> <span class="ow">and</span> <span class="n">latest_graded</span> <span class="o">&gt;</span> <span class="n">latest_submitted</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">last_attempt</span> <span class="o">=</span> <span class="n">last_graded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attempt&quot;</span><span class="p">)</span>
                    <span class="n">latest_attempt</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attempt&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">latest_attempt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">last_attempt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">latest_attempt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_attempt</span><span class="p">):</span>
                                <span class="k">continue</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="n">need_regrade</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">need_regrade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">assignment</span><span class="p">[</span><span class="s2">&quot;need_regrade&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">need_regrade</span>
                    <span class="n">filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assignment</span><span class="p">)</span>
            <span class="n">assignments</span> <span class="o">=</span> <span class="n">filtered</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">assignments</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No assignments found with resubmissions.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_due_key</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_at&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
            <span class="n">assignments</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">_due_key</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assignments with resubmissions:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">due</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_at&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;No due date&quot;</span>
                <span class="n">regrade_count</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;need_regrade&quot;</span><span class="p">)</span>
                <span class="n">count_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, Need regrade: </span><span class="si">{</span><span class="n">regrade_count</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">regrade_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">due</span><span class="si">}{</span><span class="n">count_info</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Select assignments (e.g. 1,3-5 or &#39;a&#39; for all, &#39;q&#39; to quit): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sel</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">sel</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">_parse_selection</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">))</span>
                <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">}</span>

        <span class="n">updated</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resub_candidates</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">graded_candidates</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">apply_keep_old_all</span> <span class="o">=</span> <span class="n">keep_old_grade</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">apply_keep_old_all</span><span class="p">:</span>
            <span class="n">keep_all_raw</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Use latest graded score for ungraded resubmissions for all assignments? (y/n) [n]: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">apply_keep_old_all</span> <span class="o">=</span> <span class="n">keep_all_raw</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">assignment_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] Warning: could not load assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">submissions</span> <span class="o">=</span> <span class="n">_fetch_assignment_submissions</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] Warning: failed to list submissions for </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">resub_needed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">resub_work_items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">history_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submission_history&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)]</span>
                <span class="n">with_history</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">history_sizes</span> <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] Assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">submissions</span><span class="p">)</span><span class="si">}</span><span class="s2"> submissions, </span><span class="si">{</span><span class="n">with_history</span><span class="si">}</span><span class="s2"> with history &gt; 1.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
                <span class="n">history</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submission_history&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">student_id</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">student_name</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">student_name</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] Submission history for </span><span class="si">{</span><span class="n">student_name</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">student_id</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">submitted_at</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submitted_at&quot;</span><span class="p">)</span>
                        <span class="n">graded_at</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;graded_at&quot;</span><span class="p">)</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="n">_get_entry_score</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                        <span class="n">attempt</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attempt&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. attempt=</span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2"> submitted_at=</span><span class="si">{</span><span class="n">submitted_at</span><span class="si">}</span><span class="s2"> graded_at=</span><span class="si">{</span><span class="n">graded_at</span><span class="si">}</span><span class="s2"> score=</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">_sort_key</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                    <span class="n">ts</span> <span class="o">=</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">ts</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span>
                <span class="n">sorted_hist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">_sort_key</span><span class="p">)</span>
                <span class="n">last_graded</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">sorted_hist</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">_get_entry_score</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                    <span class="n">submitted_at</span> <span class="o">=</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">)</span>
                    <span class="n">graded_at</span> <span class="o">=</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s2">&quot;graded_at&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">submitted_at</span> <span class="ow">and</span> <span class="n">graded_at</span> <span class="ow">and</span> <span class="n">graded_at</span> <span class="o">&gt;</span> <span class="n">submitted_at</span><span class="p">:</span>
                        <span class="n">last_graded</span> <span class="o">=</span> <span class="n">h</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">last_graded</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">graded_candidates</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">graded_at</span> <span class="o">=</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">last_graded</span><span class="p">,</span> <span class="s2">&quot;graded_at&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">graded_at</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">resub_entry</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">latest</span> <span class="o">=</span> <span class="n">sorted_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">latest_submitted</span> <span class="o">=</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">latest</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">)</span>
                <span class="n">latest_graded</span> <span class="o">=</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">latest</span><span class="p">,</span> <span class="s2">&quot;graded_at&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_get_entry_score</span><span class="p">(</span><span class="n">latest</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">latest_graded</span> <span class="ow">and</span> <span class="n">latest_submitted</span> <span class="ow">and</span> <span class="n">latest_graded</span> <span class="o">&gt;</span> <span class="n">latest_submitted</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">last_attempt</span> <span class="o">=</span> <span class="n">last_graded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attempt&quot;</span><span class="p">)</span>
                <span class="n">latest_attempt</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attempt&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">latest_attempt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">last_attempt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">latest_attempt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_attempt</span><span class="p">):</span>
                            <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">sorted_hist</span><span class="p">):</span>
                    <span class="n">submitted_at</span> <span class="o">=</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">submitted_at</span> <span class="ow">and</span> <span class="n">submitted_at</span> <span class="o">&gt;</span> <span class="n">graded_at</span><span class="p">:</span>
                        <span class="n">resub_entry</span> <span class="o">=</span> <span class="n">h</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">resub_entry</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">resub_needed</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">resub_candidates</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">old_grade</span> <span class="o">=</span> <span class="n">_get_entry_score</span><span class="p">(</span><span class="n">last_graded</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">old_grade</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">resub_work_items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sub</span><span class="p">,</span> <span class="n">old_grade</span><span class="p">,</span> <span class="n">resub_entry</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] Assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">resub_needed</span><span class="si">}</span><span class="s2"> need regrade after filtering.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resub_work_items</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">assignment_keep_old</span> <span class="o">=</span> <span class="n">apply_keep_old_all</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">apply_keep_old_all</span><span class="p">:</span>
                <span class="n">keep_raw</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Use latest graded score for ungraded resubmissions in this assignment? (y/n) [n]: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">assignment_keep_old</span> <span class="o">=</span> <span class="n">keep_raw</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sub</span><span class="p">,</span> <span class="n">old_grade</span><span class="p">,</span> <span class="n">resub_entry</span> <span class="ow">in</span> <span class="n">resub_work_items</span><span class="p">:</span>
                <span class="n">student_id</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">student_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">student_name</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">student_name</span><span class="p">:</span>
                    <span class="n">user_info</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">student_name</span> <span class="o">=</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">resub_time</span> <span class="o">=</span> <span class="n">_get_entry_time</span><span class="p">(</span><span class="n">resub_entry</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">)</span>
                    <span class="n">resub_str</span> <span class="o">=</span> <span class="n">resub_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">resub_time</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] </span><span class="si">{</span><span class="n">student_name</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">student_id</span><span class="si">}</span><span class="s2"> resubmitted after grade </span><span class="si">{</span><span class="n">old_grade</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">resub_str</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">new_grade</span><span class="p">,</span> <span class="n">should_quit</span> <span class="o">=</span> <span class="n">_prompt_grade</span><span class="p">(</span><span class="n">old_grade</span><span class="p">,</span> <span class="n">force_keep_old</span><span class="o">=</span><span class="n">assignment_keep_old</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">should_quit</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">updated</span>
                <span class="k">if</span> <span class="n">new_grade</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/assignments/</span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">/submissions/</span><span class="si">{</span><span class="n">student_id</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;submission&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;posted_grade&quot;</span><span class="p">:</span> <span class="n">new_grade</span><span class="p">}}</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                        <span class="n">updated</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;assignment_id&quot;</span><span class="p">:</span> <span class="n">aid</span><span class="p">,</span> <span class="s2">&quot;student_id&quot;</span><span class="p">:</span> <span class="n">student_id</span><span class="p">,</span> <span class="s2">&quot;grade&quot;</span><span class="p">:</span> <span class="n">new_grade</span><span class="p">})</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] Updated </span><span class="si">{</span><span class="n">student_name</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">student_id</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_grade</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] Failed to update </span><span class="si">{</span><span class="n">student_name</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">student_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] Failed to update </span><span class="si">{</span><span class="n">student_name</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">student_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] Candidates with graded attempts: </span><span class="si">{</span><span class="n">graded_candidates</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] Candidates with resubmissions after grade: </span><span class="si">{</span><span class="n">resub_candidates</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] Updated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">updated</span><span class="p">)</span><span class="si">}</span><span class="s2"> resubmission grade(s).&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">updated</span><span class="p">)</span><span class="si">}</span><span class="s2"> resubmission grade(s).&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updated</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Resubmissions] Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying resubmission grades: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="list_and_export_canvas_rubrics">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.list_and_export_canvas_rubrics">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_and_export_canvas_rubrics</span><span class="p">(</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">assignment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">export_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all unique rubrics used in a Canvas course (optionally for a specific assignment) and export to TXT/CSV file.</span>
<span class="sd">    Uses Canvas API GET /api/v1/courses/:course_id/rubrics/:id for full rubric info.</span>
<span class="sd">    If export_path is provided and ends with .csv, downloads the official Canvas rubric CSV template and fills it with rubric info.</span>
<span class="sd">    The exported CSV matches the Canvas rubric import template (GET /api/v1/rubrics/upload_template).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="n">rubric_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">rubric_details</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Helper to fetch rubric details via API</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">fetch_rubric</span><span class="p">(</span><span class="n">rubric_id</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/rubrics/</span><span class="si">{</span><span class="n">rubric_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;include[]&quot;</span><span class="p">:</span> <span class="s2">&quot;associations&quot;</span><span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">assignment_id</span><span class="p">:</span>
            <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>
            <span class="n">rubric_settings</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;rubric_settings&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">rubric_id</span> <span class="o">=</span> <span class="n">rubric_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;rubric_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rubric_id</span><span class="p">:</span>
                <span class="n">rubric_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rubric_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignments</span><span class="p">():</span>
                <span class="n">rubric_settings</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;rubric_settings&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">rubric_id</span> <span class="o">=</span> <span class="n">rubric_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="s2">&quot;rubric_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rubric_id</span><span class="p">:</span>
                    <span class="n">rubric_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rubric_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rubric_ids</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Rubrics] No rubrics found in this course.&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span> <span class="k">else</span> <span class="s2">&quot;[Rubrics] No rubrics found in this course.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Fetch rubric details for each rubric_id</span>
        <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">rubric_ids</span><span class="p">:</span>
            <span class="n">rubric</span> <span class="o">=</span> <span class="n">fetch_rubric</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rubric</span><span class="p">:</span>
                <span class="n">rubric_details</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">rubric</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rubric_details</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Rubrics] No rubric details found.&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span> <span class="k">else</span> <span class="s2">&quot;[Rubrics] No rubric details found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Print rubric info in Canvas API assessment format</span>
        <span class="k">for</span> <span class="n">rid</span><span class="p">,</span> <span class="n">rubric</span> <span class="ow">in</span> <span class="n">rubric_details</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">rubric</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Rubric ID: </span><span class="si">{</span><span class="n">rid</span><span class="si">}</span><span class="s2"> | Title: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Format for assessmentRubricAssessmentsController#create:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;POST /api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/rubric_associations/</span><span class="si">{</span><span class="n">rid</span><span class="si">}</span><span class="s2">/rubric_assessments&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rubric_assessment[user_id]: &lt;user_id&gt;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rubric_assessment[assessment_type]: grading|peer_review|provisional_grade&quot;</span><span class="p">)</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="n">rubric</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">criterion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">crit_id</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">long_desc</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;long_description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  criterion_</span><span class="si">{</span><span class="n">crit_id</span><span class="si">}</span><span class="s2">[points]: &lt;points_awarded&gt;  # </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">points</span><span class="si">}</span><span class="s2"> pts)&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  criterion_</span><span class="si">{</span><span class="n">crit_id</span><span class="si">}</span><span class="s2">[comments]: &lt;comments&gt;      # </span><span class="si">{</span><span class="n">long_desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ratings</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ratings&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">for</span> <span class="n">rating</span> <span class="ow">in</span> <span class="n">ratings</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     - Rating: </span><span class="si">{</span><span class="n">rating</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">rating</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;points&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> pts&quot;</span><span class="p">)</span>

        <span class="c1"># Export to file if requested</span>
        <span class="k">if</span> <span class="n">export_path</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">export_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
                <span class="c1"># Download Canvas rubric template</span>
                <span class="n">template_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/rubrics/upload_template&quot;</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">template_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Rubrics] Failed to download rubric template.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="n">template_csv</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>
                <span class="n">template_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">template_csv</span><span class="p">))</span>
                <span class="n">template_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">template_reader</span><span class="p">)</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">template_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Find correct column names for rubric title and criterion description</span>
                <span class="n">rubric_title_col</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">criterion_desc_col</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">points_col</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">long_desc_col</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">rating_desc_col</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">rating_points_col</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
                    <span class="n">col_lower</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;rubric name&quot;</span> <span class="ow">in</span> <span class="n">col_lower</span> <span class="ow">or</span> <span class="s2">&quot;rubric title&quot;</span> <span class="ow">in</span> <span class="n">col_lower</span><span class="p">:</span>
                        <span class="n">rubric_title_col</span> <span class="o">=</span> <span class="n">idx</span>
                    <span class="k">elif</span> <span class="s2">&quot;criterion description&quot;</span> <span class="ow">in</span> <span class="n">col_lower</span><span class="p">:</span>
                        <span class="n">criterion_desc_col</span> <span class="o">=</span> <span class="n">idx</span>
                    <span class="k">elif</span> <span class="n">col_lower</span> <span class="o">==</span> <span class="s2">&quot;points&quot;</span><span class="p">:</span>
                        <span class="n">points_col</span> <span class="o">=</span> <span class="n">idx</span>
                    <span class="k">elif</span> <span class="s2">&quot;long description&quot;</span> <span class="ow">in</span> <span class="n">col_lower</span><span class="p">:</span>
                        <span class="n">long_desc_col</span> <span class="o">=</span> <span class="n">idx</span>
                    <span class="k">elif</span> <span class="s2">&quot;rating description&quot;</span> <span class="ow">in</span> <span class="n">col_lower</span><span class="p">:</span>
                        <span class="n">rating_desc_col</span> <span class="o">=</span> <span class="n">idx</span>
                    <span class="k">elif</span> <span class="s2">&quot;rating points&quot;</span> <span class="ow">in</span> <span class="n">col_lower</span><span class="p">:</span>
                        <span class="n">rating_points_col</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="n">rubric_rows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">rid</span><span class="p">,</span> <span class="n">rubric</span> <span class="ow">in</span> <span class="n">rubric_details</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">rubric</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">criterion</span> <span class="ow">in</span> <span class="n">rubric</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="n">desc</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">long_desc</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;long_description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">points</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">ratings</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ratings&quot;</span><span class="p">,</span> <span class="p">[])</span>
                        <span class="k">if</span> <span class="n">ratings</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">rating</span> <span class="ow">in</span> <span class="n">ratings</span><span class="p">:</span>
                                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">header</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">rubric_title_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">row</span><span class="p">[</span><span class="n">rubric_title_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
                                <span class="k">if</span> <span class="n">criterion_desc_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">row</span><span class="p">[</span><span class="n">criterion_desc_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>
                                <span class="k">if</span> <span class="n">points_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">row</span><span class="p">[</span><span class="n">points_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">rating</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points&quot;</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">long_desc_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">row</span><span class="p">[</span><span class="n">long_desc_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_desc</span>
                                <span class="k">if</span> <span class="n">rating_desc_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">row</span><span class="p">[</span><span class="n">rating_desc_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">rating</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">rating_points_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">row</span><span class="p">[</span><span class="n">rating_points_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">rating</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                <span class="n">rubric_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">header</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">rubric_title_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">row</span><span class="p">[</span><span class="n">rubric_title_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
                            <span class="k">if</span> <span class="n">criterion_desc_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">row</span><span class="p">[</span><span class="n">criterion_desc_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>
                            <span class="k">if</span> <span class="n">points_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">row</span><span class="p">[</span><span class="n">points_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span>
                            <span class="k">if</span> <span class="n">long_desc_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">row</span><span class="p">[</span><span class="n">long_desc_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_desc</span>
                            <span class="n">rubric_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">export_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rubric_rows</span><span class="p">:</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rubrics exported to </span><span class="si">{</span><span class="n">export_path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;[Rubrics] Rubrics exported to </span><span class="si">{</span><span class="n">export_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">export_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">rid</span><span class="p">,</span> <span class="n">rubric</span> <span class="ow">in</span> <span class="n">rubric_details</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="n">rubric</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rubric ID: </span><span class="si">{</span><span class="n">rid</span><span class="si">}</span><span class="s2"> | Title: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Format for assessmentRubricAssessmentsController#create:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;POST /api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/rubric_associations/</span><span class="si">{</span><span class="n">rid</span><span class="si">}</span><span class="s2">/rubric_assessments</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rubric_assessment[user_id]: &lt;user_id&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rubric_assessment[assessment_type]: grading|peer_review|provisional_grade</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">criterion</span> <span class="ow">in</span> <span class="n">rubric</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                            <span class="n">crit_id</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="n">desc</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="n">long_desc</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;long_description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="n">points</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  criterion_</span><span class="si">{</span><span class="n">crit_id</span><span class="si">}</span><span class="s2">[points]: &lt;points_awarded&gt;  # </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">points</span><span class="si">}</span><span class="s2"> pts)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  criterion_</span><span class="si">{</span><span class="n">crit_id</span><span class="si">}</span><span class="s2">[comments]: &lt;comments&gt;      # </span><span class="si">{</span><span class="n">long_desc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">ratings</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ratings&quot;</span><span class="p">,</span> <span class="p">[])</span>
                            <span class="k">for</span> <span class="n">rating</span> <span class="ow">in</span> <span class="n">ratings</span> <span class="ow">or</span> <span class="p">[]:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     - Rating: </span><span class="si">{</span><span class="n">rating</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">rating</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;points&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> pts</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rubrics exported to </span><span class="si">{</span><span class="n">export_path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;[Rubrics] Rubrics exported to </span><span class="si">{</span><span class="n">export_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Return rubric details as a list</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">rubric</span> <span class="k">for</span> <span class="n">rubric</span> <span class="ow">in</span> <span class="n">rubric_details</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error listing or exporting rubrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;[Rubrics] Error listing or exporting rubrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="import_canvas_rubrics">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.import_canvas_rubrics">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">import_canvas_rubrics</span><span class="p">(</span>
    <span class="n">rubric_file</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Import rubrics to Canvas course using the official rubric CSV upload API.</span>
<span class="sd">    If rubric_file is a CSV, directly upload it and print status.</span>
<span class="sd">    If rubric_file is TXT, download the rubric template, fill it, and upload.</span>
<span class="sd">    Uses POST /api/v1/courses/:course_id/rubrics/upload.</span>
<span class="sd">    After import, fetches the status of each rubric import via GET /api/v1/courses/:course_id/rubrics/upload/:id.</span>
<span class="sd">    Returns a list of results for each rubric imported, including status details.</span>
<span class="sd">    Format matches the export function: uses the Canvas rubric template for CSV, and TXT for plain text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">rubric_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
            <span class="c1"># Directly upload the CSV file</span>
            <span class="n">upload_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/rubrics/upload&quot;</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attachment&#39;</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="n">rubric_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)}</span>
            <span class="n">upload_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="n">upload_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">upload_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">upload_headers</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
            <span class="n">files</span><span class="p">[</span><span class="s1">&#39;attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">import_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">status_detail</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">upload_resp</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resp_json</span> <span class="o">=</span> <span class="n">upload_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="n">import_id</span> <span class="o">=</span> <span class="n">resp_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">resp_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;import_id&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">import_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricImport] Imported rubric CSV to course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Imported rubric CSV to course.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricImport] Failed to import rubric CSV: </span><span class="si">{</span><span class="n">upload_resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to import rubric CSV.&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;failed (</span><span class="si">{</span><span class="n">upload_resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">results</span>
            <span class="c1"># After import, get status of import if import_id is available</span>
            <span class="k">if</span> <span class="n">import_id</span><span class="p">:</span>
                <span class="n">status_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/rubrics/upload/</span><span class="si">{</span><span class="n">import_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">status_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
                <span class="n">status_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">status_headers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status_resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">status_json</span> <span class="o">=</span> <span class="n">status_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                        <span class="n">status_detail</span> <span class="o">=</span> <span class="n">status_json</span>
                        <span class="n">status_str</span> <span class="o">=</span> <span class="n">status_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow_state&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;imported&quot;</span><span class="p">,</span> <span class="s2">&quot;import_id&quot;</span><span class="p">:</span> <span class="n">import_id</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="n">status_detail</span><span class="p">})</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricImport] Import status: </span><span class="si">{</span><span class="n">status_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Import status: </span><span class="si">{</span><span class="n">status_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;imported&quot;</span><span class="p">,</span> <span class="s2">&quot;import_id&quot;</span><span class="p">:</span> <span class="n">import_id</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricImport] Imported rubric CSV, but could not parse status detail.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;imported&quot;</span><span class="p">,</span> <span class="s2">&quot;import_id&quot;</span><span class="p">:</span> <span class="n">import_id</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricImport] Imported rubric CSV, but failed to fetch import status (</span><span class="si">{</span><span class="n">status_resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;imported&quot;</span><span class="p">,</span> <span class="s2">&quot;import_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">results</span>

        <span class="c1"># TXT format: download template, fill, and upload</span>
        <span class="c1"># Download the rubric CSV template</span>
        <span class="n">template_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/rubrics/upload_template&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">template_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricImport] Failed to download rubric template: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to download rubric template.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">template_csv</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>

        <span class="c1"># Parse rubric_file (TXT) and fill template rows</span>
        <span class="n">rubrics_to_import</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rubric_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">current_title</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rubric:&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">current_title</span> <span class="ow">and</span> <span class="n">criteria</span><span class="p">:</span>
                    <span class="n">rubrics_to_import</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">current_title</span><span class="p">,</span> <span class="s2">&quot;criteria&quot;</span><span class="p">:</span> <span class="n">criteria</span><span class="p">})</span>
                <span class="n">current_title</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">criteria</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="s2">&quot;|&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">long_desc</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">criteria</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">desc</span><span class="p">,</span>
                        <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">pts</span><span class="p">,</span>
                        <span class="s2">&quot;long_description&quot;</span><span class="p">:</span> <span class="n">long_desc</span>
                    <span class="p">})</span>
        <span class="k">if</span> <span class="n">current_title</span> <span class="ow">and</span> <span class="n">criteria</span><span class="p">:</span>
            <span class="n">rubrics_to_import</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">current_title</span><span class="p">,</span> <span class="s2">&quot;criteria&quot;</span><span class="p">:</span> <span class="n">criteria</span><span class="p">})</span>

        <span class="c1"># For each rubric, fill the template and upload</span>
        <span class="k">for</span> <span class="n">rubric</span> <span class="ow">in</span> <span class="n">rubrics_to_import</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">rubric</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="n">rubric</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">]</span>
            <span class="c1"># Fill template CSV rows</span>
            <span class="n">template_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">template_csv</span><span class="p">))</span>
            <span class="n">template_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">template_reader</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">template_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rubric_rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">crit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">header</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">col_idx</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
                    <span class="n">col_lower</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;rubric title&quot;</span> <span class="ow">in</span> <span class="n">col_lower</span><span class="p">:</span>
                        <span class="n">row</span><span class="p">[</span><span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
                    <span class="k">elif</span> <span class="s2">&quot;criterion description&quot;</span> <span class="ow">in</span> <span class="n">col_lower</span><span class="p">:</span>
                        <span class="n">row</span><span class="p">[</span><span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">crit</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s2">&quot;points&quot;</span> <span class="o">==</span> <span class="n">col_lower</span><span class="p">:</span>
                        <span class="n">row</span><span class="p">[</span><span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">crit</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s2">&quot;long description&quot;</span> <span class="ow">in</span> <span class="n">col_lower</span><span class="p">:</span>
                        <span class="n">row</span><span class="p">[</span><span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">crit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;long_description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">rubric_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="c1"># Write filled CSV to temp file</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w+&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpf</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">tmpf</span><span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rubric_rows</span><span class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">tmpf</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">temp_csv_path</span> <span class="o">=</span> <span class="n">tmpf</span><span class="o">.</span><span class="n">name</span>

            <span class="c1"># Upload rubric CSV to Canvas</span>
            <span class="n">upload_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/rubrics/upload&quot;</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attachment&#39;</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_csv_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)}</span>
            <span class="n">upload_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="n">upload_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">upload_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">upload_headers</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
            <span class="n">files</span><span class="p">[</span><span class="s1">&#39;attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_csv_path</span><span class="p">)</span>

            <span class="n">import_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">status_detail</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">upload_resp</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resp_json</span> <span class="o">=</span> <span class="n">upload_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="n">import_id</span> <span class="o">=</span> <span class="n">resp_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">resp_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;import_id&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">import_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricImport] Imported rubric &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; to course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Imported rubric &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; to course.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricImport] Failed to import rubric &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">upload_resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to import rubric &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;failed (</span><span class="si">{</span><span class="n">upload_resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">})</span>
                <span class="k">continue</span>

            <span class="c1"># After import, get status of import if import_id is available</span>
            <span class="k">if</span> <span class="n">import_id</span><span class="p">:</span>
                <span class="n">status_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/rubrics/upload/</span><span class="si">{</span><span class="n">import_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">status_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
                <span class="n">status_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">status_headers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status_resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">status_json</span> <span class="o">=</span> <span class="n">status_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                        <span class="n">status_detail</span> <span class="o">=</span> <span class="n">status_json</span>
                        <span class="n">status_str</span> <span class="o">=</span> <span class="n">status_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow_state&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;imported&quot;</span><span class="p">,</span> <span class="s2">&quot;import_id&quot;</span><span class="p">:</span> <span class="n">import_id</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="n">status_detail</span><span class="p">})</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricImport] Import status for &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">status_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Import status for &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">status_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;imported&quot;</span><span class="p">,</span> <span class="s2">&quot;import_id&quot;</span><span class="p">:</span> <span class="n">import_id</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricImport] Imported rubric &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;, but could not parse status detail.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;imported&quot;</span><span class="p">,</span> <span class="s2">&quot;import_id&quot;</span><span class="p">:</span> <span class="n">import_id</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricImport] Imported rubric &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;, but failed to fetch import status (</span><span class="si">{</span><span class="n">status_resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;imported&quot;</span><span class="p">,</span> <span class="s2">&quot;import_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricImport] Error importing rubrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error importing rubrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="update_canvas_rubrics_for_assignments">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.update_canvas_rubrics_for_assignments">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_canvas_rubrics_for_assignments</span><span class="p">(</span>
    <span class="n">assignment_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rubric_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="n">CANVAS_DEFAULT_ASSIGNMENT_CATEGORY</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the rubric for a range of assignments in a Canvas course.</span>
<span class="sd">    If assignment_ids is None, list all assignments in the category and prompt user to select.</span>
<span class="sd">    If rubric_id is None, list all rubrics in the course and prompt user to select.</span>

<span class="sd">    Uses Canvas API GET /api/v1/courses/:course_id/rubrics to list all possible rubrics.</span>

<span class="sd">    Args:</span>
<span class="sd">        assignment_ids (list or None): List of assignment IDs to update, or None to prompt user.</span>
<span class="sd">        rubric_id (str or int or None): The rubric ID to associate, or None to prompt user.</span>
<span class="sd">        api_url (str): Canvas API base URL.</span>
<span class="sd">        api_key (str): Canvas API key.</span>
<span class="sd">        course_id (str or int): Canvas course ID.</span>
<span class="sd">        category (str): Assignment group/category to filter.</span>
<span class="sd">        verbose (bool): Print more details.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: {assignment_id: status} for each assignment updated.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Quitting...&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use signal.SIGALRM only if available (not on Windows)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting due to timeout.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># On platforms without SIGALRM (e.g., Windows), just use input without timeout</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>

        <span class="c1"># If assignment_ids is None, list all assignments in category and prompt user</span>
        <span class="k">if</span> <span class="n">assignment_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">assignment_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">assignment_groups</span><span class="p">:</span>
                <span class="n">group_name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">category</span> <span class="ow">and</span> <span class="n">group_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                    <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
                        <span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;due_at&#39;</span><span class="p">)</span>
                    <span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">assignments</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No assignments found in category.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="c1"># Sort by due date</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">due_sort_key</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_at&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span>
            <span class="n">assignments</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">due_sort_key</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assignments in category:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">due</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;due_at&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;No due date&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">due</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;Enter the number(s) of the assignment(s) to update (e.g. 1,3-5 or &#39;a&#39; for all, or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">):</span>
                <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                            <span class="n">selected</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid selection.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">{}</span>
                <span class="n">assignment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>

        <span class="c1"># If rubric_id is None, list all rubrics using GET /api/v1/courses/:course_id/rubrics</span>
        <span class="k">if</span> <span class="n">rubric_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/rubrics&quot;</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">rubrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">rubrics</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rubrics</span><span class="p">)</span><span class="si">}</span><span class="s2"> rubrics in this course.&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;[RubricUpdate] Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rubrics</span><span class="p">)</span><span class="si">}</span><span class="s2"> rubrics in this course.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to fetch rubrics from Canvas course.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rubrics</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No rubrics found in this course.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rubrics in this course:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rubrics</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. Rubric ID: </span><span class="si">{</span><span class="n">rid</span><span class="si">}</span><span class="s2"> | Title: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;Enter the number of the rubric to use (or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rubrics</span><span class="p">):</span>
                <span class="n">rubric_id</span> <span class="o">=</span> <span class="n">rubrics</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid selection.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>

        <span class="c1"># Update rubric for each assignment</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">assignment_ids</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/assignments/</span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;assignment&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;rubric_settings&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">rubric_id</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;rubric_id&quot;</span><span class="p">:</span> <span class="n">rubric_id</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">):</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;updated&quot;</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricUpdate] Assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: rubric updated to </span><span class="si">{</span><span class="n">rubric_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;failed (</span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricUpdate] Assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: failed to update rubric (</span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RubricUpdate] Assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating rubrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="list_and_download_canvas_grading_standards">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.list_and_download_canvas_grading_standards">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_and_download_canvas_grading_standards</span><span class="p">(</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all grading standards (grading schemes) for a Canvas course and allow user to select one to download as JSON to the current folder.</span>

<span class="sd">    Args:</span>
<span class="sd">        api_url (str): Canvas API base URL.</span>
<span class="sd">        api_key (str): Canvas API key.</span>
<span class="sd">        course_id (str or int): Canvas course ID.</span>
<span class="sd">        verbose (bool): Print more details.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The selected grading standard object, or None if cancelled.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/grading_standards&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">standards</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">standards</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No grading standards found for this course.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grading standards available in this course:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">std</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">standards</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">std</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">std</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, Context: </span><span class="si">{</span><span class="n">std</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context_type&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Grading scheme: </span><span class="si">{</span><span class="n">std</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grading_scheme&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter the number of the grading standard to download (or &#39;q&#39; to quit): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cancelled.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">standards</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="n">standards</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">std_id</span> <span class="o">=</span> <span class="n">selected</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                <span class="c1"># Fetch full grading standard details</span>
                <span class="n">detail_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/grading_standards/</span><span class="si">{</span><span class="n">std_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">detail_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">detail_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="n">detail_resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="n">detail</span> <span class="o">=</span> <span class="n">detail_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;grading_standard_</span><span class="si">{</span><span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.json&quot;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded grading standard &#39;</span><span class="si">{</span><span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; to </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">detail</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid selection. Please enter a valid number or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error listing or downloading grading standards: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="add_canvas_grading_scheme">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.add_canvas_grading_scheme">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_canvas_grading_scheme</span><span class="p">(</span>
    <span class="n">grading_scheme_file</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a grading scheme (grading standard) to a Canvas course from a JSON file.</span>
<span class="sd">    The JSON file should contain:</span>
<span class="sd">    {</span>
<span class="sd">        &quot;title&quot;: &quot;Scheme Name&quot;,</span>
<span class="sd">        &quot;grading_scheme&quot;: [</span>
<span class="sd">            {&quot;name&quot;: &quot;A&quot;, &quot;value&quot;: 0.9},</span>
<span class="sd">            {&quot;name&quot;: &quot;B&quot;, &quot;value&quot;: 0.8},</span>
<span class="sd">            ...</span>
<span class="sd">        ]</span>
<span class="sd">    }</span>
<span class="sd">    Returns the created grading standard object or None on failure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">grading_scheme_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
        <span class="n">grading_scheme</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grading_scheme&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">grading_scheme</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[GradingScheme] JSON must contain &#39;title&#39; and &#39;grading_scheme&#39; fields.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;JSON must contain &#39;title&#39; and &#39;grading_scheme&#39; fields.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/grading_standards&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s2">&quot;grading_scheme_entry&quot;</span><span class="p">:</span> <span class="n">grading_scheme</span>
        <span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradingScheme] Grading scheme &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; added to course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grading scheme &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; added to course.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradingScheme] Failed to add grading scheme: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to add grading scheme: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GradingScheme] Error adding grading scheme: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error adding grading scheme: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="download_and_check_student_submissions">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.download_and_check_student_submissions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">download_and_check_student_submissions</span><span class="p">(</span>
    <span class="n">student_canvas_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dest_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">ocr_service</span><span class="o">=</span><span class="n">DEFAULT_OCR_METHOD</span><span class="p">,</span>
    <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span>
    <span class="n">db_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download the latest submission file of a student for each assignment, extract text, check for similarity,</span>
<span class="sd">    and if two files are highly similar, send a warning message to the student.</span>
<span class="sd">    If student_canvas_id is None, list all students and allow user to choose a range of one or more students to check,</span>
<span class="sd">    allow user to select all students, allow user to quit, if no response after 60 seconds then use the default option of selecting all students.</span>
<span class="sd">    Only the latest submission (by submission time) for each assignment is considered.</span>
<span class="sd">    Downloaded file is named: &lt;student name&gt;_&lt;canvas id&gt;_&lt;assignment id&gt;_&lt;submitted time&gt;_&lt;status&gt;.&lt;ext&gt;</span>
<span class="sd">    Also saves the similarity check results in the database entry for the student if db_path is provided.</span>
<span class="sd">    Now saves downloaded file to a subfolder named &lt;student name&gt;_&lt;student id&gt; in the dest_dir (create if not exist).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Using default: all students.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use signal.SIGALRM only if available (not on Windows)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># On platforms without SIGALRM (e.g., Windows), just use input without timeout</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># Load student database for Canvas ID -&gt; Name mapping if available</span>
    <span class="n">canvasid_to_name</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">canvasid_to_sid</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">db_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">db_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">students_db</span> <span class="o">=</span> <span class="n">load_database</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">students_db</span><span class="p">:</span>
                <span class="n">canvas_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Canvas ID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Student ID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">canvasid_to_name</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">sid</span><span class="p">:</span>
                    <span class="n">canvasid_to_sid</span><span class="p">[</span><span class="n">canvas_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">sid</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">canvasid_to_name</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">canvasid_to_sid</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
    <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>

    <span class="c1"># If student_canvas_id is None, list all students and allow user to select</span>
    <span class="n">student_canvas_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">student_canvas_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">people</span> <span class="o">=</span> <span class="n">list_canvas_people</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">course_id</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">students</span> <span class="o">=</span> <span class="n">people</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active_students&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">students</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No active students found.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Active students:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">), Canvas ID: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;Enter student numbers to check (e.g. 1-5,7,9 or &#39;a&#39; for all, or &#39;q&#39; to quit, default &#39;a&#39; in 60s): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;a&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">):</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">students</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                            <span class="n">selected</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">students</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid selection. Try again or &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">student_canvas_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">students</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;canvas_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">student_canvas_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">student_canvas_id</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">student_canvas_id</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">student_canvas_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">dest_dir</span><span class="p">:</span>
        <span class="n">dest_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;student_submissions&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">student_canvas_id</span> <span class="ow">in</span> <span class="n">student_canvas_ids</span><span class="p">:</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignments</span><span class="p">())</span>
        <span class="n">pdf_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">file_info</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get student name and student id from database if possible, else from Canvas</span>
        <span class="n">student_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">student_sid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">canvas_id_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">student_canvas_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">canvasid_to_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">canvas_id_str</span><span class="p">):</span>
            <span class="n">student_name</span> <span class="o">=</span> <span class="n">canvasid_to_name</span><span class="p">[</span><span class="n">canvas_id_str</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">student_canvas_id</span><span class="p">)</span>
                <span class="n">student_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;student_</span><span class="si">{</span><span class="n">student_canvas_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">student_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;student_</span><span class="si">{</span><span class="n">student_canvas_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">canvasid_to_sid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">canvas_id_str</span><span class="p">):</span>
            <span class="n">student_sid</span> <span class="o">=</span> <span class="n">canvasid_to_sid</span><span class="p">[</span><span class="n">canvas_id_str</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">student_sid</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>

        <span class="c1"># Create subfolder for this student</span>
        <span class="n">safe_student_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^\w\s-]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">student_name</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">safe_student_sid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^\w\s-]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">student_sid</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">student_subfolder</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_student_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">safe_student_sid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">student_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">student_subfolder</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">student_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Download only the latest PDF submission for each assignment</span>
        <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Checking assignments for </span><span class="si">{</span><span class="n">student_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get_submission</span><span class="p">(</span><span class="n">student_canvas_id</span><span class="p">)</span>
                <span class="c1"># Find the latest submission attempt by submitted_at</span>
                <span class="n">latest_attachment</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">latest_time</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">latest_status</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># Check submission_history if available</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;submission_history&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sub</span><span class="o">.</span><span class="n">submission_history</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">submission_history</span><span class="p">:</span>
                        <span class="n">submitted_at</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submitted_at&quot;</span><span class="p">)</span>
                        <span class="n">workflow_state</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow_state&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">submitted_at</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">sub_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">submitted_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">attachments</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attachments&quot;</span><span class="p">,</span> <span class="p">[])</span>
                            <span class="n">pdf_attachments</span> <span class="o">=</span> <span class="p">[</span><span class="n">att</span> <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">attachments</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)]</span>
                            <span class="k">if</span> <span class="n">pdf_attachments</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">latest_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sub_time</span> <span class="o">&gt;</span> <span class="n">latest_time</span><span class="p">:</span>
                                    <span class="n">latest_time</span> <span class="o">=</span> <span class="n">sub_time</span>
                                    <span class="n">latest_attachment</span> <span class="o">=</span> <span class="n">pdf_attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">latest_status</span> <span class="o">=</span> <span class="n">workflow_state</span>
                <span class="c1"># Fallback: check attachments directly on submission object</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;attachments&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sub</span><span class="o">.</span><span class="n">attachments</span><span class="p">:</span>
                    <span class="n">attachments</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">attachments</span>
                    <span class="n">pdf_attachments</span> <span class="o">=</span> <span class="p">[</span><span class="n">att</span> <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">attachments</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">pdf_attachments</span><span class="p">:</span>
                        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;submitted_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">workflow_state</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;workflow_state&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">submitted_at</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">sub_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">submitted_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">sub_time</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sub_time</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">latest_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sub_time</span> <span class="ow">and</span> <span class="p">(</span><span class="n">latest_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sub_time</span> <span class="o">&gt;</span> <span class="n">latest_time</span><span class="p">)):</span>
                            <span class="n">latest_time</span> <span class="o">=</span> <span class="n">sub_time</span>
                            <span class="n">latest_attachment</span> <span class="o">=</span> <span class="n">pdf_attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">latest_status</span> <span class="o">=</span> <span class="n">workflow_state</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">latest_attachment</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">att</span> <span class="o">=</span> <span class="n">latest_attachment</span>
                <span class="n">url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">orig_filename</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">assignment</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">student_canvas_id</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
                <span class="c1"># Format: &lt;student name&gt;_&lt;canvas id&gt;_&lt;assignment id&gt;_&lt;submitted time&gt;_&lt;status&gt;.&lt;ext&gt;</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">orig_filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">submitted_time_str</span> <span class="o">=</span> <span class="n">latest_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">latest_time</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
                <span class="n">status_str</span> <span class="o">=</span> <span class="n">latest_status</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span>
                <span class="n">out_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_student_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">student_canvas_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">assignment</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">submitted_time_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">status_str</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">student_dir</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_path</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">pdf_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
                <span class="n">file_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;assignment_id&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;assignment_name&quot;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">out_path</span>
                <span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[StudentSubmissions] Error downloading for assignment </span><span class="si">{</span><span class="n">assignment</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pdf_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[StudentSubmissions] No PDF submissions found for student </span><span class="si">{</span><span class="n">student_canvas_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No PDF submissions found for this student.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Extract text from all PDFs</span>
        <span class="n">extracted_texts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">file_info</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Extracting text for </span><span class="si">{</span><span class="n">student_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">pdf_path</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;file_path&quot;</span><span class="p">]</span>
            <span class="n">txt_path</span> <span class="o">=</span> <span class="n">pdf_path</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_text_</span><span class="si">{</span><span class="n">ocr_service</span><span class="si">}</span><span class="s2">.txt&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">txt_path</span><span class="p">):</span>
                <span class="n">txt_path</span> <span class="o">=</span> <span class="n">extract_text_from_scanned_pdf</span><span class="p">(</span>
                    <span class="n">pdf_path</span><span class="p">,</span>
                    <span class="n">txt_output_path</span><span class="o">=</span><span class="n">txt_path</span><span class="p">,</span>
                    <span class="n">service</span><span class="o">=</span><span class="n">ocr_service</span><span class="p">,</span>
                    <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">,</span>
                    <span class="n">simple_text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">txt_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">txt_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">norm_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">extracted_texts</span><span class="p">[</span><span class="n">pdf_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_text</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extracted_texts</span><span class="p">[</span><span class="n">pdf_path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Compare all pairs for similarity</span>
        <span class="n">pdf_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extracted_texts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">extracted_texts</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pdf_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[StudentSubmissions] Less than 2 submissions to compare for student </span><span class="si">{</span><span class="n">student_canvas_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Less than 2 submissions to compare.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">tfidf_vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
        <span class="n">tfidf_matrix</span> <span class="o">=</span> <span class="n">tfidf_vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
        <span class="n">similar_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pdf1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pdf_list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf_list</span><span class="p">)):</span>
                <span class="n">pdf2</span> <span class="o">=</span> <span class="n">pdf_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">text1</span> <span class="o">=</span> <span class="n">extracted_texts</span><span class="p">[</span><span class="n">pdf1</span><span class="p">]</span>
                <span class="n">text2</span> <span class="o">=</span> <span class="n">extracted_texts</span><span class="p">[</span><span class="n">pdf2</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">text1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">tfidf_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tfidf_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">seq_sim</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">text1</span><span class="p">,</span> <span class="n">text2</span><span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">cos_sim</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">seq_sim</span>
                <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span><span class="p">:</span>
                    <span class="n">similar_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">,</span> <span class="n">ratio</span><span class="p">))</span>

        <span class="c1"># Only save similarity results to database if high similarity found</span>
        <span class="k">if</span> <span class="n">similar_pairs</span> <span class="ow">and</span> <span class="n">db_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">db_path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">students</span> <span class="o">=</span> <span class="n">load_database</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
                <span class="c1"># Find the student entry by Canvas ID</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">students</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Canvas ID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">student_canvas_id</span><span class="p">):</span>
                        <span class="c1"># Save the similarity results as a field</span>
                        <span class="n">s</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;Submission Similarity Results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;file1&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdf1</span><span class="p">),</span>
                                <span class="s2">&quot;file2&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdf2</span><span class="p">),</span>
                                <span class="s2">&quot;similarity&quot;</span><span class="p">:</span> <span class="n">ratio</span>
                            <span class="p">}</span>
                            <span class="k">for</span> <span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">similar_pairs</span>
                        <span class="p">]</span>
                        <span class="n">save_database</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="n">db_path</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[StudentSubmissions] Saved similarity results to database for student </span><span class="si">{</span><span class="n">student_canvas_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[StudentSubmissions] Failed to save similarity results to database: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">similar_pairs</span><span class="p">:</span>
            <span class="c1"># Compose warning message</span>
            <span class="n">assignment_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pdf1</span><span class="p">,</span> <span class="n">pdf2</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">similar_pairs</span><span class="p">:</span>
                <span class="n">a1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;assignment_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_info</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;file_path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pdf1</span><span class="p">),</span> <span class="n">pdf1</span><span class="p">)</span>
                <span class="n">a2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;assignment_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_info</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;file_path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pdf2</span><span class="p">),</span> <span class="n">pdf2</span><span class="p">)</span>
                <span class="n">assignment_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">))</span>
            <span class="n">assignment_names_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">a1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">a2</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">assignment_names</span><span class="p">])</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;H thng pht hin bn  np cc file c ni dung rt ging nhau cho nhiu bi tp khc nhau:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">assignment_names_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Vic np cc file c ni dung rt ging nhau cho nhiu bi tp khc nhau b coi l gian ln v vi phm quy nh ca lp hc. &quot;</span>
                <span class="s2">&quot;Bn cn np li tng bi tp vi ni dung ph hp cho tng bi cng sm cng tt. &quot;</span>
                <span class="s2">&quot;Nu c thc mc, hy lin h vi ging vin. </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Thng bo ny c gi t ng t h thng.&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Print message and ask user if want to send/refine/quit</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Prepared warning message to send ---&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject: </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message:</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Options: [y] Send as is  [r] Refine with AI  [q] Quit/skip&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                    <span class="s2">&quot;Send this message? (y/r/q, default y in 60s): &quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;y&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">choice</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[StudentSubmissions] Skipped sending warning message.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipped sending warning message.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
                <span class="c1"># Refine with AI</span>
                <span class="k">if</span> <span class="n">refine</span> <span class="ow">in</span> <span class="n">ALL_AI_METHODS</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Bn l tr l gio dc chuyn nghip. Hy vit li thng bo sau bng ting Vit, lch s, r rng, &quot;</span>
                        <span class="s2">&quot;gii thch rng vic np cc file c ni dung rt ging nhau cho nhiu bi tp khc nhau b coi l gian ln, &quot;</span>
                        <span class="s2">&quot;v nhc sinh vin np li tng bi tp vi ni dung ph hp. a vo danh sch cc bi b pht hin. &quot;</span>
                        <span class="s2">&quot;Ch tr v thng bo  chnh sa, khng gii thch g thm.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;Thng bo:</span><span class="se">\n</span><span class="si">{text}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">refine_text_with_ai</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span> <span class="n">user_prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Refined message ---</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">confirm</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                            <span class="s2">&quot;Send this refined message? (y/n, default y in 60s): &quot;</span><span class="p">,</span>
                            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;y&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                        <span class="n">confirm</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>
                    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Operation cancelled by user.&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="n">confirm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[StudentSubmissions] Skipped sending warning message.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipped sending warning message.&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No AI method available for refinement. Sending original message.&quot;</span><span class="p">)</span>

            <span class="c1"># Send message</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">canvas</span><span class="o">.</span><span class="n">create_conversation</span><span class="p">(</span>
                    <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">student_canvas_id</span><span class="p">)],</span>
                    <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
                    <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                    <span class="n">force_new</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[StudentSubmissions] Warning message sent to student </span><span class="si">{</span><span class="n">student_canvas_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning message sent to student.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[StudentSubmissions] Failed to send warning message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send warning message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[StudentSubmissions] No highly similar submissions detected for student </span><span class="si">{</span><span class="n">student_canvas_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No highly similar submissions detected.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="change_canvas_deadlines">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.change_canvas_deadlines">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">change_canvas_deadlines</span><span class="p">(</span>
    <span class="n">assignment_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">new_due_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="n">CANVAS_DEFAULT_ASSIGNMENT_CATEGORY</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Change deadlines for one or more Canvas assignments.</span>
<span class="sd">    - If assignment_ids is None, list assignments (optionally filtered by category) and allow interactive selection (supports ranges, comma-separated, &#39;a&#39; for all).</span>
<span class="sd">    - Ask whether to apply a single deadline to all selected assignments or specify different dates per assignment.</span>
<span class="sd">    - Prompts time out after 60 seconds and the operation quits (default).</span>
<span class="sd">    - new_due_date (if provided) should be a string in &quot;YYYY-MM-DD HH:MM&quot; or &quot;YYYY-MM-DDTHH:MM&quot; format (local time). If provided and multiple assignments selected, it will be used as the single deadline option.</span>
<span class="sd">    Returns a dict mapping assignment_id -&gt; status string.</span>
<span class="sd">    Note: this implementation assumes the local time provided by the user is in the same timezone as Canvas (no timezone conversions are performed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">_signum</span><span class="p">,</span> <span class="n">_frame</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Quitting...&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use SIGALRM when available (not on Windows)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_selection</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">parts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">parts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">parts</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_datetime_str</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># Accept &quot;YYYY-MM-DD HH:MM&quot; or &quot;YYYY-MM-DDTHH:MM&quot; or &quot;YYYY-MM-DD&quot;</span>
        <span class="c1"># Also accept trailing GMT/UTC or trailing &#39;Z&#39;. Treat inputs as GMT (UTC).</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Remove trailing &quot;GMT&quot; or &quot;UTC&quot; (case-insensitive) and normalize trailing Z</span>
        <span class="n">s_clean</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*(?:gmt|utc)$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="c1"># If ends with Z keep it (ISO)</span>
        <span class="n">try_formats</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="n">try_formats</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">s_clean</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
                <span class="c1"># Treat user-provided time as GMT (UTC) and output in Canvas-friendly Z format</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T00:00:00Z&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="c1"># Try more flexible parsing (ISO)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># fromisoformat doesn&#39;t accept trailing &#39;Z&#39;, so replace if present</span>
            <span class="n">iso_candidate</span> <span class="o">=</span> <span class="n">s_clean</span>
            <span class="k">if</span> <span class="n">iso_candidate</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">):</span>
                <span class="n">iso_candidate</span> <span class="o">=</span> <span class="n">iso_candidate</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">iso_candidate</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ChangeDeadlines] Failed to connect to Canvas: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to connect to Canvas.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="c1"># Gather assignments (filtered by category if provided)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;assignments&quot;</span><span class="p">]))</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">and</span> <span class="n">group_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
                    <span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_at&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;due_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">})</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ChangeDeadlines] Failed to list assignments: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to list assignments.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">assignments</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ChangeDeadlines] No assignments found (after applying category filter).&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No assignments found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="c1"># If assignment_ids provided, normalize to list of assignment ids (strings/ints)</span>
    <span class="n">selected_assignments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">assignment_ids</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assignment_ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="c1"># single id or comma-separated</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">assignment_ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ident</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="c1"># accept numeric id or assignment name</span>
                <span class="k">if</span> <span class="n">ident</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">ident</span><span class="p">:</span>
                            <span class="n">selected_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ident</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">selected_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assignment_ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">ident</span> <span class="ow">in</span> <span class="n">assignment_ids</span><span class="p">:</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sid</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">sid</span><span class="p">:</span>
                        <span class="n">selected_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ident</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">selected_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Interactive selection</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ChangeDeadlines] Listing assignments for selection:&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Listing assignments:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">due</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;due_at&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;No due date&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">due</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
            <span class="s2">&quot;Enter assignment numbers to change (e.g. 1,3-5 or &#39;a&#39; for all, or &#39;q&#39; to quit) [q in 60s]: &quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sel</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ChangeDeadlines] Operation cancelled due to timeout or user quit.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="n">sel_indices</span> <span class="o">=</span> <span class="n">parse_selection</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_indices</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid selection. Aborting.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sel_indices</span><span class="p">:</span>
            <span class="n">selected_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_assignments</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No assignments selected. Aborting.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="c1"># Decide single deadline or different per assignment</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">new_due_date</span><span class="p">:</span>
        <span class="c1"># If new_due_date provided via argument, confirm with user to use single deadline</span>
        <span class="n">confirmed</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Use provided date &#39;</span><span class="si">{</span><span class="n">new_due_date</span><span class="si">}</span><span class="s2">&#39; for all selected assignments? (y/n, default y in 60s): &quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;y&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">confirmed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">confirmed</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Operation cancelled.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">if</span> <span class="n">confirmed</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="s2">&quot;single&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="s2">&quot;multiple&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
            <span class="s2">&quot;Apply one deadline to all selected assignments or specify different dates for each? (one/multiple, default one) [60s]: &quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;one&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Operation cancelled.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;single&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">):</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="s2">&quot;single&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="s2">&quot;multiple&quot;</span>

    <span class="c1"># If single: determine date</span>
    <span class="n">single_iso</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
        <span class="c1"># Alert user about timezone expectation: treat input as GMT/UTC</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note: Please enter dates in GMT (UTC) timezone. Examples: &#39;2025-08-28 14:00 GMT&#39; or &#39;2025-08-28T14:00Z&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_due_date</span><span class="p">:</span>
            <span class="n">single_iso</span> <span class="o">=</span> <span class="n">normalize_datetime_str</span><span class="p">(</span><span class="n">new_due_date</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">single_iso</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse provided new_due_date: </span><span class="si">{</span><span class="n">new_due_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">date_input</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;Enter new due date/time for all selected assignments (format: YYYY-MM-DD HH:MM) [60s]: &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">date_input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Operation cancelled.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
            <span class="n">single_iso</span> <span class="o">=</span> <span class="n">normalize_datetime_str</span><span class="p">(</span><span class="n">date_input</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">single_iso</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not parse the date you entered. Aborting.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>

        <span class="c1"># Apply to each selected assignment: first clear due_at (set to None), then set to new date</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">selected_assignments</span><span class="p">:</span>
            <span class="n">aid</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Clear existing due date first</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                    <span class="c1"># attempt clear via canvasapi</span>
                    <span class="n">assignment</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">due_at</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># fallback via REST</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/assignments/</span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
                    <span class="n">payload_clear</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;assignment&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload_clear</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="c1"># Now set the new due date</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                    <span class="n">assignment</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">due_at</span><span class="o">=</span><span class="n">single_iso</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;updated (via canvasapi)&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/assignments/</span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;assignment&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="n">single_iso</span><span class="p">}}</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">):</span>
                        <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;updated (via REST)&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;failed (</span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ChangeDeadlines] Assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2"> -&gt; due_at set to </span><span class="si">{</span><span class="n">single_iso</span><span class="si">}</span><span class="s2"> (cleared first)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ChangeDeadlines] Failed to update assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="c1"># If multiple: prompt for each assignment individually</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note: Please enter dates in GMT (UTC) timezone when specifying per-assignment due dates.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">selected_assignments</span><span class="p">:</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Enter new due date for assignment &#39;</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; (ID: </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">) (format: YYYY-MM-DD HH:MM), or leave blank to skip: &quot;</span>
        <span class="n">date_input</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">date_input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Operation cancelled.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">date_input</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;skipped&quot;</span>
            <span class="k">continue</span>
        <span class="c1"># Parse user input and treat it as GMT (UTC) time.</span>
        <span class="n">iso</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">date_input</span> <span class="ow">and</span> <span class="n">date_input</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">iso</span> <span class="o">=</span> <span class="n">normalize_datetime_str</span><span class="p">(</span><span class="n">date_input</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iso</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;invalid date format&quot;</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Clear existing due date first</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">due_at</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">url_clear</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/assignments/</span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">headers_clear</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
                <span class="n">payload_clear</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;assignment&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url_clear</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers_clear</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload_clear</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="c1"># Now set the new due date</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">due_at</span><span class="o">=</span><span class="n">iso</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;updated (via canvasapi)&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/assignments/</span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;assignment&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="n">iso</span><span class="p">}}</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">):</span>
                    <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;updated (via REST)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;failed (</span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ChangeDeadlines] Assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2"> -&gt; due_at set to </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> (cleared first)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ChangeDeadlines] Failed to update assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="create_canvas_groups">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.create_canvas_groups">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_canvas_groups</span><span class="p">(</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">group_set_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">num_groups</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">group_name_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create several groups with names like &#39;Group 1&#39;, &#39;Group 2&#39;, etc., in a specified group set.</span>
<span class="sd">    If group_set_id is None, list all group sets and allow user to select one.</span>
<span class="sd">    If no group sets are available, ask user to create one.</span>
<span class="sd">    Always allow user to quit at any step.</span>
<span class="sd">    If no response from user within 60 seconds, quit.</span>
<span class="sd">    Skip creating a group if a group with the same name already exists in the group set.</span>

<span class="sd">    Args:</span>
<span class="sd">        api_url (str): Canvas API base URL.</span>
<span class="sd">        api_key (str): Canvas API key.</span>
<span class="sd">        course_id (str or int): Canvas course ID.</span>
<span class="sd">        group_set_id (str or int or None): ID of the group set to create groups in. If None, prompt user.</span>
<span class="sd">        num_groups (int): Number of groups to create (default: 5).</span>
<span class="sd">        group_name_pattern (str or None): Pattern for group names, e.g., &quot;Group {i}&quot;. If None, prompt user.</span>
<span class="sd">        verbose (bool): Print more details.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of created group dicts (from API response) or None if cancelled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">_signum</span><span class="p">,</span> <span class="n">_frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CreateGroups] Timeout: No response after 60 seconds. Quitting...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Quitting...&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use signal.SIGALRM only if available (not on Windows)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CreateGroups] Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback for platforms without SIGALRM (e.g., Windows)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Connected to Canvas course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connected to Canvas course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Step 1: Get or select group set</span>
        <span class="k">if</span> <span class="n">group_set_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group_sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_group_categories</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">group_sets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CreateGroups] No group sets found. Creating a new one...&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No group sets found. Creating a new one...&quot;</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                    <span class="s2">&quot;Enter name for new group set (or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Default Group Set&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CreateGroups] Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">group_set</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">create_group_category</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">group_set_id</span> <span class="o">=</span> <span class="n">group_set</span><span class="o">.</span><span class="n">id</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Created group set &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; with ID </span><span class="si">{</span><span class="n">group_set_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created group set &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; with ID </span><span class="si">{</span><span class="n">group_set_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CreateGroups] Available group sets:&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available group sets:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">gs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_sets</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">gs</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">gs</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">gs</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">gs</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                    <span class="s2">&quot;Select group set number (or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">sel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sel</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CreateGroups] Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_sets</span><span class="p">):</span>
                        <span class="n">group_set_id</span> <span class="o">=</span> <span class="n">group_sets</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Selected group set: </span><span class="si">{</span><span class="n">group_sets</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected group set: </span><span class="si">{</span><span class="n">group_sets</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CreateGroups] Invalid selection.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid selection.&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CreateGroups] Invalid input.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid input.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Fetch existing groups in the selected group set (handle pagination)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="n">groups_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/group_categories/</span><span class="si">{</span><span class="n">group_set_id</span><span class="si">}</span><span class="s2">/groups&quot;</span>
        <span class="n">existing_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">per_page</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Fetch up to 100 groups per page to minimize requests</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">paginated_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">groups_url</span><span class="si">}</span><span class="s2">?page=</span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">&amp;per_page=</span><span class="si">{</span><span class="n">per_page</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">paginated_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Failed to fetch page </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2"> of existing groups: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">existing_groups</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">page</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">existing_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">existing_groups</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">existing_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> existing groups in group set </span><span class="si">{</span><span class="n">group_set_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Error fetching existing groups: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error fetching existing groups.&quot;</span><span class="p">)</span>
            <span class="n">existing_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Step 2: Confirm number of groups</span>
        <span class="n">num_str</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Enter number of groups to create (default: </span><span class="si">{</span><span class="n">num_groups</span><span class="si">}</span><span class="s2">, or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">num_groups</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">num_str</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CreateGroups] Quitting.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num_groups</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">num_groups</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CreateGroups] Number of groups must be positive.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of groups must be positive.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CreateGroups] Invalid number.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid number.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Step 3: Get group name pattern</span>
        <span class="k">if</span> <span class="n">group_name_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;Enter group name pattern (e.g., &#39;Group </span><span class="si">{i}</span><span class="s2">&#39;, default: &#39;Group </span><span class="si">{i}</span><span class="s2">&#39;, or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Group </span><span class="si">{i}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pattern</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CreateGroups] Quitting.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">group_name_pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Step 4: Create groups using REST API, skipping if name exists</span>
        <span class="n">created_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skipped_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_groups</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group_name</span> <span class="ow">in</span> <span class="n">existing_names</span><span class="p">:</span>
                <span class="n">skipped_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Skipped creating group &#39;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">&#39; (already exists).&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped creating group &#39;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">&#39; (already exists).&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/group_categories/</span><span class="si">{</span><span class="n">group_set_id</span><span class="si">}</span><span class="s2">/groups&quot;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">):</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="n">created_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Created group &#39;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">&#39; in group set </span><span class="si">{</span><span class="n">group_set_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created group &#39;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Failed to create group &#39;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create group &#39;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Failed to create group &#39;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create group &#39;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Continue creating others</span>

        <span class="k">if</span> <span class="n">skipped_groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Skipped </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> groups that already exist: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">skipped_groups</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> groups that already exist.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Successfully created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">created_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> groups.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">created_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> groups.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">created_groups</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CreateGroups] Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="change_canvas_lock_dates">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.change_canvas_lock_dates">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">change_canvas_lock_dates</span><span class="p">(</span>
    <span class="n">assignment_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">new_lock_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="n">CANVAS_DEFAULT_ASSIGNMENT_CATEGORY</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Change lock dates (lock_at) for one or more Canvas assignments.</span>
<span class="sd">    - If assignment_ids is None, list assignments (optionally filtered by category) and allow interactive selection (supports ranges, comma-separated, &#39;a&#39; for all).</span>
<span class="sd">    - If new_lock_date is provided, use it as the single lock date for all selected assignments.</span>
<span class="sd">    - If new_lock_date is None, prompt the user for a date; if no response within 60 seconds, default to the assignment&#39;s due_at + 4 days (if due_at exists).</span>
<span class="sd">    - Supports setting a single date for all or different dates per assignment.</span>
<span class="sd">    - Prompts time out after 60 seconds and the operation quits (default).</span>
<span class="sd">    - If verbose is True, print more details; otherwise, print only important notice.</span>
<span class="sd">    Returns a dict mapping assignment_id -&gt; status string.</span>
<span class="sd">    Note: this implementation assumes the local time provided by the user is in the same timezone as Canvas (no timezone conversions are performed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">_signum</span><span class="p">,</span> <span class="n">_frame</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Quitting...&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use signal.SIGALRM only if available (not on Windows)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_selection</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">parts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">parts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">parts</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_datetime_str</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># Accept &quot;YYYY-MM-DD HH:MM&quot; or &quot;YYYY-MM-DDTHH:MM&quot; or &quot;YYYY-MM-DD&quot;</span>
        <span class="c1"># Also accept trailing GMT/UTC or trailing &#39;Z&#39;. Treat inputs as GMT (UTC).</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Remove trailing &quot;GMT&quot; or &quot;UTC&quot; (case-insensitive) and normalize trailing Z</span>
        <span class="n">s_clean</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*(?:gmt|utc)$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="c1"># If ends with Z keep it (ISO)</span>
        <span class="n">try_formats</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="n">try_formats</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">s_clean</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
                <span class="c1"># Treat user-provided time as GMT (UTC) and output in Canvas-friendly Z format</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T00:00:00Z&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="c1"># Try more flexible parsing (ISO)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># fromisoformat doesn&#39;t accept trailing &#39;Z&#39;, so replace if present</span>
            <span class="n">iso_candidate</span> <span class="o">=</span> <span class="n">s_clean</span>
            <span class="k">if</span> <span class="n">iso_candidate</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">):</span>
                <span class="n">iso_candidate</span> <span class="o">=</span> <span class="n">iso_candidate</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">iso_candidate</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ChangeLock] Failed to connect to Canvas: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to connect to Canvas.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="c1"># Gather assignments (filtered by category if provided)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignment_groups</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;assignments&quot;</span><span class="p">]))</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">and</span> <span class="n">group_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
                    <span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;due_at&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;due_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">})</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ChangeLock] Failed to list assignments: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to list assignments.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">assignments</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ChangeLock] No assignments found (after applying category filter).&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No assignments found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="c1"># If assignment_ids provided, normalize to list of assignment ids (strings/ints)</span>
    <span class="n">selected_assignments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">assignment_ids</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assignment_ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="c1"># single id or comma-separated</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">assignment_ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ident</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="c1"># accept numeric id or assignment name</span>
                <span class="k">if</span> <span class="n">ident</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">ident</span><span class="p">:</span>
                            <span class="n">selected_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ident</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">selected_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assignment_ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">ident</span> <span class="ow">in</span> <span class="n">assignment_ids</span><span class="p">:</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sid</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">sid</span><span class="p">:</span>
                        <span class="n">selected_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ident</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">selected_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Interactive selection</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ChangeLock] Listing assignments for selection:&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Listing assignments:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">due</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;due_at&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;No due date&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Due: </span><span class="si">{</span><span class="n">due</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
            <span class="s2">&quot;Enter assignment numbers to change (e.g. 1,3-5 or &#39;a&#39; for all, or &#39;q&#39; to quit) [q in 60s]: &quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sel</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ChangeLock] Operation cancelled due to timeout or user quit.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="n">sel_indices</span> <span class="o">=</span> <span class="n">parse_selection</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_indices</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid selection. Aborting.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sel_indices</span><span class="p">:</span>
            <span class="n">selected_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_assignments</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No assignments selected. Aborting.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="c1"># Decide single lock date or different per assignment</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">new_lock_date</span><span class="p">:</span>
        <span class="c1"># If new_lock_date provided via argument, confirm with user to use single lock date</span>
        <span class="n">confirmed</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Use provided date &#39;</span><span class="si">{</span><span class="n">new_lock_date</span><span class="si">}</span><span class="s2">&#39; for all selected assignments? (y/n, default y in 60s): &quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;y&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">confirmed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">confirmed</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Operation cancelled.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">if</span> <span class="n">confirmed</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="s2">&quot;single&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="s2">&quot;multiple&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
            <span class="s2">&quot;Apply one lock date to all selected assignments or specify different dates for each? (one/multiple, default one) [60s]: &quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;one&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Operation cancelled.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;single&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">):</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="s2">&quot;single&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="s2">&quot;multiple&quot;</span>

    <span class="c1"># If single: determine date</span>
    <span class="n">single_iso</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
        <span class="c1"># Alert user about timezone expectation: treat input as GMT/UTC</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note: Please enter dates in GMT (UTC) timezone. Examples: &#39;2025-08-28 14:00 GMT&#39; or &#39;2025-08-28T14:00Z&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_lock_date</span><span class="p">:</span>
            <span class="n">single_iso</span> <span class="o">=</span> <span class="n">normalize_datetime_str</span><span class="p">(</span><span class="n">new_lock_date</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">single_iso</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse provided new_lock_date: </span><span class="si">{</span><span class="n">new_lock_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">date_input</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;Enter new lock date/time for all selected assignments (format: YYYY-MM-DD HH:MM) [60s]: &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">date_input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Operation cancelled.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
            <span class="n">single_iso</span> <span class="o">=</span> <span class="n">normalize_datetime_str</span><span class="p">(</span><span class="n">date_input</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">single_iso</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not parse the date you entered. Aborting.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>

        <span class="c1"># Apply to each selected assignment: set lock_at to the date</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">selected_assignments</span><span class="p">:</span>
            <span class="n">aid</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Set the new lock date</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                    <span class="n">assignment</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">lock_at</span><span class="o">=</span><span class="n">single_iso</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;updated (via canvasapi)&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/assignments/</span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;assignment&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lock_at&quot;</span><span class="p">:</span> <span class="n">single_iso</span><span class="p">}}</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">):</span>
                        <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;updated (via REST)&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;failed (</span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ChangeLock] Assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2"> -&gt; lock_at set to </span><span class="si">{</span><span class="n">single_iso</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ChangeLock] Failed to update assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="c1"># If multiple: prompt for each assignment individually</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note: Please enter dates in GMT (UTC) timezone when specifying per-assignment lock dates.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">selected_assignments</span><span class="p">:</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">due_at</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;due_at&quot;</span><span class="p">]</span>
        <span class="n">default_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">due_at</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">due_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">due_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                <span class="n">default_dt</span> <span class="o">=</span> <span class="n">due_dt</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">default_date</span> <span class="o">=</span> <span class="n">default_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Enter new lock date for assignment &#39;</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; (ID: </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">) (format: YYYY-MM-DD HH:MM), or leave blank to use default (due_at + 4 days: </span><span class="si">{</span><span class="n">default_date</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="s2">) [60s]: &quot;</span>
        <span class="n">date_input</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">date_input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Operation cancelled.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">date_input</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">default_date</span><span class="p">:</span>
                <span class="n">iso</span> <span class="o">=</span> <span class="n">default_date</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;skipped (no due_at to calculate default)&quot;</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Parse user input and treat it as GMT (UTC) time.</span>
            <span class="n">iso</span> <span class="o">=</span> <span class="n">normalize_datetime_str</span><span class="p">(</span><span class="n">date_input</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">iso</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;invalid date format&quot;</span>
                <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set the new lock date</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">assignment</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">lock_at</span><span class="o">=</span><span class="n">iso</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;updated (via canvasapi)&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/courses/</span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">/assignments/</span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;assignment&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lock_at&quot;</span><span class="p">:</span> <span class="n">iso</span><span class="p">}}</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">):</span>
                    <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;updated (via REST)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;failed (</span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ChangeLock] Assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2"> -&gt; lock_at set to </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aid</span><span class="p">)]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ChangeLock] Failed to update assignment </span><span class="si">{</span><span class="n">aid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="delete_empty_canvas_groups">
<a class="viewcode-back" href="../../api.html#course_hoanganhduc.canvas.delete_empty_canvas_groups">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_empty_canvas_groups</span><span class="p">(</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">CANVAS_LMS_API_URL</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">CANVAS_LMS_API_KEY</span><span class="p">,</span>
    <span class="n">course_id</span><span class="o">=</span><span class="n">CANVAS_LMS_COURSE_ID</span><span class="p">,</span>
    <span class="n">group_set_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete all empty groups (groups with no members) from a Canvas course group set.</span>
<span class="sd">    If group_set_id is None, list all group sets and allow user to select one.</span>
<span class="sd">    Always allow user to quit at any step.</span>
<span class="sd">    If no response from user within 60 seconds, quit.</span>

<span class="sd">    Args:</span>
<span class="sd">        api_url (str): Canvas API base URL.</span>
<span class="sd">        api_key (str): Canvas API key.</span>
<span class="sd">        course_id (str or int): Canvas course ID.</span>
<span class="sd">        group_set_id (str or int or None): ID of the group set to delete empty groups from. If None, prompt user.</span>
<span class="sd">        verbose (bool): Print more details.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Number of empty groups deleted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">_signum</span><span class="p">,</span> <span class="n">_frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[DeleteGroups] Timeout: No response after 60 seconds. Quitting...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout: No response after 60 seconds. Quitting...&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;User input timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use signal.SIGALRM only if available (not on Windows)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGALRM&quot;</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[DeleteGroups] Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback for platforms without SIGALRM (e.g., Windows)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Connected to Canvas course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connected to Canvas course </span><span class="si">{</span><span class="n">course_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Step 1: Get or select group set</span>
        <span class="k">if</span> <span class="n">group_set_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group_sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">get_group_categories</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">group_sets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DeleteGroups] No group sets found in this course.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No group sets found in this course.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DeleteGroups] Available group sets:&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available group sets:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">gs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_sets</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">gs</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">gs</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">gs</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">gs</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;Select group set number (or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;q&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sel</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DeleteGroups] Quitting.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_sets</span><span class="p">):</span>
                    <span class="n">group_set_id</span> <span class="o">=</span> <span class="n">group_sets</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Selected group set: </span><span class="si">{</span><span class="n">group_sets</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected group set: </span><span class="si">{</span><span class="n">group_sets</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DeleteGroups] Invalid selection.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid selection.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mi">0</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DeleteGroups] Invalid input.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid input.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># Fetch all groups in the selected group set (handle pagination)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="n">groups_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/group_categories/</span><span class="si">{</span><span class="n">group_set_id</span><span class="si">}</span><span class="s2">/groups&quot;</span>
        <span class="n">all_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">per_page</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">paginated_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">groups_url</span><span class="si">}</span><span class="s2">?page=</span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">&amp;per_page=</span><span class="si">{</span><span class="n">per_page</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">paginated_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Failed to fetch page </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2"> of groups: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">all_groups</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">page</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> groups in group set </span><span class="si">{</span><span class="n">group_set_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Error fetching groups: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error fetching groups.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># Find empty groups (no members)</span>
        <span class="n">empty_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">all_groups</span><span class="p">:</span>
            <span class="n">group_id</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">members_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/groups/</span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">/users&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">members_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">members_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">members_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">members</span> <span class="o">=</span> <span class="n">members_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">members</span><span class="p">:</span>
                        <span class="n">empty_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Error fetching members for group </span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DeleteGroups] No empty groups found.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No empty groups found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">empty_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> empty groups:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">empty_groups</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups]   - </span><span class="si">{</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">empty_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> empty groups:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">empty_groups</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Confirm deletion</span>
        <span class="n">confirm</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Delete all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">empty_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> empty groups? (y/n, default &#39;n&#39; in 60s): &quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;n&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">confirm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DeleteGroups] Deletion cancelled.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deletion cancelled.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># Delete empty groups using REST API</span>
        <span class="n">deleted_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">empty_groups</span><span class="p">:</span>
            <span class="n">group_id</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">delete_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/groups/</span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">204</span><span class="p">):</span>
                    <span class="n">deleted_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Deleted group &#39;</span><span class="si">{</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; (ID: </span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted group &#39;</span><span class="si">{</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Failed to delete group &#39;</span><span class="si">{</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete group &#39;</span><span class="si">{</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Failed to delete group &#39;</span><span class="si">{</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete group &#39;</span><span class="si">{</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Successfully deleted </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> empty groups.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully deleted </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> empty groups.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deleted_count</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DeleteGroups] Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Course Management Toolkit</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2026, Duc A. Hoang.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>